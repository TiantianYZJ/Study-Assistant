# å­¦ç¿¼ - æ™ºèƒ½åŒ–å­¦ä¹ ä»»åŠ¡ç®¡ç†å·¥å…·
# Copyright (C) 2025  TiantianYZJ
# 
# å£°æ˜ï¼š
# æœ¬ç¨‹åºéµå¾ªGPLv3åè®®ï¼šæ‚¨å¯ä»¥åœ¨éµå®ˆè®¸å¯è¯æ¡æ¬¾çš„å‰æä¸‹è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘ã€‚
# å®Œæ•´æˆæƒæ¡æ¬¾è¯·å‚è§é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„LICENSEæ–‡ä»¶ã€‚

# æ›´æ–°æ—¥å¿—
Version = "V1.1.1"
CHANGELOG = [
    "V0.0.1-2024.01.19 1ã€â€œå­¦ç¿¼â€æ­£å¼è¯ç”Ÿï¼Œå…·å¤‡ä»£åŠç®¡ç†åŠŸèƒ½",
    "V0.0.2-2024.01.19 1ã€æ·»åŠ ã€ä»»åŠ¡è¿›åº¦æŠ¥å‘Šã€‘ï¼Œç”Ÿæˆé¥¼å›¾æ˜¾ç¤ºä»»åŠ¡å®Œæˆæƒ…å†µ",
    "V0.0.3-2024.01.19 1ã€ç”¨æˆ·ç¾¤ä½“ç»†åˆ†ï¼ŒåŒ…è£…ä¸ºä»»åŠ¡ç®¡ç†è½¯ä»¶ï¼›2ã€å»ºç«‹æ•°æ®åº“ï¼Œå®ç°é‡è¿›æ•°æ®ä¸å—å½±å“ï¼›3ã€å®Œæˆæƒ…å†µä½¿ç”¨æ–‡å­—ï¼ˆå·²å®Œæˆã€æœªå®Œæˆï¼‰",
    "V0.1.0-2024.01.19 1ã€UIç•Œé¢ç„•æ–°ï¼Œæ›´åŠ ç°ä»£åŒ–ï¼›2ã€ä¸»çª—å£é¡¶éƒ¨å¢åŠ æ—¶é—´æ˜¾ç¤ºï¼›3ã€æ·»åŠ æ·±è‰²æ¨¡å¼ï¼Œè‡ªåŠ¨æ ¹æ®æ—¶é—´åˆ‡æ¢",
    "V0.1.1-2024.01.19 1ã€æ¥å…¥WindowsMessage APIï¼Œå®ç°æ¶ˆæ¯ç³»ç»Ÿå±‚çº§æ¨é€",
    "V0.1.2-2024.01.20 1ã€å¢åŠ ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡ï¼Œå®ç°åå°é©»ç•™ï¼›2ã€å®Œæˆæƒ…å†µæ”¹ç”¨å›¾æ ‡",
    "V0.1.4-2024.01.20 1ã€å¢åŠ çª—å£ç½®é¡¶é€‰é¡¹ï¼›2ã€æ–°å¢ã€è®¾ç½®ã€‘ï¼Œå¯æ‰‹åŠ¨é€‰æ‹©ä¸»é¢˜ã€é…ç½®å¼€æœºè‡ªå¯åŠ¨",
    "V0.2.0-2024.01.21 1ã€é¡µé¢å¸ƒå±€é‡æ–°æ’ç‰ˆï¼Œå„åŠŸèƒ½åŒºå—ç•Œçº¿æ›´æ˜æ˜¾ï¼›2ã€ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ å›¾æ ‡ï¼›3ã€ä¸°å¯Œç³»ç»Ÿæ‰˜ç›˜å³é”®èœå•",
    "V0.2.1-2024.01.21 1ã€é€‚é…å¼€å‘ç¯å¢ƒä¸å°è£…ç¯å¢ƒï¼Œè§£å†³æ‰“åŒ….exeåæ— æ³•è°ƒç”¨å¤–éƒ¨èµ„æºçš„é—®é¢˜",
    "V0.2.2-2024.01.22 1ã€ä¼˜åŒ–ã€ç»Ÿè®¡æŠ¥å‘Šã€‘ï¼Œæ•°æ®æ›´ä¸°å¯Œã€æ›´ç›´è§‚ï¼›2ã€æ·»åŠ ã€å…³äºç¨‹åºã€‘é¡µé¢ï¼›3ã€å¼€æœºè‡ªå¯åŠ¨æ”¯æŒä¸€é”®é…ç½®",
    "V0.2.3-2024.01.23 1ã€æ›´æ¢WindowsMessage APIåº“ï¼Œè§£å†³å…¼å®¹æ€§é—®é¢˜",
    "V0.2.4-2024.02.11 1ã€å¢åŠ ã€AIæ™ºç­”ã€‘åŠŸèƒ½ï¼Œæ¥å…¥DeepseekAPIï¼Œæ”¯æŒå•æ¬¡è¯¢é—®ã€è‡ªå®šä¹‰API Keyç­‰åŠŸèƒ½",
    "V0.2.5-2024.02.12 1ã€å®ç°å¯¹AImarkdownæ ¼å¼å›ç­”çš„æ¸²æŸ“",
    "V0.2.6-2024.02.14 1ã€æ–°å¢ã€æ›´æ–°æ—¥å¿—ã€‘ï¼›2ã€ä¼˜åŒ–APIè®¾ç½®ç•Œé¢å¸ƒå±€",
    "V0.2.7-2024.02.14 1ã€å¢åŠ å¯åŠ¨æ¬¢è¿æç¤ºï¼ŒåŒæ—¶æé†’å¾…å®Œæˆä»»åŠ¡é¡¹",
    "V0.2.8-2024.02.15 1ã€ã€AIè®¾ç½®ã€‘æ·»åŠ ã€ç§æœ‰APIé…ç½®æ•™ç¨‹ã€‘ï¼›2ã€ã€AIæ™ºç­”ã€‘æ”¯æŒé€‰æ‹©æœåŠ¡æä¾›å•†",
    "V0.2.9-2024.02.15 1ã€ã€å­¦ä¹ æ•°æ®ç»Ÿè®¡ã€‘ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒæƒ…å†µç»†åˆ†ï¼Œæ›´åŠ ä¸°å¯Œç›´è§‚ï¼›2ã€å¯åŠ¨æ¬¢è¿æç¤ºå¢åŠ å³å°†æˆªæ­¢ã€å·²æˆªæ­¢ä»»åŠ¡æé†’",
    "V0.3.0-2024.02.15 1ã€HTMLæ¸²æŸ“é¡µé¢å…¨é¢é€‚é…æ·±è‰²æ¨¡å¼",
    "V0.3.1-2024.02.15 1ã€ã€AIæ™ºç­”ã€‘æ”¯æŒè®¾ç½®å›ç­”æ˜¾ç¤ºæ–¹å¼ï¼›2ã€ã€APIé…ç½®æ•™ç¨‹ã€‘æ”¹ä¸ºç”¨æµè§ˆå™¨æ‰“å¼€ï¼Œæ›´ç¾è§‚",
    "V0.3.2-2024.02.15 1ã€ã€APIé…ç½®æ•™ç¨‹ã€‘æ›´æ¢æ¸²æŸ“é£æ ¼ï¼Œå“åº”å¼å¸ƒå±€",
    "V0.3.3-2024.02.16 1ã€æ‰˜ç›˜å³é”®èœå•ä¼˜åŒ–ï¼Œæ–°å¢ã€ç»Ÿè®¡æŠ¥å‘Šã€‘é€‰é¡¹",
    "V1.0.0-2024.02.16 1ã€â€œå­¦ç¿¼â€1.0.0æ­£å¼ç‰ˆå‘å¸ƒï¼æ¬¢è¿ä½“éªŒäº¤æµ",
    "V1.0.1-2024.02.16 1ã€ä¼˜åŒ–éƒ¨åˆ†çª—å£å°ºå¯¸ï¼›2ã€ä¼˜åŒ–é€šçŸ¥æç¤ºï¼›3ã€ä¿®å¤äº†ä¸€äº›å·²çŸ¥BUG",
    "V1.0.2-2024.02.16 1ã€ä¿®å¤äº†ä¸€äº›å·²çŸ¥BUG",
    "V1.0.3-2024.02.16 1ã€æ›´æ¢é«˜æ¸…å›¾æ ‡",
    "V1.0.4-2024.02.20 1ã€ä¼˜åŒ–ã€æ¸…ç©ºã€‘ä»£ç é€»è¾‘ï¼›2ã€æ­£å¼ç¡®å®šåº”ç”¨åï¼šä¸­æ–‡â€œå­¦ç¿¼â€ï¼Œè‹±æ–‡â€œTaskWingâ€",
    "V1.0.5-2024.02.22 1ã€æ–°å¢ã€ä¸“æ³¨ã€‘ï¼Œè®¡å…¥ç»Ÿè®¡æŠ¥å‘Šï¼ŒåŠ©åŠ›é«˜æ•ˆå­¦ä¹ ï¼›2ã€é‡è¦æŒ‰é’®å¢åŠ æ‚¬åœæç¤ºï¼›3ã€ã€è®¾ç½®ã€‘æ–°å¢ã€åˆ é™¤æ‰€æœ‰æ•°æ®ã€‘ï¼Œå¹¶ä¼˜åŒ–æ“ä½œé€»è¾‘",
    "V1.0.6-2024.02.22 1ã€å› Deepseekå…³é—­å……å€¼å…¥å£ï¼Œã€AIæ™ºç­”ã€‘æš‚åœæä¾›è¯¥æ¸ é“å…±äº«APIï¼Œè¯¥æ¸ é“ç§æœ‰APIä¸å—å½±å“ï¼›2ã€ä¼˜åŒ–ã€ä¸“æ³¨ã€‘ï¼›3ã€ä¼˜åŒ–ã€è®¾ç½®ã€‘",
    "V1.0.7-2024.02.22 1ã€ä¼˜åŒ–æŒ‰é’®åç§°ï¼›2ã€ä¸»é¡µé¢å­—ä½“è°ƒæ•´ï¼Œæ›´æ˜¾çœ¼ï¼›3ã€ã€ç»Ÿè®¡æŠ¥å‘Šã€‘ä¼˜åŒ–æ•°æ®ç»Ÿè®¡é€»è¾‘ï¼›4ã€æ¥å…¥æ—¥æœŸé€‰æ‹©å™¨æ§ä»¶ï¼Œé€‰æ‹©æ—¥æœŸæ›´ç›´è§‚",
    "V1.0.8-2024.02.23 1ã€ä¸»é¢˜æ¨¡å¼æ–°å¢ã€è·Ÿéšç³»ç»Ÿã€‘ï¼›2ã€æµè§ˆå™¨æ˜¾ç¤ºå›ç­”æ”¯æŒå¤æ‚æ•°å­¦å…¬å¼ï¼›3ã€ã€ä¸“æ³¨ã€‘æ–°å¢éŸ³é‡è°ƒèŠ‚ï¼›4ã€ã€ç»Ÿè®¡æŠ¥å‘Šã€‘ä¼˜åŒ–é˜²æº¢å‡º",
    "V1.0.9-2024.02.28 1ã€æ–°å¢æ›´æ–°æ£€æµ‹ï¼Œä»æ­¤æ›´æ–°æ›´æ–¹ä¾¿ï¼›2ã€é‡æ–°è®¾è®¡å…³äºé¡µé¢ï¼›3ã€å–æ¶ˆæ‚¬æµ®æç¤ºæ¡†çš„æ¸æ˜¾æ¸éšæ•ˆæœï¼Œæœç»äº†é—ªçƒBUG",
    "V1.1.0-2024.03.02 1ã€æ¢å¤é»˜è®¤APIï¼›2ã€ä»»åŠ¡åˆ—è¡¨æ”¯æŒåŒå‡»å’Œå³é”®æ“ä½œï¼›3ã€ä¼˜åŒ–ã€AIæ™ºç­”ã€‘ã€ã€å…³äºã€‘ï¼›4ã€æ·»åŠ ã€é€šçŸ¥ç®¡ç†ã€‘ï¼›5ã€æ”¯æŒæ˜¾ç¤ºAIæ€è€ƒå†…å®¹ï¼›6ã€ã€AIæ™ºç­”ã€‘æ”¯æŒæ·»åŠ é™„ä»¶",
    "V1.1.1-2024.03.08 1ã€ä¿®å¤ã€AIæ™ºç­”ã€‘é™„ä»¶è§£æbugï¼›2ã€æ£€æµ‹æ›´æ–°æ—¶æ˜¾ç¤ºæ›´æ–°æ—¶é—´ï¼›3ã€æµè§ˆå™¨ç«¯AIå›ç­”é€‚é…æ›´å¤šæ•°å­¦å…¬å¼",
]

import random
import threading
import tkinter as tk
from tkinter import simpledialog
from tkinter import filedialog
import tkinter.font as tkFont
from tkinter import ttk, messagebox
import sqlite3
import webbrowser
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
from datetime import datetime
from time import *
import locale
import sys
import importlib
import os
import pystray
from PIL import Image, ImageTk
from pathlib import Path
import winshell
from win10toast import ToastNotifier
from openai import OpenAI
from tkhtmlview import HTMLLabel
import mistune
import requests
from flask import Flask, render_template
import pygame  
from datetime import timedelta
from tkcalendar import Calendar
import darkdetect
from pycaw.pycaw import AudioUtilities, IAudioEndpointVolume
from ctypes import cast, POINTER
from comtypes import CLSCTX_ALL
from docx import Document
from win32com.client import Dispatch

# éŸ³é¢‘ç®¡ç†é…ç½®
def get_current_volume():
    devices = AudioUtilities.GetSpeakers()
    interface = devices.Activate(
        IAudioEndpointVolume._iid_, CLSCTX_ALL, None)
    volume = cast(interface, POINTER(IAudioEndpointVolume))
    return round(volume.GetMasterVolumeLevelScalar() * 100)

def set_system_volume(value):
    devices = AudioUtilities.GetSpeakers()
    interface = devices.Activate(
        IAudioEndpointVolume._iid_, CLSCTX_ALL, None)
    volume = cast(interface, POINTER(IAudioEndpointVolume))
    volume.SetMasterVolumeLevelScalar(int(float(value))/100, None)

# Flaské…ç½®
flask_app = Flask(__name__, template_folder='templates', static_folder='static')
flask_app.config['TEMPLATES_AUTO_RELOAD'] = True
current_response_html = ""
users_question = ""

# æ·»åŠ Flaskè·¯ç”±
@flask_app.route('/ai-response')
def show_ai_response():
    return render_template('ai_response.html',
                         user_question=users_question,
                         ai_response=current_response_html,
                         bg_color=judge_theme(1),
                         text_color=judge_theme(2))

@flask_app.route('/tutorial')
def show_tutorial():
    return render_template(
        'tutorial.html',
        bg_color=judge_theme(1),
        text_color=judge_theme(2)
    )

def run_flask_server():
    flask_app.run(port=5000, use_reloader=False)

# åˆ¤æ–­æ—¶é—´æ®µ
clock = int(strftime("%H"))
def judge_time():
    if (clock >= 0 and clock <= 4):
        timenow = "æ™šä¸Š"
    elif (clock >= 5 and clock <= 9):
        timenow = "æ—©ä¸Š"
    elif (clock >= 10 and clock <= 11):
        timenow = "ä¸Šåˆ"
    elif (clock >= 12 and clock <= 14):
        timenow = "ä¸­åˆ"
    elif (clock >= 15 and clock <= 17):
        timenow = "ä¸‹åˆ"
    elif (clock >= 18 and clock <= 24):
        timenow = "æ™šä¸Š"
    
    return timenow

# å®šä¹‰èµ„æºè·¯å¾„å‡½æ•°
def resource_path(relative_path):
    try:
        # PyInstalleræ‰“åŒ…åçš„ä¸´æ—¶ç›®å½•
        base_path = sys._MEIPASS
    except AttributeError:
        # å¼€å‘ç¯å¢ƒä¸‹çš„å½“å‰ç›®å½•
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)

# WindowsMessage API
icon_path = os.path.abspath(resource_path("LOGO.ico"))
def sent_notice(t,m):
    c.execute("SELECT enable_notifications FROM notice_settings")
    if c.fetchone()[0]:
        toaster = ToastNotifier()
        toaster.show_toast(
            title=t,
            msg=m,
            icon_path=icon_path,
            duration=1,
            threaded=True
        )

        return 0

# åˆ‡æ¢çª—å£ç½®é¡¶çŠ¶æ€
def toggle_topmost():
    is_topmost = topmost_var.get()
    root.attributes('-topmost', is_topmost)

# è®¾ç½®é»˜è®¤ç¼–ç ä¸º utf-8
locale.setlocale(locale.LC_CTYPE, 'zh_CN.UTF-8')
importlib.reload(sys)

# è·å–ç”¨æˆ·æ•°æ®ç›®å½•
user_data_dir = Path(os.getenv('APPDATA')) / "TaskWing"
user_data_dir.mkdir(exist_ok=True)

# ä¿®æ”¹æ•°æ®åº“è¿æ¥è·¯å¾„
db_path = user_data_dir / "TaskWing_data.db"
conn = sqlite3.connect(str(db_path))
c = conn.cursor()

# åˆ›å»ºä»»åŠ¡è¡¨
c.execute('''CREATE TABLE IF NOT EXISTS tasks (
             id INTEGER PRIMARY KEY AUTOINCREMENT,
             name TEXT NOT NULL,
             due_date TEXT,
             rest_days INTEGER,
             completed TEXT NOT NULL DEFAULT ' ')''')
c.execute("SELECT * FROM tasks")
tasks = c.fetchall()
conn.commit()

# åˆ›å»ºä»»åŠ¡è®¡æ•°å™¨è¡¨
c.execute('''CREATE TABLE IF NOT EXISTS task_counter (
             total_tasks INTEGER DEFAULT 0)''')
conn.commit()

# åˆå§‹åŒ–è®¡æ•°å™¨
c.execute("SELECT COUNT(*) FROM task_counter")
if c.fetchone()[0] == 0:
    c.execute("INSERT INTO task_counter (total_tasks) VALUES (0)")
c.execute("SELECT * FROM task_counter")
task_counter = c.fetchall()
conn.commit()

# ä¸»é¢˜è®¾ç½®
c.execute('''CREATE TABLE IF NOT EXISTS theme_settings (
             id INTEGER PRIMARY KEY AUTOINCREMENT,
             theme_choice TEXT NOT NULL)''')
c.execute("SELECT * FROM theme_settings")
theme_settings = c.fetchall()
conn.commit()

# AIé…ç½®
c.execute('''CREATE TABLE IF NOT EXISTS ai_settings (
             api_key TEXT,
             default_model TEXT,
             provider TEXT,
             display_mode TEXT)''')
# æ›´æ–°åˆå§‹åŒ–æ•°æ®
c.execute("SELECT COUNT(*) FROM ai_settings")
if c.fetchone()[0] == 0:
    c.execute("INSERT INTO ai_settings (api_key, default_model, provider, display_mode) VALUES ('', 'deepseek-chat', 'Deepseek', 'window')")
ai_settings = c.fetchall()
conn.commit()

c.execute('''CREATE TABLE IF NOT EXISTS notice_settings (
             enable_notifications INTEGER DEFAULT 1,
             check_updates INTEGER DEFAULT 1)''')
# æ›´æ–°åˆå§‹åŒ–æ•°æ®
c.execute("SELECT COUNT(*) FROM notice_settings")
if c.fetchone()[0] == 0:
    c.execute("INSERT INTO notice_settings (enable_notifications, check_updates) VALUES (1, 1)")
notice_settings = c.fetchall()
conn.commit()

# åœ¨æ•°æ®åº“åˆ›å»ºéƒ¨åˆ†æ–°å¢ç•ªèŒ„é’Ÿè®°å½•è¡¨
c.execute('''CREATE TABLE IF NOT EXISTS pomodoro_records (
             total_sessions INTEGER DEFAULT 0,
             total_minutes INTEGER DEFAULT 0)''')
c.execute("SELECT COUNT(*) FROM pomodoro_records")
if c.fetchone()[0] == 0:
    c.execute("INSERT INTO pomodoro_records (total_sessions, total_minutes) VALUES (0, 0)")
pomodoro_records = c.fetchall() 
conn.commit()

c.execute('''CREATE TABLE IF NOT EXISTS api_usage
             (date TEXT PRIMARY KEY, count INTEGER)''')
conn.commit()

# æ£€æŸ¥è¯»å–çš„æ•°æ®
print(tasks, task_counter, theme_settings, notice_settings, ai_settings, pomodoro_records)

# è·å–ä»»åŠ¡æ€»é‡ã€å·²å®Œæˆæ•°é‡å’Œå¾…å®Œæˆæ•°é‡
def get_num(mode):
    conn.commit()
    c.execute("SELECT COUNT(*) FROM tasks")
    total_tasks = c.fetchone()[0]
    c.execute("SELECT COUNT(*) FROM tasks WHERE completed='âœ…'")
    completed_tasks = c.fetchone()[0]
    if(mode == 1):
        return total_tasks
    elif(mode == 2):
        return completed_tasks
    elif(mode == 3):
        return total_tasks - completed_tasks

c.execute("SELECT rest_days, completed FROM tasks")
all_tasks = c.fetchall()

completed = 0
pending = 0
upcoming = 0
expired = 0

for task in all_tasks:
    rest_days, completed_status = task[0], task[1]
    if completed_status == 'âœ…':
        pass
    else:
        if rest_days > 1:
            pass
        elif rest_days >= 0:
            upcoming += 1
        else:
            expired += 1
if (get_num(1) == 0):
    sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æ²¡æœ‰ä»»åŠ¡å“¦ï¼Œå¿«å»æ·»åŠ å§ï¼")
else:
    if (get_num(3) > 0):
        if (upcoming > 0 and expired > 0):
            sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æœ‰{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆï¼Œå…¶ä¸­{expired}ä¸ªå·²æˆªæ­¢ï¼Œ{upcoming}ä¸ªå³å°†åˆ°æœŸï¼")
        elif (expired > 0):
            sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æœ‰{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆï¼Œå…¶ä¸­{expired}ä¸ªå·²æˆªæ­¢!")
        elif (upcoming > 0):
            sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æœ‰{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆï¼Œå…¶ä¸­{upcoming}ä¸ªå³å°†åˆ°æœŸï¼")
        else:
            sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æœ‰{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆ")
    elif (get_num(3) == 0):
        sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æ²¡æœ‰å¾…å®Œæˆçš„ä»»åŠ¡")

# ä¸»çª—å£
root = tk.Tk()
root.title("å­¦ç¿¼ - æ‚¨çš„ä¸€ç«™å¼æ™ºèƒ½åŒ–å­¦ä¹ å¹³å°")
width = 1000
height = 600
root.geometry(f"{width}x{height}")

# åˆ›å»ºä¸€ä¸ªFrameä½œä¸ºå®¹å™¨
frame = tk.Frame(root)
frame.grid(row=0, column=1, sticky="nsew")

# è®¾ç½®ç½‘æ ¼çš„è¡Œå’Œåˆ—æƒé‡
root.grid_rowconfigure(0, weight=1)
root.grid_columnconfigure(0, weight=1)

# åˆ›å»ºå¹¶å¯åŠ¨Flaskçº¿ç¨‹
flask_thread = threading.Thread(target=run_flask_server, daemon=True)
flask_thread.start()

# è®¾ç½®çª—å£å›¾æ ‡
def set_icon():
    icon_image = Image.open(resource_path('LOGO.png'))
    icon_photo = ImageTk.PhotoImage(icon_image)
    root.iconphoto(True, icon_photo)
set_icon()

default_font = tkFont.nametofont("TkDefaultFont")

# åŠ è½½ä¸»é¢˜æ–‡ä»¶
azure_tcl_path = resource_path("azure.tcl")
root.tk.call("source", azure_tcl_path)

# æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ä¸»é¢˜è®¾ç½®
c.execute("SELECT * FROM theme_settings")
theme_settings = c.fetchone()

# å¦‚æœæ²¡æœ‰ä¸»é¢˜è®¾ç½®ï¼Œæ’å…¥é»˜è®¤å€¼
if not theme_settings:
    c.execute("INSERT INTO theme_settings (theme_choice) VALUES ('è·Ÿéšç³»ç»Ÿ')")
    conn.commit()

# ä¸»é¢˜é€‚é…åˆ¤æ–­
def judge_theme(mode):
    global theme
    if theme == "light":
        if mode == 1:
            return "#ffffff"
        elif mode == 2:
            return "black"
    elif theme == "dark":
        if mode == 1:
            return "#333333"
        elif mode == 2:
            return "white"

# è®¾ç½®ä¸»é¢˜
def set_theme(theme_choice):
    global theme
    if theme_choice == "æµ…è‰²æ¨¡å¼":
        root.tk.call("set_theme", "light")
        theme = "light"
    elif theme_choice == "æ·±è‰²æ¨¡å¼":
        root.tk.call("set_theme", "dark")
        theme = "dark"
    elif theme_choice == "è‡ªåŠ¨åˆ‡æ¢":
        clock = int(strftime("%H"))
        if ((clock >= 0 and clock <= 4) or (clock >= 21 and clock <= 24)):
            root.tk.call("set_theme", "dark")
            theme = "dark"
        else:
            root.tk.call("set_theme", "light")
            theme = "light"
    elif theme_choice == "è·Ÿéšç³»ç»Ÿ":
        if darkdetect.theme() == "Dark":
            root.tk.call("set_theme", "dark")
            theme = "dark"
        else:
            root.tk.call("set_theme", "light")
            theme = "light"
        
    # é‡æ–°åº”ç”¨è¡¨æ ¼æ ·å¼
    style = ttk.Style()
    style.configure("Treeview.Heading", font=('Microsoft YaHei', 14))
    style.configure("Treeview",font=('Microsoft YaHei', 12))

    style.configure("Large.TLabelframe.Label", font=('Microsoft YaHei', 12, 'bold'),background=judge_theme(1), foreground=judge_theme(2))

    # æ›´æ–°æ•°æ®åº“ä¸­çš„ä¸»é¢˜è®¾ç½®
    c.execute("UPDATE theme_settings SET theme_choice=? WHERE id=1", (theme_choice,))
    conn.commit()

c.execute("SELECT theme_choice FROM theme_settings")
current_theme = c.fetchone()[0]
conn.commit()
set_theme(current_theme)

def update_theme():
    c.execute("SELECT theme_choice FROM theme_settings")
    cur_theme = c.fetchone()[0]
    if cur_theme == "è·Ÿéšç³»ç»Ÿ":
        set_theme(cur_theme)
    conn.commit()

    root.after(100, update_theme)

update_theme()

# Tooltipç±»
class Tooltip:
    def __init__(self, widget, text):
        self.widget = widget
        self.text = text
        self.tipwindow = None
        self.after_id = None  # ä»…ä¿ç•™å»¶è¿Ÿå®šæ—¶å™¨
        self.widget.bind("<Enter>", self.schedule_show)
        self.widget.bind("<Leave>", self.schedule_hide)

    def schedule_show(self, event=None):
        """å®‰æ’å»¶è¿Ÿæ˜¾ç¤º"""
        self.cancel_pending()
        self.after_id = self.widget.after(500, self.showtip)

    def schedule_hide(self, event=None):
        """ç«‹å³éšè—"""
        self.cancel_pending()
        if self.tipwindow:
            self.tipwindow.destroy()
            self.tipwindow = None

    def cancel_pending(self):
        """å–æ¶ˆå¾…æ‰§è¡Œæ“ä½œ"""
        if self.after_id:
            self.widget.after_cancel(self.after_id)
            self.after_id = None

    def showtip(self):
        """ç›´æ¥æ˜¾ç¤ºæç¤ºçª—å£"""
        if self.tipwindow or not self.text:
            return
        
        # å®šä½è®¡ç®—
        x = self.widget.winfo_rootx() + 25
        y = self.widget.winfo_rooty() + 25
        
        # åˆ›å»ºæ™®é€šçª—å£
        self.tipwindow = tw = tk.Toplevel(self.widget)
        tw.wm_overrideredirect(True)
        tw.wm_geometry(f"+{x}+{y}")
        
        # æ ·å¼é…ç½®
        bg_color = judge_theme(1)
        text_color = judge_theme(2)
        label = tk.Label(tw, text=self.text, justify='left',
                        background=bg_color, foreground=text_color,
                        relief='solid', borderwidth=1,
                        font=("Microsoft YaHei", 10))
        label.pack()

    def __del__(self):
        """å¯¹è±¡é”€æ¯æ—¶æ¸…ç†èµ„æº"""
        if self.tipwindow:
            self.tipwindow.destroy()


# æ›´æ–°å‰©ä½™å¤©æ•°
def update_rest_days():
    current_date = datetime.now().strftime("%Y/%m/%d")
    c.execute("SELECT id, due_date FROM tasks")
    tasks = c.fetchall()
    
    for task in tasks:
        task_id, due_date_str = task
        
        due_date = datetime.strptime(due_date_str, "%Y/%m/%d")
        current_date_obj = datetime.strptime(current_date, "%Y/%m/%d")
        rest_days = (due_date - current_date_obj).days
        c.execute("UPDATE tasks SET rest_days=? WHERE id=?", (rest_days, task_id))
    
    conn.commit()
    root.after(1000, update_rest_days)  # æ¯ç§’æ›´æ–°

# æ›´æ–°æ—¶é—´
def update_time():
    timenow = judge_time()
    stime = strftime("%Y/%m/%d %H:%M:%S")
    def adjust_font_size(event):
        height = event.height
        if height / 2 > 55:
            height = 55 * 2
        elif height / 2 < 15:
            height = 15 * 2
        font_size = int(height / 2.5)
        time_label.config(font=("Microsoft YaHei", font_size))

    if not hasattr(root, 'time_label'):
        time_label = ttk.Label(top_frame, text=f"{timenow}å¥½ï¼Œç°åœ¨æ˜¯{stime}", font=("Microsoft YaHei", 21))
        time_label.place(relx=0.5, rely=0.5, anchor="center")
        root.time_label = time_label
        top_frame.bind("<Configure>", adjust_font_size)
    else:
        root.time_label.config(text=f"{timenow}å¥½ï¼Œç°åœ¨æ˜¯{stime}")
    root.after(1000, update_time)

# ç‰ˆæœ¬æ£€æµ‹
def version_judge(parent):
    c.execute("SELECT check_updates FROM notice_settings")
    if not c.fetchone()[0]:
        return
    
    github_api = 'https://api.github.com/repos/tiantianyzj/taskwing/releases/latest'

    res = requests.get(github_api).json()
    get_version = res['name']# æœ€æ–°ç‰ˆæœ¬
    get_log = res['body']# æ›´æ–°æ—¥å¿—
    get_time = res['created_at'][0:10]# å‘å¸ƒæ—¶é—´
    if(Version != get_version):
        if parent == root:
            sent_notice("å‘ç°æ–°ç‰ˆæœ¬", f"{Version} â†’ {get_version}")
        if messagebox.askokcancel("å‘ç°æ–°ç‰ˆæœ¬", f"æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼š{Version} â†’ {get_version}\nå‘å¸ƒæ—¶é—´ï¼š{get_time}\n\næ›´æ–°å†…å®¹ï¼š\n{get_log}\n\nå•å‡»ã€ç¡®å®šã€‘ç«‹å³ä¸‹è½½", parent=parent):
            sent_notice("ä¸‹è½½å·²å¼€å§‹", "æ‚¨å¯ä»¥ç»§ç»­æ­£å¸¸ä½¿ç”¨å­¦ç¿¼")
            get_down_url = res['assets'][0]['browser_download_url']# ä¸‹è½½é“¾æ¥
            # åˆ›å»ºè¿›åº¦çª—å£
            progress_window = tk.Toplevel(parent)
            progress_window.title("ä¸‹è½½è¿›åº¦")
            progress_window.resizable(False, False)
            progress_bar = ttk.Progressbar(progress_window, length=300, mode='determinate')
            progress_bar.pack(padx=20, pady=20)
            progress_label = ttk.Label(progress_window, text="0%")
            progress_label.pack()

            def download_with_progress():
                try:
                    # æ–°å¢å¸¦è¿›åº¦æ¡çš„ä¸‹è½½ä»£ç 
                    r = get_down_url
                    response = requests.get(r, stream=True)
                    file_name = r.split('/')[-1]  # ä»URLæå–æ–‡ä»¶å
                    total_size = int(response.headers.get('content-length', 0))
                    
                    # æ·»åŠ æ—¶é—´è®¡ç®—ç›¸å…³å˜é‡
                    start_time = time()
                    last_update = 0  # ç”¨äºé™åˆ¶æ›´æ–°é¢‘ç‡
                    
                    # è®¾ç½®ä¸‹è½½è·¯å¾„ä¸ºç³»ç»Ÿä¸‹è½½æ–‡ä»¶å¤¹
                    download_dir = os.path.join(os.path.expanduser('~'), 'Downloads')
                    os.makedirs(download_dir, exist_ok=True)  # ç¡®ä¿æ–‡ä»¶å¤¹å­˜åœ¨

                    file_name = r.split('/')[-1]
                    save_path = os.path.join(download_dir, file_name)  # å®Œæ•´ä¿å­˜è·¯å¾„

                    with open(save_path, 'wb') as f:  # ä¿®æ”¹ä¿å­˜è·¯å¾„
                        downloaded = 0
                        for chunk in response.iter_content(chunk_size=1024*128):
                            if chunk:
                                f.write(chunk)
                                downloaded += len(chunk)
                                progress = (downloaded / total_size) * 100

                                # æ–°å¢å‰©ä½™æ—¶é—´è®¡ç®—
                                current_time = time()
                                elapsed = current_time - start_time
                                speed = downloaded / elapsed  # å­—èŠ‚/ç§’
                                remaining = (total_size - downloaded) / speed if speed > 0 else 0
                                
                                # æ¯0.2ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
                                if current_time - last_update >= 0.2 or progress >= 99.9:
                                    # æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                                    remaining_str = f"{remaining//60:.0f}åˆ†{remaining%60:.0f}ç§’" if remaining > 60 else f"{remaining:.1f}ç§’"
                                    progress_label.config(text=f"{progress:.1f}% (å‰©ä½™ {remaining_str})")
                                    last_update = current_time

                                # æ›´æ–°è¿›åº¦æ¡
                                progress_bar['value'] = progress
                                # progress_label.config(text=f"{progress:.1f}%")
                                root.update_idletasks()
                                print(f"\rä¸‹è½½è¿›åº¦: {progress:.1f}%", end='')
                    progress_window.destroy()
                    sent_notice("ä¸‹è½½å®Œæˆ", "è¯·è¿”å›å­¦ç¿¼è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ")
                    if messagebox.showinfo("ä¸‹è½½å®Œæˆ", "ä¸‹è½½å®Œæˆï¼\nå•å‡»ã€ç¡®å®šã€‘ä»¥è¿›è¡Œå®‰è£…ï¼Œæœ¬ç¨‹åºå°†è‡ªåŠ¨é€€å‡º", parent=parent):
                        os.startfile(save_path)  # æ‰“å¼€ä¸‹è½½çš„æ–‡ä»¶
                        root.destroy()  # é€€å‡ºç¨‹åº
                except Exception as e:
                    if str(e) == "invalid command name \".!toplevel.!label\"":
                        messagebox.showerror("ä¸‹è½½é”™è¯¯", "æ‚¨æ‰‹åŠ¨å…³é—­äº†ä¸‹è½½çª—å£ï¼Œä¸‹è½½è¢«å–æ¶ˆ\nè‹¥ä¸ºè¯¯è§¦ï¼Œå¯å‰å¾€ã€è®¾ç½®ã€‘â€”ã€æ£€æŸ¥æ›´æ–°ã€‘é‡æ–°è¿è¡Œè¯¥æ£€æŸ¥ç¨‹åº", parent=parent)
                    else:
                        messagebox.showerror("ä¸‹è½½é”™è¯¯", f"ä¸‹è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨ç¹å¿™\né”™è¯¯ä¿¡æ¯ï¼š {str(e)}", parent=parent)
                    progress_window.destroy()
                
            threading.Thread(target=download_with_progress, daemon=True).start()
    elif(Version == get_version and parent != root):      
        messagebox.showinfo("æ£€æŸ¥å®Œæˆ", f"å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬\nå½“å‰ç‰ˆæœ¬ï¼š{Version}\nå‘å¸ƒæ—¶é—´{get_time}\n\næ­¤ç‰ˆæœ¬æ›´æ–°å†…å®¹ï¼š\n{get_log}", parent=parent)

# æ˜¾ç¤ºæ‰˜ç›˜å›¾æ ‡
def create_tray_icon():
    image = Image.open(resource_path('LOGO.ico'))

    menu = (
        pystray.MenuItem('ä¸»é¡µ', on_showing),
        pystray.MenuItem('AIæ™ºç­”', open_ai_assistant_window),
        pystray.MenuItem('ç»Ÿè®¡æŠ¥å‘Š', open_progress_window),
        pystray.MenuItem('è®¾ç½®', open_settings_window),
        pystray.MenuItem('å…³äºåº”ç”¨', open_about_window),
        pystray.MenuItem('é€€å‡º', on_closing)
    )

    if (get_num(1) == 0):
        icon = pystray.Icon("LOGO", image, f"å­¦ç¿¼ï¼ˆæ²¡æœ‰æ·»åŠ ä»»åŠ¡ï¼‰", menu)
    else:
        if (get_num(3) > 0):
            icon = pystray.Icon("LOGO", image, f"å­¦ç¿¼ï¼ˆ{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆï¼‰", menu)
        elif (get_num(3)  == 0):
            icon = pystray.Icon("LOGO", image, f"å­¦ç¿¼ï¼ˆæ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼‰", menu)
        
    return icon

# æ›´æ–°ä»»åŠ¡åˆ—è¡¨
def update_task_list():
    task_list.delete(*task_list.get_children())
    c.execute("SELECT * FROM tasks")
    tasks = c.fetchall()
    for task in tasks:
        task_list.insert("", "end", values=task)
    
# æ·»åŠ ä»»åŠ¡
def add_task():
    current_date = datetime.now().strftime("%Y/%m/%d")
    name = name_entry.get().strip()
    due_date = date_entry.get().strip()
    
    if not name:
        messagebox.showerror("é”™è¯¯", "ä»»åŠ¡åç§°ä¸èƒ½ä¸ºç©º")
        return
    
    try:
        # å…ˆè½¬æ¢ä¸ºdatetimeå¯¹è±¡å†è¿›è¡Œè®¡ç®—
        due_date_obj = datetime.strptime(due_date, "%Y/%m/%d")
        current_date_obj = datetime.strptime(current_date, "%Y/%m/%d")
    except ValueError:
        messagebox.showerror("é”™è¯¯", "æ—¥æœŸæ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨YYYY/MM/DDæ ¼å¼")
        return

    # è®¡ç®—å‰©ä½™å¤©æ•°ï¼ˆä½¿ç”¨datetimeå¯¹è±¡ï¼‰
    rest_days = (due_date_obj - current_date_obj).days

    # æ’å…¥ä»»åŠ¡å¹¶æ›´æ–°è®¡æ•°å™¨
    c.execute(
    "INSERT INTO tasks (name, due_date, rest_days, completed) VALUES (?, ?, ?, ' ')",
    (name, due_date, rest_days)
    )
    c.execute("UPDATE task_counter SET total_tasks = total_tasks + 1")
    conn.commit()
    
    # é‡æ–°ç¼–å·ä»»åŠ¡ID
    c.execute("SELECT id FROM tasks ORDER BY id")
    ids = [row[0] for row in c.fetchall()]
    for i, task_id in enumerate(ids):
        c.execute("UPDATE tasks SET id=? WHERE id=?", (i + 1, task_id))
    conn.commit()

    update_task_list()
    name_entry.delete(0, tk.END)
    sent_notice("æ‚¨æ·»åŠ äº†ä¸€ä¸ªä»»åŠ¡", name)

# ç¼–è¾‘ä»»åŠ¡
def edit_task():
    selected = task_list.selection()
    if not selected:
        messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¿®æ”¹ã€‚")
        return
    item = task_list.item(selected)
    task_id, name, due_date, rest_days, completed, *extra_values = item['values']
    
    edit_window = tk.Toplevel(root)
    edit_window.title("ä¿®æ”¹ä»»åŠ¡")
    edit_window.geometry("500x300")
    edit_window.resizable(False, False)
    
    # ä¸»å®¹å™¨æ¡†æ¶
    main_frame = ttk.Frame(edit_window)
    main_frame.pack(fill="both", expand=True, padx=10, pady=10)
    
    # ========== ä»»åŠ¡ä¿¡æ¯éƒ¨åˆ† ==========
    info_frame = ttk.LabelFrame(main_frame, text="ä»»åŠ¡è¯¦æƒ…", padding=10, style="Large.TLabelframe")
    info_frame.pack(fill="x", pady=5)
    
    # ä»»åŠ¡åç§°
    ttk.Label(info_frame, text="ä»»åŠ¡åç§°:").grid(row=0, column=0, sticky="w", padx=5)
    name_entry = ttk.Entry(info_frame, width=40)
    name_entry.bind("<Return>", lambda e: save_changes())
    name_entry.insert(0, name)
    name_entry.grid(row=0, column=1, columnspan=3, sticky="w", padx=5)

    # ========== æˆªæ­¢æ—¥æœŸéƒ¨åˆ† ==========
    ttk.Label(info_frame, text="æˆªæ­¢æ—¥æœŸ:").grid(row=1, column=0, sticky="w", padx=5, pady=5)
    
    # åˆ›å»ºæ—¥æœŸè¾“å…¥æ¡†
    date_entry = ttk.Entry(info_frame, width=12, font=('Microsoft YaHei', 9))
    date_entry.insert(0, due_date)  # ä½¿ç”¨åŸæ—¥æœŸåˆå§‹åŒ–
    date_entry.grid(row=1, column=1, sticky="w", padx=5, pady=10)
    date_entry.bind("<Return>", lambda e: save_changes())
    
    def set_edit_date():
        def on_date_select():
            date_entry.delete(0, tk.END)
            date_entry.insert(0, cal.get_date())
            top.grab_release()
            top.destroy()
        
        # è§£æåŸå§‹æ—¥æœŸ
        init_year, init_month, init_day = map(int, due_date.split('/'))
        
        top = tk.Toplevel(edit_window)
        top.title("é€‰æ‹©æ—¥æœŸ")
        top.resizable(False, False)
        top.transient(root)
        top.grab_set()
        cal = Calendar(top, 
                      selectmode='day',
                      year=init_year,
                      month=init_month,
                      day=init_day,
                      date_pattern='y/mm/dd')
        cal.pack(padx=10, pady=10)
        ttk.Button(top, text="ç¡®å®š", command=on_date_select).pack(pady=10)
    
    # æ·»åŠ æ—¥æœŸé€‰æ‹©æŒ‰é’®
    ttk.Button(info_frame, text="ğŸ“… é€‰æ‹©", command=set_edit_date).grid(row=1, column=1, padx=120, pady=10)
    Tooltip(info_frame.winfo_children()[4], "åœ¨æ—¥å†ä¸­é€‰æ‹©æ—¥æœŸ")

    # ========== ä»»åŠ¡çŠ¶æ€éƒ¨åˆ† ==========
    status_frame = ttk.LabelFrame(main_frame, text="ä»»åŠ¡çŠ¶æ€", padding=10, style="Large.TLabelframe")
    status_frame.pack(fill="x", pady=5)
    
    completed_var = tk.BooleanVar(value=(completed == "âœ…"))
    ttk.Checkbutton(
        status_frame,
        text="å·²å®Œæˆ",
        variable=completed_var,
        onvalue=True,
        offvalue=False
    ).pack(side="left", padx=5)

    # ========== æŒ‰é’®éƒ¨åˆ† ==========
    btn_frame = ttk.Frame(main_frame)
    btn_frame.pack(pady=10)

    def save_changes():
        current_date = datetime.now().strftime("%Y/%m/%d")
        new_name = name_entry.get()
        new_status = "âœ…" if completed_var.get() else " "
        
        new_name = name_entry.get().strip()
        new_date = date_entry.get().strip()
        
        # éªŒè¯æ—¥æœŸæ ¼å¼
        try:
            datetime.strptime(new_date, "%Y/%m/%d")
        except ValueError:
            messagebox.showerror("é”™è¯¯", "æ—¥æœŸæ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨YYYY/MM/DDæ ¼å¼")
            return
        
        # è®¡ç®—æ–°å‰©ä½™å¤©æ•°
        current_date = datetime.now().date()
        due_date_obj = datetime.strptime(new_date, "%Y/%m/%d").date()
        new_rest_days = (due_date_obj - current_date).days

        # è·å–åŸå§‹çŠ¶æ€
        c.execute("SELECT completed FROM tasks WHERE id=?", (task_id,))
        current_status = c.fetchone()[0].strip()
        
        if current_status.strip() == '' and new_status == "âœ…":
            conn.commit()  
            
            total = get_num(1)
            actual_completed = get_num(2)+1
            remaining = get_num(3)-1
            progress = round(actual_completed / total * 100, 2)
            print(total, actual_completed, remaining)

            if remaining == 0:
                sent_notice("å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡ï¼ŒçœŸå‰å®³ï¼", f"å·²å®Œæˆ{progress}%ï¼Œå…±è®¡{total}ä¸ªä»»åŠ¡")
            else:
                sent_notice("æå®šä¸€ä¸ªä»»åŠ¡ï¼Œå¤ªæ£’äº†ï¼", f"å·²å®Œæˆ{progress}%ï¼Œè¿˜æœ‰{remaining}ä¸ªä»»åŠ¡å¾…å®Œæˆ")

        # æ›´æ–°æ•°æ®åº“
        try:
            c.execute(
            "UPDATE tasks SET name=?, due_date=?, rest_days=?, completed=? WHERE id=?",
            (new_name, new_date, new_rest_days, new_status, task_id)
            )
            
            conn.commit()
            update_task_list()
            edit_window.destroy()
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ä¿å­˜å¤±è´¥ï¼š{str(e)}")
            conn.rollback()

    ttk.Button(
        btn_frame,
        text="ğŸ’¾ ä¿å­˜",
        command=save_changes,
        width=15
    ).pack(side="left", padx=10)
    
    ttk.Button(
        btn_frame,
        text="â†©ï¸ å–æ¶ˆ",
        command=edit_window.destroy,
        width=10
    ).pack(side="right", padx=10)

    edit_window.transient(root)
    edit_window.grab_set()

# å¤åˆ¶å¹¶ç²˜è´´ä»»åŠ¡
def copy_and_paste_task():
    selected = task_list.selection()
    if selected:
        task_id = task_list.item(selected[0], "values")[0]
        # è·å–åŸå§‹ä»»åŠ¡æ•°æ®
        c.execute("SELECT name, due_date, rest_days, completed FROM tasks WHERE id=?", (task_id,))
        original = c.fetchone()
        
        if original:
            try:
                new_name = f"{original[0]}ï¼ˆå‰¯æœ¬ï¼‰" 
                c.execute("INSERT INTO tasks (name, due_date, rest_days, completed) VALUES (?, ?, ?, ?)",
                        (new_name, original[1], original[2], original[3]))
                
                # é‡æ–°ç¼–å·ä»»åŠ¡ID
                c.execute("SELECT id FROM tasks ORDER BY id")
                ids = [row[0] for row in c.fetchall()]
                for i, task_id in enumerate(ids):
                    c.execute("UPDATE tasks SET id=? WHERE id=?", (i + 1, task_id))
                conn.commit()

                update_task_list()
                sent_notice("æ‚¨åˆ›å»ºäº†ä¸€ä¸ªä»»åŠ¡å‰¯æœ¬", new_name)
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"å¤åˆ¶å¤±è´¥\né”™è¯¯ä¿¡æ¯ï¼š{str(e)}")

# åˆ é™¤ä»»åŠ¡
def delete_task():
    selected = task_list.selection()
    if not selected:
        messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡è¿›è¡Œåˆ é™¤ã€‚")
        return
    item = task_list.item(selected)
    task_id = item['values'][0]
    
    # åˆ é™¤å…³è”ç»Ÿè®¡è®°å½•
    c.execute("DELETE FROM tasks WHERE id=?", (task_id,))
    conn.commit()

    # é‡æ–°ç¼–å·
    c.execute("SELECT id FROM tasks ORDER BY id")
    ids = [row[0] for row in c.fetchall()]
    for i, task_id in enumerate(ids):
        c.execute("UPDATE tasks SET id=? WHERE id=?", (i + 1, task_id))
    conn.commit()

    update_task_list()
    sent_notice("æ‚¨åˆ é™¤äº†ä¸€ä¸ªä»»åŠ¡",f"ç›®å‰è¿˜æœ‰{get_num(1)}ä¸ªä»»åŠ¡ï¼Œ{get_num(3)}ä¸ªå¾…å®Œæˆ")

# ç¡®è®¤æ¸…ç©ºä»»åŠ¡åˆ—è¡¨çš„å‡½æ•°
def confirm_clear_tasks():
    if messagebox.askokcancel("ç¡®è®¤", "ç¡®å®šè¦æ¸…ç©ºä»»åŠ¡åˆ—è¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤"):
        c.execute("DELETE FROM tasks")
        conn.commit()
        update_task_list()
        sent_notice("æ‚¨æ¸…ç©ºäº†ä»»åŠ¡åˆ—è¡¨","ä»»åŠ¡åˆ—è¡¨æ¸…ç©ºæˆåŠŸ")

def pomodoro_set_tasks():
    # è·å–é€‰ä¸­çš„ä»»åŠ¡
    selected = task_list.selection()
    if not selected:
        messagebox.showwarning("æç¤º", "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡", parent=root)
        return
    
    # è·å–å®é™…ä»»åŠ¡ID
    item = task_list.item(selected)
    task_id = item['values'][0]
    task_name = item['values'][1]
    task_due = item['values'][2]
    task_rest = item['values'][3]

    # åˆ›å»ºè®¾ç½®çª—å£
    setup_win = tk.Toplevel(root)
    setup_win.title("ç•ªèŒ„é’Ÿè®¾ç½®")
    setup_win.geometry("600x700")  # å¢åŠ çª—å£é«˜åº¦
    setup_win.resizable(False, False)
    setup_win.transient(root)
    setup_win.grab_set()
    
    # ========== ä¸»å®¹å™¨ ==========
    main_frame = ttk.Frame(setup_win)
    main_frame.pack(fill='both', expand=True, padx=20, pady=15)
    
    # ========== è®¾ç½®åŒºåŸŸ ==========
    setup_frame = ttk.Frame(main_frame)
    setup_frame.pack(fill='x', pady=10)
    
    # æ ‡é¢˜å’Œè¾“å…¥æ¡†
    header = ttk.Label(setup_frame, 
                      text="ğŸ… ç•ªèŒ„é’Ÿè®¾ç½®",
                      font=('Microsoft YaHei', 16, 'bold'),
                      foreground='#4fb9fe')
    header.pack(pady=5)

    info_frame = ttk.LabelFrame(setup_frame, text="ä»»åŠ¡ä¿¡æ¯", style="Large.TLabelframe", padding=15)
    info_frame.pack(fill='both', expand=True, pady=10)

    ttk.Label(info_frame, 
             text=f"""å½“å‰ä»»åŠ¡ï¼š{task_name}
æˆªæ­¢æ—¥æœŸï¼š{task_due}
å‰©ä½™å¤©æ•°ï¼š{task_rest}""", 
             font=('Microsoft YaHei', 12),
             justify='left').grid(row=0, column=0, padx=5)

    input_frame = ttk.LabelFrame(setup_frame, text="æ—¶é•¿è®¾ç½®", style="Large.TLabelframe", padding=15)
    input_frame.pack(fill='both', expand=True, pady=10)
    
    ttk.Label(input_frame, 
             text="ä¸“æ³¨æ—¶é•¿:", 
             font=('Microsoft YaHei', 12)).grid(row=0, column=0, padx=5)
    
    time_var = tk.StringVar(value="25")
    duration_combo = ttk.Combobox(
        input_frame,
        textvariable=time_var,
        values=["5", "10", "15", "20", "25", "30", "45", "60", "90", "120", 
               "150", "180", "210", "240", "270", "300", "330", "360", "390", 
               "420", "450", "480", "510", "540", "570", "600"],
        state="readonly",
        font=('Microsoft YaHei', 11),
        width=8
    )
    duration_combo.grid(row=0, column=1, padx=10)

    ttk.Label(input_frame, 
             text="åˆ†é’Ÿ", 
             font=('Microsoft YaHei', 12)).grid(row=0, column=2, padx=5)
    
    # ========== è¯´æ˜åŒºåŸŸ ==========
    desc_frame = ttk.LabelFrame(main_frame, 
                              text="æ–¹æ³•è¯´æ˜", 
                              padding=15,
                              style="Large.TLabelframe")
    desc_frame.pack(fill='both', expand=True, pady=10)
    
    desc_text = """â€¢ æ¨èä½¿ç”¨æ–¹å¼ï¼š
  1ã€é€‰æ‹©25åˆ†é’Ÿä¸“æ³¨å•å…ƒ
  2ã€ä¸“æ³¨æœŸé—´ä¸å¤„ç†å…¶ä»–äº‹åŠ¡
  3ã€å®Œæˆåä¼‘æ¯5åˆ†é’Ÿ
  4ã€æ¯å®Œæˆ4ä¸ªç•ªèŒ„é’Ÿä¼‘æ¯15-30åˆ†é’Ÿ

â€¢ æ³¨æ„äº‹é¡¹ï¼š
  1ã€é‡åˆ°æ‰“æ–­éœ€é‡æ–°å¼€å§‹è®¡æ—¶
  2ã€ä¼‘æ¯æ—¶é—´ä¸è¦ä½¿ç”¨ç”µå­è®¾å¤‡"""
    
    ttk.Label(desc_frame, 
             text=desc_text,
             font=('Microsoft YaHei', 10),
             foreground='#7f8c8d',
             justify='left').pack(anchor='w')
    
    # ========== æŒ‰é’®åŒºåŸŸ ==========
    btn_frame = ttk.Frame(main_frame)
    btn_frame.pack(pady=15)
    
    def start_pomodoro():
        setup_win.destroy()
        show_pomodoro_interface(int(time_var.get()), task_id)

    start_btn = ttk.Button(
        btn_frame,
        text="âŒ›ï¸ å¼€å§‹ä¸“æ³¨",
        command=lambda:start_pomodoro(),
        width=15,
        style="Accent.TButton"
    )
    start_btn.pack(pady=5)
    
    # æ·»åŠ æ ·å¼é…ç½®
    style = ttk.Style()
    style.configure("Accent.TButton", 
                   foreground='white',
                   background='#3498db',
                   font=('Microsoft YaHei', 12))

    setup_win.bind("<Return>", lambda e: start_pomodoro())

def show_pomodoro_interface(duration, task_id):
    # è·å–ä»»åŠ¡è¯¦æƒ…
    c.execute("SELECT name, due_date, rest_days FROM tasks WHERE id=?", (task_id,))
    task = c.fetchone()
    
    # åˆ›å»ºä¸»çª—å£
    pomo_win = tk.Toplevel(root)
    pomo_win.title(f"ç•ªèŒ„é’Ÿ - {task[0]}")
    pomo_win.geometry("800x800")
    
    main_frame = ttk.Frame(pomo_win)
    main_frame.pack(fill='both', expand=True)

    # ä¸€è¨€æ˜¾ç¤ºåŒºåŸŸ
    try:
        yiyan = requests.get("https://v1.hitokoto.cn/?c=k").json()
        yiyan_text = f"ã€{yiyan['hitokoto']}ã€ â€”â€” {yiyan['from']}"
    except:
        yiyan_text = "ã€å­¦å¦‚é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€ã€ â€”â€” ã€Šå¢å¹¿è´¤æ–‡ã€‹"
    
    yiyan_label = ttk.Label(
        main_frame,
        text=yiyan_text,
        font=('åæ–‡é­ä½“', 14, 'italic'),
        wraplength=1300,
        justify='left'
    )
    yiyan_label.pack(pady=20)

    # åˆ†éš”çº¿
    ttk.Separator(main_frame).pack(fill='x', pady=10, padx=30)
    
    # ä»»åŠ¡ä¿¡æ¯æ˜¾ç¤º
    task_frame = ttk.Frame(main_frame)
    task_frame.pack(pady=10)
    
    task_label1 = ttk.Label(task_frame, text=f"æ‚¨å½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡æ˜¯ã€{task[0]}ã€‘", font=('å¾®è½¯é›…é»‘', 12), justify='center')
    task_label1.grid(row=0, column=0)
    task_label2 = ttk.Label(task_frame, text=f"ä»»åŠ¡å°†äº {task[1]} æˆªæ­¢ï¼Œå‰©ä½™{task[2]}å¤©", font=('å¾®è½¯é›…é»‘', 8), justify='center')
    task_label2.grid(row=1, column=0)
    
    # è®¡æ—¶å™¨æ˜¾ç¤º
    time_label = ttk.Label(
        main_frame,
        text="â±æ­£è®¡æ—¶\n00:00:00",
        font=('Consolas', 40),
        anchor='center'  # æ·»åŠ å±…ä¸­å¯¹é½
    )
    time_label.pack(pady=20, fill='both', expand=True)
    
    # æ—¶é—´è¿›åº¦æ˜¾ç¤º
    start_time = datetime.now()
    end_time = start_time + timedelta(minutes=duration)
    time_info = ttk.Label(
        main_frame,
        text=f"{start_time.strftime('%H:%M:%S')} - {end_time.strftime('%H:%M:%S')}",
        font=('å¾®è½¯é›…é»‘', 8)
    )
    time_info.pack()
    
    # è®¡ç®—å­—ä½“å¢é‡
    add_size = 0
    def update_font_size(event=None):
        nonlocal add_size
        pomo_win.update_idletasks()
        win_height = pomo_win.winfo_height()
        
        add_size = int(win_height / 70)
        # æ›´æ–°æ‰€æœ‰å­—ä½“è®¾ç½®
        yiyan_label.config(font=('åæ–‡é­ä½“', 13+add_size, 'italic'))
        task_label1.config(font=('å¾®è½¯é›…é»‘', 10+add_size))
        task_label2.config(font=('å¾®è½¯é›…é»‘', 8+add_size))
        time_label.config(font=('Consolas', 40+add_size))
        time_info.config(font=('å¾®è½¯é›…é»‘', 10+add_size))

    # åˆå§‹åŒ–è®¾ç½®
    pomo_win.bind("<Configure>", update_font_size)
    update_font_size()

    # åˆ†éš”çº¿
    ttk.Separator(main_frame).pack(fill='x', pady=10, padx=30)

    # éŸ³é¢‘æ§åˆ¶éƒ¨åˆ†
    audio_frame = ttk.LabelFrame(main_frame, text="éŸ³é¢‘è®¾ç½®", style="Large.TLabelframe")
    audio_frame.pack(pady=15, padx=20, anchor='center', ipadx=5, ipady=5)
    
    # ç™½å™ªéŸ³é€‰æ‹©
    pygame.mixer.init()
    sounds = {
        "æ•£æ­¥æ—¶åˆ»": "sound/relaxing_walk.mp3",
        "æºªè¾¹è›™é¸£": "sound/frogs.mp3",
        "æ˜Ÿè¾°éœ²è¥": "sound/camping.mp3",
        "è¥ç«æŸ´å£°": "sound/campfire.mp3",
        "é›¨åå¤©æ™´": "sound/after_rain.mp3",
        "å¤§é›¨æ»‚æ²±": "sound/heavy_rain.mp3",
        "è‡ªç„¶æ°´æµ": "sound/stream.mp3",
        "è¿·é›¾æ£®æ—": "sound/foggy_forest.mp3"
    }
    
    sound_var = tk.StringVar()
    ttk.Label(audio_frame, text="é€‰æ‹©ç¯å¢ƒéŸ³æ•ˆï¼š").grid(row=0, column=0, padx=5, pady=5)
    sound_combo = ttk.Combobox(
        audio_frame,
        textvariable=sound_var,
        values=list(sounds.keys()),
        state="readonly",
        width=18
    )
    sound_combo.grid(row=0, column=1, padx=5, pady=5)
    
    # æ§åˆ¶æŒ‰é’®
    def play_sound():
        if sound_var.get():
            pygame.mixer.music.load(resource_path(sounds[sound_var.get()]))
            pygame.mixer.music.play(-1)
    
    
    paused = [False]
    
    play_btn = ttk.Button(audio_frame, text="â–¶ï¸ æ’­æ”¾", width=10)
    play_btn.grid(row=0, column=2, padx=5)
    
    # ä¿®æ”¹åçš„æ’­æ”¾æ§åˆ¶é€»è¾‘
    def toggle_play():
        if not pygame.mixer.music.get_busy() or paused[0]:
            play_sound()
            play_btn.config(text="â¸ æš‚åœ")
            paused[0] = False
        else:
            pygame.mixer.music.pause()
            play_btn.config(text="â–¶ï¸ ç»§ç»­")
            paused[0] = True
    
    play_btn.config(command=toggle_play)

    # æ–°å¢éŸ³é‡æ§åˆ¶ç»„ä»¶
    ttk.Label(audio_frame, text="ç³»ç»ŸéŸ³é‡:").grid(row=1, column=0, padx=5, pady=5)
    volume_scale = ttk.Scale(
        audio_frame,
        from_=0,
        to=100,
        value=get_current_volume(),
        command=lambda v: [  # æ·»åŠ å®æ—¶æ›´æ–°é€»è¾‘
            set_system_volume(v),
            volume_percent.config(text=f"{int(float(v))}%")
        ]
    )
    volume_scale.grid(row=1, column=1, padx=5, pady=5, sticky='ew')
    
    # æ–°å¢å®æ—¶ç™¾åˆ†æ¯”æ ‡ç­¾
    volume_percent = ttk.Label(audio_frame, text=f"{int(volume_scale.get())}%")
    volume_percent.grid(row=1, column=2, padx=2)
    
    ai_frame = ttk.LabelFrame(main_frame, text="å­¦ä¹ è¾…åŠ©", style="Large.TLabelframe")
    ai_frame.pack(pady=15, padx=20, anchor='center', ipadx=10, ipady=5)
    ttk.Button(
        ai_frame,
        text="ğŸ¤– AIæ™ºç­”",
        command=lambda:open_ai_assistant(pomo_win)
    ).pack()
    Tooltip(ai_frame.winfo_children()[0], "ä¸“æ³¨æœŸé—´çš„ç§äººåŠ©æ‰‹")
    
    # æ§åˆ¶é¢æ¿
    ctrl_frame = ttk.Frame(main_frame)
    ctrl_frame.pack(side='bottom', fill='x', pady=10)
    
    def toggle_pause():
        running[0] = not running[0]
        if running[0]:
            pause_button.config(text="â¸ æš‚åœ")
            update_timer()  # æ¢å¤æ—¶é‡æ–°å¯åŠ¨è®¡æ—¶
        else:
            pause_button.config(text="â–¶ï¸ ç»§ç»­")

    # çª—å£ç½®é¡¶é€‰é¡¹
    topmost_var = tk.IntVar(value=0)
    def toggle_topmost():
        pomo_win.attributes('-topmost', topmost_var.get())
    topmost_check = ttk.Checkbutton(
        ctrl_frame,
        text="çª—å£ç½®é¡¶",
        variable=topmost_var,
        command=toggle_topmost
    )
    topmost_check.pack(side='left', padx=20)
    
    # åˆå§‹åŒ–çª—å£ç½®é¡¶çŠ¶æ€
    topmost_var.set(False)
    toggle_topmost()

    # è®¡æ—¶é€»è¾‘
    elapsed = [0]  # ä½¿ç”¨åˆ—è¡¨å®ç°é—­åŒ…æ•ˆæœ
    running = [True]
    
    def update_timer():
        # å…ˆæ£€æŸ¥æ—¶é—´æ¡ä»¶ï¼Œå†æ£€æŸ¥è¿è¡ŒçŠ¶æ€
        if elapsed[0] < duration * 60:
            if running[0]:  # åªæœ‰è¿è¡ŒçŠ¶æ€ä¸ºTrueæ—¶æ‰æ›´æ–°
                elapsed[0] += 1
                m, s = divmod(elapsed[0], 60)
                h, m = divmod(m, 60)
                time_label.config(text=f"â±æ­£è®¡æ—¶\n{h:02d}:{m:02d}:{s:02d}")
                pomo_win.after(1000, update_timer)
            else:  # è¿è¡ŒçŠ¶æ€è¢«è®¾ä¸ºFalseæ—¶ç›´æ¥è¿”å›
                return
        else:
            finish_pomodoro(True)  # ä»…å½“è‡ªç„¶ç»“æŸæ—¶è§¦å‘
    
    def finish_pomodoro(natural_end):
        running[0] = False  # ç«‹å³åœæ­¢è®¡æ—¶å™¨
        pygame.mixer.music.stop()

        should_proceed = True
        # ä»…å½“éè‡ªç„¶ç»“æŸéœ€è¦ç¡®è®¤
        if not natural_end:
            should_proceed = messagebox.askyesno(
                "é€€å‡ºæç¤º",
                "è®¡æ—¶å°šæœªå®Œæˆï¼Œç¡®å®šè¦æå‰ç»“æŸå—ï¼Ÿ\nï¼ˆå»ºè®®åšæŒå®Œæˆå½“å‰ç•ªèŒ„é’Ÿï¼‰",
                icon='warning',
                parent=pomo_win
            )

        if should_proceed:
            if messagebox.askyesno(
                "è®¡æ—¶ç»“æŸ", 
                f"æ˜¯å¦å·²ç»å®Œæˆä»»åŠ¡ã€{task[0]}ã€‘ï¼Ÿ",
                parent=pomo_win
            ):
                # è·å–åŸå§‹çŠ¶æ€
                c.execute("SELECT completed FROM tasks WHERE id=?", (task_id,))
                current_status = c.fetchone()[0].strip()
                
                if current_status.strip() == '':
                    conn.commit()  
                    
                    total = get_num(1)
                    actual_completed = get_num(2)+1
                    remaining = get_num(3)-1
                    progress = round(actual_completed / total * 100, 2)
                    print(total, actual_completed, remaining)

                    if remaining == 0:
                        sent_notice("å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡ï¼ŒçœŸå‰å®³ï¼", f"å·²å®Œæˆ{progress}%ï¼Œå…±è®¡{total}ä¸ªä»»åŠ¡")
                    else:
                        sent_notice("æå®šä¸€ä¸ªä»»åŠ¡ï¼Œå¤ªæ£’äº†ï¼", f"å·²å®Œæˆ{progress}%ï¼Œè¿˜æœ‰{remaining}ä¸ªä»»åŠ¡å¾…å®Œæˆ")

                # æ›´æ–°ä»»åŠ¡çŠ¶æ€
                c.execute("UPDATE tasks SET completed='âœ…' WHERE id=?", (task_id,))
                conn.commit()
                update_task_list()

            # æ›´æ–°ç•ªèŒ„é’Ÿè®°å½•
            minutes = round(elapsed[0] / 60, 2)
            c.execute("UPDATE pomodoro_records SET total_sessions = total_sessions + ?, total_minutes = total_minutes + ?", 
                    (1, minutes,))
            conn.commit()
            
            pomo_win.destroy()
        else:
            running[0] = True
            update_timer()
    
    ttk.Button(
        ctrl_frame,
        text="é€€å‡ºä¸“æ³¨",
        command=lambda: finish_pomodoro(False)
    ).pack(side='right', padx=20)

    pause_button = ttk.Button(
        ctrl_frame,
        text="â¸ æš‚åœ",
        command=lambda: toggle_pause()
    )
    pause_button.pack(side='right', padx=5)

    pomo_win.protocol("WM_DELETE_WINDOW", lambda: finish_pomodoro(False))
    
    update_timer()

button_frame = ttk.Frame(root)
button_frame.grid(row=4, column=0, pady=10)

# æ˜¾ç¤ºè¿›åº¦æŠ¥å‘Š
def show_progress_report():
    progress_window = tk.Toplevel(root)
    progress_window.title("ç»Ÿè®¡æŠ¥å‘Š")
    progress_window.geometry("1200x700")# 
    progress_window.transient(root)
    progress_window.grab_set()

    # è®¾ç½®å…¨å±€å­—ä½“
    style = ttk.Style()
    style.configure("Report.TLabelframe", font=("Microsoft YaHei", 12, "bold"))
    style.configure("Report.TLabel", font=("Microsoft YaHei", 11))
    
    # ä¸»å®¹å™¨ï¼ˆå·¦å³åˆ†æ ï¼‰
    main_frame = ttk.Frame(progress_window)
    main_frame.pack(fill="both", expand=True, padx=20, pady=20)

    # ========== å·¦ä¾§åŒºåŸŸ ==========
    left_frame = ttk.Frame(main_frame)
    left_frame.grid(row=0, column=0, sticky="nsew", padx=10)

    # æ ¸å¿ƒæŒ‡æ ‡åŒº
    metrics_frame = ttk.LabelFrame(left_frame, text="æ ¸å¿ƒæŒ‡æ ‡", style="Report.TLabelframe")
    metrics_frame.pack(fill="x", pady=10)

    # è·å–ç»Ÿè®¡æ•°æ®
    c.execute("SELECT total_tasks FROM task_counter")
    result = c.fetchone()
    total_added = result[0] if result else 0
    c.execute("SELECT COUNT(*) FROM tasks WHERE rest_days=0")
    tomorrow_tasks = c.fetchone()[0]

    # æ•°å€¼æ ¼å¼åŒ–å‡½æ•°
    def format_number(num):
        if num >= 10000:
            return f"{num/10000:.2f} ä¸‡"
        return str(num)

    # æŒ‡æ ‡å¡ç‰‡å¸ƒå±€
    metrics_grid = ttk.Frame(metrics_frame)
    metrics_grid.pack(padx=10, pady=10, fill='both', expand=True)

    # é…ç½®ç½‘æ ¼åˆ—æƒé‡
    for col in range(5):
        metrics_grid.columnconfigure(col, weight=1, uniform='metric_col')

    metrics_data = [
        ("ğŸ“‹ æ€»ä»»åŠ¡æ•°", format_number(get_num(1) or 0), "#4e73df"),
        ("âœ… å·²å®Œæˆ", format_number(get_num(2) or 0), "#1cc88a"),
        ("â³ å¾…å®Œæˆ", format_number(get_num(3) or 0), "#f6c23e"),
        ("â° æ˜æ—¥è¿‡æœŸ", format_number(tomorrow_tasks or 0), "#e74a3b"),
        ("ğŸ“ˆ ç´¯è®¡æ·»åŠ ", format_number(total_added or 0), "#36b9cc")
    ]

    for i, (title, value, color) in enumerate(metrics_data):
        card = ttk.Frame(metrics_grid, relief="groove", borderwidth=1)
        card.grid(row=0, column=i, padx=8, pady=8, sticky="nsew")
        
        # é…ç½®å¡ç‰‡å†…éƒ¨å…ƒç´ å±…ä¸­
        card.columnconfigure(0, weight=1)
        ttk.Label(card, text=title, style="Report.TLabel").pack(pady=5, anchor='center')
        ttk.Label(card, text=str(value), 
                 font=("Microsoft YaHei", 20, "bold"), 
                 foreground=color).pack(pady=5, anchor='center')
    
    # å¸ƒå±€è°ƒæ•´
    for i in range(5):
        card.columnconfigure(i, weight=1)

    # å›¾è¡¨åŒº
    chart_frame = ttk.LabelFrame(left_frame, text="ä»»åŠ¡åˆ†å¸ƒ", style="Report.TLabelframe")
    chart_frame.pack(fill="both", expand=True, pady=10)

    # é…ç½®ä¸­æ–‡å­—ä½“ï¼ˆè§£å†³æ–¹æ ¼å­é—®é¢˜ï¼‰
    plt.rcParams['font.family'] = 'Microsoft YaHei'
    plt.rcParams['axes.unicode_minus'] = False

    fig = plt.Figure(figsize=(10, 8))
    ax1 = fig.add_subplot(211)
    ax2 = fig.add_subplot(212)

    back_color = judge_theme(1)
    front_color = judge_theme(2)

    # è®¾ç½®å›¾è¡¨èƒŒæ™¯è‰²
    fig.patch.set_facecolor(back_color)  # å›¾è¡¨æ•´ä½“èƒŒæ™¯è‰²
    ax1.set_facecolor(back_color)  # ç¬¬ä¸€ä¸ªå­å›¾èƒŒæ™¯è‰²
    ax2.set_facecolor(back_color)  # ç¬¬äºŒä¸ªå­å›¾èƒŒæ™¯è‰²

    # é¥¼å›¾æ•°æ®
    pie_labels = ['å·²å®Œæˆ', 'å¾…å®Œæˆ']
    pie_sizes = [get_num(2), get_num(3)]
    pie_colors = ['#1cc88a', '#f6c23e']
    
    # æŸ±çŠ¶å›¾æ•°æ®
    c.execute("SELECT rest_days, completed FROM tasks")
    all_tasks = c.fetchall()
    
    completed = 0
    pending = 0
    upcoming = 0
    expired = 0
    
    for task in all_tasks:
        rest_days, completed_status = task[0], task[1]
        if completed_status == 'âœ…':
            completed += 1
        else:
            if rest_days >= 1:
                pending += 1
            elif rest_days == 0:
                upcoming += 1
            else:
                expired += 1

    status_labels = ['å·²å®Œæˆ', 'è¿›è¡Œä¸­', 'ä»Šæ—¥æˆªæ­¢', 'å·²è¿‡æœŸ']
    status_values = [completed, pending, upcoming, expired]
    colors = ['#1cc88a', '#4e73df', '#f6c23e', '#e74a3b']  # ç»¿ã€è“ã€é»„ã€çº¢

    # ç»˜åˆ¶å›¾è¡¨
    ax1.pie(pie_sizes, labels=pie_labels, colors=pie_colors,
           autopct='%1.1f%%', startangle=140, textprops={'fontsize':10, 'color': front_color})  # è®¾ç½®å­—ä½“è‰²
    ax1.set_title('ä»»åŠ¡å®Œæˆæ¯”ä¾‹', fontsize=12, color=front_color)  # è®¾ç½®æ ‡é¢˜å­—ä½“è‰²

    bars = ax2.bar(status_labels, status_values, color=colors)
    ax2.set_title('ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒ', fontsize=12, color=front_color)  # è®¾ç½®æ ‡é¢˜å­—ä½“è‰²
    ax2.set_ylabel('ä»»åŠ¡æ•°é‡', fontsize=10, color=front_color)  # è®¾ç½®åæ ‡è½´æ ‡ç­¾å­—ä½“è‰²
    
    # æ·»åŠ æ•°å€¼æ ‡ç­¾
    for bar in bars:
        height = bar.get_height()
        ax2.text(bar.get_x() + bar.get_width()/2., height,
                '%d' % int(height),
                ha='center', va='bottom', fontsize=9, color=front_color)  # è®¾ç½®æ•°å€¼æ ‡ç­¾å­—ä½“è‰²

    # åµŒå…¥å›¾è¡¨
    canvas = FigureCanvasTkAgg(fig, master=chart_frame)
    canvas.draw()
    canvas.get_tk_widget().pack(fill="both", expand=True)

    # ========== å³ä¾§åŒºåŸŸ ==========
    right_frame = ttk.Frame(main_frame)
    right_frame.grid(row=0, column=1, sticky="nsew", padx=10)

    # è¯¦ç»†æ•°æ®åŒº
    detail_frame = ttk.LabelFrame(right_frame, text="ä»»åŠ¡è¯¦æƒ…", style="Report.TLabelframe")
    detail_frame.pack(fill="both", expand=True)

    # å³å°†æˆªæ­¢ä»»åŠ¡åˆ—è¡¨
    c.execute("SELECT name, due_date, rest_days FROM tasks WHERE completed != 'âœ…' ORDER BY rest_days")
    urgent_tasks = c.fetchall()

    text_area = tk.Text(detail_frame, wrap=tk.WORD, font=("Microsoft YaHei", 10))
    text_area.pack(fill="both", expand=True, padx=10, pady=10)
    
    # æ·»åŠ å¸¦æ ¼å¼çš„å†…å®¹
    text_area.tag_configure("header", font=("Microsoft YaHei", 11, "bold"))
    text_area.tag_configure("deadline_today", foreground="#f6c23e")
    text_area.tag_configure("deadline_overdue", foreground="#f8312f")
    text_area.insert(tk.END, "ğŸ“Œ å¾…å®Œæˆä»»åŠ¡\n", "header")
    
    for task in urgent_tasks:
        if (task[2] > 0):
            text_area.insert(tk.END, 
                        f"  â€¢ {task[0]}\n"
                        f"     æˆªæ­¢æ—¥æœŸï¼š{task[1]} ï¼ˆå‰©ä½™{task[2]}å¤©ï¼‰\n\n")
        elif (task[2] == 0):
            text_area.insert(tk.END,
                        f"  â€¢ {task[0]}\n"
                        f"     æˆªæ­¢æ—¥æœŸï¼š{task[1]} ï¼ˆä»Šæ—¥æˆªæ­¢ï¼‰\n\n",
                        "deadline_today")
        else:
            text_area.insert(tk.END, 
                        f" â€¢ {task[0]}\n"
                        f"     æˆªæ­¢æ—¥æœŸï¼š{task[1]} ï¼ˆè¿‡æœŸ{task[2]*-1}å¤©ï¼‰\n\n",
                        "deadline_overdue")
    
    text_area.configure(state="disabled")

    # åœ¨å³ä¾§åŒºåŸŸæ·»åŠ ç•ªèŒ„é’Ÿç»Ÿè®¡
    pomodoro_frame = ttk.LabelFrame(right_frame, text="ä¸“æ³¨æ•°æ®", style="Report.TLabelframe")
    pomodoro_frame.pack(fill="both", expand=True, pady=10)
    
    c.execute("SELECT * FROM pomodoro_records")
    pomo_data = c.fetchone()
    conn.commit()

    # å¡ç‰‡å¼å¸ƒå±€
    pomo_grid = ttk.Frame(pomodoro_frame)
    pomo_grid.pack(padx=10, pady=10, fill='both', expand=True)
    
    def format_duration(minutes):
        if minutes >= 60:
            return f"{minutes/60:.2f} å°æ—¶"
        return f"{minutes:.2f} åˆ†é’Ÿ"

    metrics = [
        ("ğŸ… ä¸“æ³¨æ¬¡æ•°", pomo_data[0] or 0, "#1cc88a"),
        ("â³ æ€»æ—¶é•¿", 
        format_duration(round(pomo_data[1], 2)) if pomo_data[1] else "0 åˆ†é’Ÿ", 
        "#4e73df"),
        ("â±ï¸ å¹³å‡æ—¶é•¿", 
        format_duration(round(pomo_data[1]/(pomo_data[0] or 1), 2)) if pomo_data[1] else "0 åˆ†é’Ÿ", 
        "#f6c23e")
    ]
    
    for i, (title, value, color) in enumerate(metrics):
        card = ttk.Frame(pomo_grid, relief="groove", borderwidth=1)
        card.grid(row=0, column=i, padx=5, pady=5, sticky="nsew")
        
        ttk.Label(card, text=title, style="Report.TLabel").pack(pady=5)
        ttk.Label(card, text=str(value), 
                 font=("Microsoft YaHei", 14, "bold"), 
                 foreground=color).pack(pady=5)
    
    # å¸ƒå±€è°ƒæ•´
    for i in range(3):
        pomo_grid.columnconfigure(i, weight=1)

    # å¸ƒå±€æƒé‡é…ç½®
    main_frame.columnconfigure(0, weight=2)
    main_frame.columnconfigure(1, weight=2)
    main_frame.rowconfigure(0, weight=1)

    # çª—å£å…³é—­å¤„ç†
    def close_window():
        plt.close('all')
        progress_window.destroy()
    
    progress_window.protocol("WM_DELETE_WINDOW", close_window)

def open_about():
    about_window = tk.Toplevel(root)
    about_window.title("å…³äº")
    about_window.geometry("1200x800")
    about_window.transient(root)
    about_window.grab_set()
    
    # ========== ä¸»å®¹å™¨ ==========
    main_frame = ttk.Frame(about_window)
    main_frame.pack(fill='both', expand=True, padx=20, pady=20)

    # ========== æ ‡é¢˜åŒº ==========
    header_frame = ttk.Frame(main_frame)
    header_frame.pack(fill='x', pady=10)
    
    # åº”ç”¨æ ‡é¢˜å±…ä¸­
    ttk.Label(header_frame, 
             text="å­¦ç¿¼ - TaskWing", 
             font=("Microsoft YaHei", 24, "bold"),
             foreground="#4fb9fe").pack(side='left', padx=25)
    
    # å½“å‰ç‰ˆæœ¬ç§»åˆ°å·¦ä¾§
    ttk.Label(header_frame, 
             text=Version,
             font=("Microsoft YaHei", 12),
             foreground="#666").pack(side='left', padx=10)
    
    # æ£€æŸ¥æ›´æ–°æŒ‰é’®åœ¨å³ä¾§
    ttk.Button(header_frame,
              text="ğŸ”„ æ£€æŸ¥æ›´æ–°",
              command=lambda:version_judge(about_window),
              style='Accent.TButton').pack(side='right', padx=20)

    # ========== æ ¸å¿ƒå†…å®¹åŒº ==========
    content_frame = ttk.Frame(main_frame)
    content_frame.pack(fill='both', expand=True)

    pane = ttk.PanedWindow(content_frame, orient=tk.HORIZONTAL)
    pane.pack(fill='x', expand=True, padx=25, pady=10)

    # åŠŸèƒ½åˆ—è¡¨
    features_frame = ttk.LabelFrame(pane, 
                                  text="æ ¸å¿ƒåŠŸèƒ½", 
                                  padding=10,
                                  style="Large.TLabelframe")
    features_frame.pack(fill='x', padx=10, pady=5, side='left', expand=True)
    features = """âœ“ ä»»åŠ¡ç®¡ç†ä¸æé†’
âœ“ æ™ºèƒ½å­¦ä¹ è¿›åº¦è·Ÿè¸ª
âœ“ ç•ªèŒ„é’Ÿä¸“æ³¨è®¡æ—¶
âœ“ æ•°æ®å¯è§†åŒ–ç»Ÿè®¡
âœ“ AIåœ¨çº¿ä¸“ä¸šè§£ç­”
âœ“ å¤šä¸»é¢˜ç•Œé¢é€‚é…
âœ“ ç³»ç»Ÿæ‰˜ç›˜å¸¸é©»è¿è¡Œ
âœ“ å¼€æœºè‡ªå¯åŠ¨è®¾ç½®"""
    ttk.Label(features_frame, 
             text=features,
             font=("Microsoft YaHei", 11),
             justify="left").pack(anchor='w')
    pane.add(features_frame)
    
    tips_frame = ttk.LabelFrame(pane,
                                  text="ä½¿ç”¨æŠ€å·§ & å¸¸è§é—®é¢˜",
                                  padding=10,
                                  style="Large.TLabelframe")
    tips_frame.pack(fill='x', padx=10, pady=5, side='right', expand=True)
    tips = """ã€é«˜çº§æŠ€å·§ã€‘
Â· åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­åŒå‡»ä»»åŠ¡å¯å¿«é€Ÿè¿›å…¥ä¿®æ”¹é¡µé¢ã€‚
Â· åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­å³é”®ä»»åŠ¡å¯å”¤å‡ºå³é”®èœå•ã€‚
Â· åœ¨æ·»åŠ /ä¿®æ”¹ä»»åŠ¡é¡µé¢ï¼Œé€‰ä¸­è¾“å…¥æ¡†ï¼Œå¯æŒ‰ Enter å¿«é€Ÿæäº¤ã€‚
Â· ã€AIæ™ºç­”ã€‘è¾“å…¥æ¡†å¯ä½¿ç”¨ Enter å¿«é€Ÿå‘é€ï¼ŒCtrl/Shift + Enter æ¢è¡Œï¼Œä¸”æ”¯æŒæ’¤é”€/æ¢å¤æ“ä½œã€‚
Â· å¯åŒæ—¶å¼€å¯å¤šä¸ªã€ç•ªèŒ„é’Ÿã€‘è®¡æ—¶ã€‚
Â· ä¸»é¡µå¯åœ¨å³ä¸Šè§’é€‰æ‹©æ˜¯å¦ç½®é¡¶ã€‚
Â· ã€ç•ªèŒ„é’Ÿã€‘è®¡æ—¶çª—å£å¯åœ¨å·¦ä¸‹è§’é€‰æ‹©æ˜¯å¦ç½®é¡¶ã€‚


ã€å¸¸è§é—®é¢˜ Q&Aã€‘
Qï¼šä¸ºä»€ä¹ˆæˆ‘çš„â€œAIæ™ºç­”â€å‘é€é—®é¢˜åä¼šæœ‰é”™è¯¯å¼¹çª—ï¼Ÿ
Aï¼šè¿™æ˜¯å› ä¸ºæœåŠ¡å•†å‡ºç°äº†é—®é¢˜ï¼Œæœ‰æ—¶å€™æ˜¯å› ä¸ºç½‘ç»œç¹å¿™ã€‚æ¨èåœ¨â€œAIæ™ºç­”â€çš„è®¾ç½®ä¸­æŒ‰ç…§æ•™ç¨‹é…ç½®è‡ªå·±çš„APIã€‚

Qï¼šä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¸‹è½½æ›´æ–°æ—¶ä¼šå‡ºç°é”™è¯¯ï¼Ÿ
Aï¼šè‹¥ä¸æ˜¯æ‰‹åŠ¨å…³é—­çª—å£çš„è¯ï¼Œå°±æ˜¯æœåŠ¡ç«¯çš„é—®é¢˜ã€‚ç”±äºæœ¬æ›´æ–°æœåŠ¡ä¾èµ–GitHubï¼Œå› æ­¤å¯èƒ½ä¼šå‡ºç°ç½‘ç»œé—®é¢˜ã€‚æ‚¨ä¹Ÿå¯ä»¥å°è¯•åœ¨ã€å…³äºã€‘â€”ã€GitHub é¡¹ç›®é¡µã€‘æ‰‹åŠ¨ä¸‹è½½æ›´æ–°åŒ…ï¼Œç„¶åæ‰‹åŠ¨å®‰è£…ã€‚

Qï¼šä¸ºä»€ä¹ˆæˆ‘çš„â€œAIæ™ºç­”â€å‘é€é—®é¢˜åä¼šæœ‰é”™è¯¯å¼¹çª—ï¼Ÿ
Aï¼šè¿™æ˜¯å› ä¸ºæœåŠ¡å•†å‡ºç°äº†é—®é¢˜ï¼Œæœ‰æ—¶å€™æ˜¯å› ä¸ºç½‘ç»œç¹å¿™ã€‚æ¨èåœ¨ã€AIæ™ºç­”ã€‘â€”ã€è®¾ç½®ã€‘ä¸­æŒ‰ç…§æ•™ç¨‹é…ç½®ç§æœ‰APIï¼Œæ›´åŠ ç¨³å®šã€‚

Qï¼šä¸ºä»€ä¹ˆâ€œç»Ÿè®¡æŠ¥å‘Šâ€æ˜¾ç¤ºä¸å…¨ï¼Ÿ
Aï¼šè¿™ä¸æ˜¯ç¨‹åºé—®é¢˜ï¼Œæ˜¯å› ä¸ºæ‚¨å½“å‰æ²¡æœ‰å…¶ä»–æ•°æ®å¯æ˜¾ç¤ºã€‚

Qï¼šä¸ºä»€ä¹ˆæˆ‘çš„â€œç»Ÿè®¡æŠ¥å‘Šâ€æœ‰äº›æ•°æ®ä¸€ç›´æ˜¯0ï¼Ÿ
Aï¼šå¯èƒ½æ˜¯æ‚¨çš„æ•°æ®åº“å‡ºç°äº†é—®é¢˜ã€‚å¯åœ¨é¦–é¡µç‚¹å‡»â€œè®¾ç½®â€ï¼Œå¹¶åœ¨â€œé«˜çº§æ“ä½œâ€ä¸­ç‚¹å‡»â€œåˆ é™¤æ‰€æœ‰æ•°æ®â€ä»¥é‡ç½®æ•°æ®åº“ã€‚

Qï¼šä¸ºä»€ä¹ˆæœ‰çš„ä»»åŠ¡å‰©ä½™å¤©æ•°æ˜¯è´Ÿæ•°ï¼Ÿ
Aï¼šå› ä¸ºæ‚¨é‚£ä¸ªä»»åŠ¡è¿‡æœŸäº†ã€‚

Qï¼šä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¸“æ³¨åæ²¡æœ‰å¼¹å‡ºä»»åŠ¡å®Œæˆçš„æç¤ºçª—å£ï¼Ÿ
Aï¼šå› ä¸ºæ‚¨é€‰æ‹©çš„ä»»åŠ¡å·²ç»å®Œæˆäº†ã€‚"""
    # æ»šåŠ¨æ¡å®¹å™¨
    scroll_container = ttk.Frame(tips_frame)
    scroll_container.pack(fill='both', expand=True)
    
    # å‚ç›´æ»šåŠ¨æ¡
    scrollbar = ttk.Scrollbar(scroll_container)
    scrollbar.pack(side='right', fill='y')
    
    # æ–‡æœ¬æ¡†é…ç½®
    tips_text = tk.Text(
        scroll_container,
        wrap=tk.WORD,
        yscrollcommand=scrollbar.set,
        font=("Microsoft YaHei", 11),
        padx=10,
        pady=10,
        height=9
    )
    tips_text.pack(fill='both', expand=True)
    scrollbar.config(command=tips_text.yview)

    # æ’å…¥å¸¦æ ¼å¼çš„å†…å®¹
    tips_text.insert(tk.END, tips)  # ä¼˜åŒ–é—®é¢˜é—´è·
    tips_text.configure(state="disabled")  # è®¾ä¸ºåªè¯»

    pane.add(tips_frame)

    # ========== ä¿¡æ¯åŒº ==========
    info_frame = ttk.Frame(content_frame)
    info_frame.pack(fill='x', expand=True, padx=20, pady=0)

    # å¼€å‘è€…ä¿¡æ¯
    dev_card = ttk.LabelFrame(info_frame, 
                            text="å¼€å‘è€…ä¿¡æ¯", 
                            padding=15,
                            style="Large.TLabelframe")
    dev_card.pack(fill='x', padx=5, pady=5, side='left', expand=True)
    ttk.Label(dev_card,
             text="å¼€å‘è€…ï¼šTiantianYZJ\nEmailï¼šyzjtiantian@126.com",
             font=("Microsoft YaHei", 10),
             justify="left").pack(anchor='w')

    # ========== åº•éƒ¨ä¿¡æ¯åŒº ==========
    statement_frame = ttk.LabelFrame(info_frame, 
                            text="å£°æ˜", 
                            padding=15,
                            style="Large.TLabelframe")
    statement_frame.pack(fill='x', padx=5, pady=5, side='right', expand=True)
    
    # å¼€æºåè®®
    ttk.Label(statement_frame,
             text="å­¦ç¿¼ éµå¾ª GNU General Public License v3.0 å¼€æºåè®®",
             font=("Microsoft YaHei", 10),
             justify="left").pack(anchor='w')
    
    # å›¾æ ‡ç‰ˆæƒ
    ttk.Label(statement_frame,
             text="éƒ¨åˆ†å›¾æ ‡æ¥æºäºé˜¿é‡Œå·´å·´çŸ¢é‡å›¾æ ‡åº“ï¼Œå¦‚æœ‰ä¾µæƒè¯·è”ç³»åˆ é™¤",
             font=("Microsoft YaHei", 10),
             justify="left").pack(anchor='w')

    # ========== æ›´æ–°æ—¥å¿—åŒº ==========
    changelog_frame = ttk.LabelFrame(main_frame, 
                                   text="æ›´æ–°æ—¥å¿—", 
                                   padding=10,
                                   style="Large.TLabelframe")
    changelog_frame.pack(fill='both', expand=True, pady=5, padx=25)
    
    # æ»šåŠ¨æ¡å®¹å™¨
    scroll_container = ttk.Frame(changelog_frame)
    scroll_container.pack(fill='both', expand=True)
    
    # æ»šåŠ¨æ¡å’Œæ–‡æœ¬æ¡†
    scrollbar = ttk.Scrollbar(scroll_container)
    scrollbar.pack(side='right', fill='y')
    
    changelog_text = tk.Text(
        scroll_container,
        wrap="word",
        yscrollcommand=scrollbar.set,
        font=("Microsoft YaHei", 10),
        height=8
    )
    changelog_text.pack(side='left', fill='both', expand=True)
    scrollbar.config(command=changelog_text.yview)
    
    # æ’å…¥æ—¥å¿—å†…å®¹
    for entry in reversed(CHANGELOG):
        changelog_text.insert("end", f"â€¢ {entry}\n")
    changelog_text.configure(state="disabled")

    # ========== æ“ä½œæŒ‰é’®åŒº ==========
    btn_frame = ttk.Frame(main_frame)
    btn_frame.pack(pady=10)
    
    ttk.Button(btn_frame, 
              text="â­ GitHub é¡¹ç›®é¡µ",
              command=lambda: webbrowser.open_new("https://github.com/TiantianYZJ/TaskWing")
              ).pack(side='left', padx=10)
    Tooltip(btn_frame.winfo_children()[0], "ç‚¹å‡»å‰å¾€ GitHub é¡¹ç›®é¡µï¼ˆhttps://github.com/TiantianYZJ/TaskWingï¼‰")
    
    ttk.Button(btn_frame,
              text="å…³é—­",
              style='Accent.TButton',
              command=about_window.destroy).pack(side='right', padx=10)

# ============== è®¾ç½®ç•Œé¢ ==============
def open_settings():
    setting_window = tk.Toplevel(root)
    setting_window.title("è®¾ç½®")
    setting_window.geometry("500x500")
    setting_window.resizable(False, False)
    
    # ========== ä¸»é¢˜è®¾ç½® ==========
    theme_frame = ttk.LabelFrame(setting_window, text="ç•Œé¢è®¾ç½®", padding=10, style="Large.TLabelframe")
    theme_frame.pack(fill="x", padx=10, pady=5)
    
    c.execute("SELECT theme_choice FROM theme_settings")
    current_theme = c.fetchone()[0]
    
    theme_var = tk.StringVar(value=current_theme)
    ttk.Label(theme_frame, text="ä¸»é¢˜æ¨¡å¼:").grid(row=0, column=0, sticky="w")
    theme_combobox = ttk.Combobox(
        theme_frame,
        textvariable=theme_var,
        values=["æµ…è‰²æ¨¡å¼", "æ·±è‰²æ¨¡å¼", "è·Ÿéšç³»ç»Ÿ", "è‡ªåŠ¨åˆ‡æ¢"],
        state="readonly",
        width=15
    )
    theme_combobox.grid(row=0, column=1, padx=5)

    # ========== è‡ªå¯åŠ¨è®¾ç½® ==========
    autostart_frame = ttk.LabelFrame(setting_window, text="å¼€æœºè‡ªå¯åŠ¨", padding=10, style="Large.TLabelframe")
    autostart_frame.pack(fill="x", padx=10, pady=10)

    def get_startup_folder():
        """è·å–ç³»ç»Ÿè‡ªå¯åŠ¨æ–‡ä»¶å¤¹è·¯å¾„"""
        startup_path = os.path.join(
            os.path.expanduser('~'),
            'AppData',
            'Roaming',
            'Microsoft',
            'Windows',
            'Start Menu',
            'Programs',
            'Startup'
        )
        return startup_path if os.path.exists(startup_path) else None

    def open_startup_folder():
        """æ‰“å¼€è‡ªå¯åŠ¨ç›®å½•"""
        startup_path = get_startup_folder()
        if startup_path:
            os.startfile(startup_path)
        else:
            messagebox.showerror("é”™è¯¯", "æ‰¾ä¸åˆ°è‡ªå¯åŠ¨ç›®å½•", parent=setting_window)
    
    def create_autostart_shortcut():
        if getattr(sys, 'frozen', False):
            target_path = sys.executable
        else:
            target_path = os.path.abspath(sys.argv[0])
        
        startup_folder = winshell.startup()
        shortcut_path = os.path.join(startup_folder, "å­¦ç¿¼.lnk")
        
        try:
            if os.path.exists(shortcut_path):
                if not messagebox.askyesno("ç¡®è®¤", "å·²å­˜åœ¨æ—§ç‰ˆæœ¬æˆ–å·²æ·»åŠ è¿‡çš„å¿«æ·æ–¹å¼ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ", parent=setting_window):
                    return
                
            winshell.CreateShortcut(
                Path=shortcut_path,
                Target=target_path,
                Icon=(target_path, 0),
                Description="å­¦ç¿¼"
            )
            messagebox.showinfo("æˆåŠŸ", "å¼€æœºè‡ªå¯åŠ¨é…ç½®æˆåŠŸï¼", parent=setting_window)
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"é…ç½®å¤±è´¥ï¼š{str(e)}", parent=setting_window)

    # åˆ é™¤
    def delete_autostart_shortcut():
        shortcut_path = os.path.join(winshell.startup(), "å­¦ç¿¼.lnk")
        
        try:
            if os.path.exists(shortcut_path):
                os.remove(shortcut_path)
                messagebox.showinfo("æˆåŠŸ", "å·²å–æ¶ˆå¼€æœºè‡ªå¯åŠ¨", parent=setting_window)
            else:
                messagebox.showinfo("æç¤º", "æ‚¨æ²¡æœ‰é…ç½®è¿‡å¼€æœºè‡ªå¯åŠ¨", parent=setting_window)
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å–æ¶ˆå¤±è´¥ï¼š{str(e)}", parent=setting_window)

    # æ“ä½œæŒ‰é’®
    ttk.Button(
        autostart_frame,
        text="âš¡ è‡ªåŠ¨é…ç½®",
        command=create_autostart_shortcut,
        width=13
    ).grid(row=0, column=1, padx=5, pady=5)
    Tooltip(autostart_frame.winfo_children()[0], "è®¾ç½®å¼€æœºè‡ªå¯åŠ¨")

    ttk.Button(
        autostart_frame,
        text="âŒ å–æ¶ˆé…ç½®",
        command=delete_autostart_shortcut,
        width=13
    ).grid(row=0, column=2, padx=5, pady=5)
    Tooltip(autostart_frame.winfo_children()[1], "å–æ¶ˆå¼€æœºè‡ªå¯åŠ¨")
    
    # ========== é€šçŸ¥ç®¡ç†è®¾ç½® ==========
    notify_frame = ttk.LabelFrame(setting_window, text="é€šçŸ¥ç®¡ç†", padding=15, style="Large.TLabelframe")
    notify_frame.pack(pady=10, fill='x', padx=10)  # æ”¾åœ¨æ˜¾ç¤ºè®¾ç½®ä¹‹å‰

    # è·å–å½“å‰é€šçŸ¥è®¾ç½®
    c.execute("SELECT enable_notifications, check_updates FROM notice_settings")
    result = c.fetchone()
    notify_enabled, check_update = result if result else (1, 1)

    global notify_var, update_var
    notify_var = tk.IntVar(value=notify_enabled)
    update_var = tk.IntVar(value=check_update)

    # é€šçŸ¥å¼€å…³
    ttk.Checkbutton(notify_frame,
                   text="å¼€å¯ç³»ç»Ÿé€šçŸ¥",
                   variable=notify_var).pack(anchor="w")

    # æ›´æ–°æ£€æŸ¥å¼€å…³
    ttk.Checkbutton(notify_frame,
                   text="å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥æ›´æ–°",
                   variable=update_var).pack(anchor="w")


    danger_frame = ttk.LabelFrame(setting_window, text="é«˜çº§é€‰é¡¹", padding=10, style="Large.TLabelframe")
    danger_frame.pack(pady=10, fill='x', padx=10)
    
    def delete_all_data():
        # äºŒçº§ç¡®è®¤
        if not messagebox.askokcancel(
            "è­¦å‘Š", 
            "æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ä»¥ä¸‹æ‰€æœ‰æ•°æ®ï¼š\n"
            "â€¢ æ‰€æœ‰ä»»åŠ¡æ•°æ®\nâ€¢ ç´¯è®¡ä»»åŠ¡æ•°\nâ€¢ ä¿å­˜çš„ä¸»é¢˜è®¾ç½®\nâ€¢ ä¿å­˜çš„AIæ™ºç­”è®¾ç½®\nâ€¢ ç•ªèŒ„é’Ÿç»Ÿè®¡è®°å½•\n"
            "è¯·æ³¨æ„ï¼Œè¯¥æ“ä½œä¸å¯æ’¤é”€ï¼"
        ):
            return
            
        # ä¸‰çº§éªŒè¯
        verification_code = ''.join(random.choices('ABCDEFGHJKMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz123456789', k=6))
        user_input = simpledialog.askstring(
            "æœ€åç¡®è®¤", 
            f"è¯·è¾“å…¥ä¸‹æ–¹éªŒè¯ç ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ä»¥ç¡®è®¤åˆ é™¤\néªŒè¯ç ï¼š{verification_code}\n"
            "è¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®ä¸”æ— æ³•æ¢å¤ï¼Œè¯·ä¸‰æ€ï¼\n",
            parent=setting_window
        )
        
        if user_input == verification_code:
            # æ‰§è¡Œåˆ é™¤æ“ä½œ
            tables = ['tasks', 'task_counter', 'theme_settings', 'ai_settings', 'pomodoro_records']
            for table in tables:
                c.execute(f"DELETE FROM {table}")
            
            # é‡ç½®é»˜è®¤è®¾ç½®
            c.execute("INSERT INTO theme_settings VALUES (1, 'è·Ÿéšç³»ç»Ÿ')")
            c.execute("INSERT INTO task_counter (total_tasks) VALUES (0)")
            c.execute("INSERT INTO notice_settings (enable_notifications, check_updates) VALUES (1, 1)")
            c.execute("INSERT INTO ai_settings (api_key, default_model, provider, display_mode) VALUES ('', 'deepseek-chat', 'Deepseek', 'window')")
            conn.commit()
            
            # æ›´æ–°ç•Œé¢
            update_task_list()
            theme_var.set('è·Ÿéšç³»ç»Ÿ')
            set_theme('è·Ÿéšç³»ç»Ÿ')
            messagebox.showinfo("å®Œæˆ", "æ‰€æœ‰æ•°æ®å·²æˆåŠŸåˆ é™¤", parent=setting_window)
        else:
            messagebox.showwarning("å–æ¶ˆ", "éªŒè¯ç ä¸åŒ¹é…ï¼Œåˆ é™¤æ“ä½œå·²å–æ¶ˆ", parent=setting_window)

    # æ‰“å¼€æ•°æ®åº“ç›®å½•æŒ‰é’®
    ttk.Button(
        danger_frame,
        text="ğŸ“‚ æŸ¥çœ‹æ•°æ®åº“ç›®å½•",
        command=lambda: os.startfile(user_data_dir)
    ).pack(side='left', pady=5, padx=5)
    Tooltip(danger_frame.winfo_children()[0], "æ‰“å¼€æ•°æ®åº“æ‰€åœ¨ç›®å½•ï¼ˆâš ï¸ç¨‹åºè¿è¡Œæ—¶ç¦æ­¢åˆ é™¤æˆ–é‡å‘½åæ•°æ®åº“ï¼‰")

    
    ttk.Button(
        danger_frame,
        text="ğŸ“‚ æŸ¥çœ‹è‡ªå¯åŠ¨ç›®å½•",
        command=open_startup_folder,
    ).pack(side='left', pady=5, padx=5)
    Tooltip(danger_frame.winfo_children()[1], "æ‰“å¼€è‡ªå¯åŠ¨æ‰€åœ¨ç›®å½•")

    ttk.Button(
        danger_frame,
        text="âš ï¸ åˆ é™¤æ‰€æœ‰æ•°æ®",
        command=delete_all_data,
        style="Danger.TButton"
    ).pack(side='left', pady=5, padx=5)
    Tooltip(danger_frame.winfo_children()[2], "âš ï¸åˆ é™¤æ‚¨ä¿å­˜çš„æ‰€æœ‰æ•°æ®âš ï¸")

    # å®šä¹‰å±é™©æŒ‰é’®æ ·å¼
    style.configure("Danger.TButton", foreground="orange", background="#dc3545", font=("Microsoft YaHei", 10, "bold"))

    # ========== ä¿å­˜æŒ‰é’® ==========
    btn_frame = ttk.Frame(setting_window)
    btn_frame.pack(pady=10)

    def save_settings():
        set_theme(theme_var.get())
        c.execute("UPDATE notice_settings SET enable_notifications=?, check_updates=?",
            (notify_var.get(), update_var.get()))
        conn.commit()
        setting_window.destroy()

    ttk.Button(btn_frame, text="ğŸ’¾ ä¿å­˜", command=save_settings, width=12).grid(row=0, column=0, padx=5)
    ttk.Button(btn_frame, text="â†©ï¸ å…³é—­", command=setting_window.destroy, width=12).grid(row=0, column=1, padx=5)

    setting_window.transient(root)
    setting_window.grab_set()
    
# ============== AIæ™ºç­”ç•Œé¢ ==============
def open_ai_assistant(parent):
    ai_window = tk.Toplevel(parent)
    ai_window.title("AIæ™ºç­”")
    ai_window.geometry("1100x800")
    
    # è·å–å½“å‰ä¸»é¢˜é¢œè‰²
    text_bg = judge_theme(1)
    text_fg = judge_theme(2)

    # é…ç½®æ ·å¼
    style = ttk.Style()
    style.configure("AIT.TFrame", background=text_bg)
    style.configure("Model.TButton", font=("Microsoft YaHei", 10), padding=5, width=18)
    style.configure("TFrame", bordercolor="#ced4da", lightcolor="#e9ecef", darkcolor="#dee2e6")
    
    main_frame = ttk.Frame(ai_window, padding=10)
    main_frame.pack(fill="both", expand=True)
    
    # å“åº”æ˜¾ç¤ºåŒºåŸŸ
    response_frame = ttk.LabelFrame(main_frame, 
                                  text="AI å›å¤",
                                  padding=5,
                                  style="Large.TLabelframe")
    response_frame.pack(fill="both", expand=True, pady=10)

    # ä½¿ç”¨ç°ä»£æ»šåŠ¨æ¡å’Œè¾¹æ¡†
    response_container = ttk.Frame(response_frame, borderwidth=1, relief="solid")
    response_container.pack(fill="both", expand=True, padx=5, pady=5)

    # é…ç½®æ»šåŠ¨æ¡
    response_scroll = ttk.Scrollbar(response_container)
    response_scroll.pack(side="right", fill="y")

    # ç°ä»£HTMLæ˜¾ç¤ºåŒºåŸŸ
    html_label = HTMLLabel(
        response_container,
        background=text_bg,
        html='<div style="padding: 12px"></div>',  # æ·»åŠ åˆå§‹å†…è¾¹è·
        borderwidth=0,
        highlightthickness=0
    )
    html_label.pack(fill="both", expand=True, padx=2)
    response_scroll.config(command=html_label.yview)

    # æ·»åŠ é˜´å½±æ•ˆæœï¼ˆéœ€è¦å…ˆåœ¨æ ·å¼é…ç½®ä¸­æ·»åŠ ï¼‰
    style.configure("Response.TFrame", 
                   bordercolor="#e9ecef",
                   lightcolor="#f8f9fa",
                   darkcolor="#dee2e6")

    # è¾“å…¥åŒºåŸŸ
    input_frame = ttk.Frame(main_frame)
    input_frame.pack(fill="x", pady=10)

    # ä½¿ç”¨ttké£æ ¼æ»šåŠ¨æ¡
    input_scroll = ttk.Scrollbar(input_frame)
    input_scroll.pack(side="right", fill="y")

    # ä½¿ç”¨ttké£æ ¼è¾“å…¥æ¡†ï¼ˆéœ€è¦é…åˆFrameæ¨¡æ‹Ÿç°ä»£è¾“å…¥æ¡†ï¼‰
    input_container = ttk.Frame(input_frame, borderwidth=1, relief="solid")
    input_container.pack(fill="x", expand=True)

    input_text = tk.Text(
        input_container, 
        height=6,  # å¢åŠ é«˜åº¦
        wrap="word",
        font=("Microsoft YaHei", 12),
        yscrollcommand=input_scroll.set,
        bg=text_bg,
        fg=text_fg,
        insertbackground=text_fg,
        padx=8,  # å¢åŠ å†…è¾¹è·
        pady=8,
        relief="flat",  # å»é™¤é»˜è®¤è¾¹æ¡†
        highlightthickness=0,  # éšè—é«˜äº®è¾¹æ¡†
        undo=True,  # å¯ç”¨æ’¤é”€åŠŸèƒ½
        autoseparators=True,  # è‡ªåŠ¨æ’å…¥æ’¤é”€åˆ†éš”ç¬¦
        maxundo=-1  # æ— é™æ’¤é”€æ­¥éª¤
    )
    input_text.pack(fill="both", expand=True)

    # é”®ç›˜äº‹ä»¶ç»‘å®š
    def handle_keypress(event):
        # æ’¤é”€/æ¢å¤æ“ä½œ
        if event.state & 0x0004:  # Ctrl é”®
            if event.keysym == 'z':
                input_text.edit_undo()
                return "break"
            elif event.keysym == 'y':
                input_text.edit_redo()
                return "break"

        # Enterå‘é€ï¼ŒCtrl/Shift+Enteræ¢è¡Œ
        if event.keysym == 'Return' and not (event.state & 0x0005):  # 0x0004(Ctrl) | 0x0001(Shift)
            send_message()
            return "break"
        elif event.keysym == 'Return' and (event.state & 0x0005):
            input_text.insert(tk.INSERT, '\n')
            return "break"
    
    input_text.bind("<KeyPress>", handle_keypress)

    # é…ç½®æ»šåŠ¨æ¡å‘½ä»¤
    input_scroll.config(command=input_text.yview)
    
    # åº•éƒ¨æ§åˆ¶æ 
    control_frame = ttk.Frame(main_frame)
    control_frame.pack(fill="x", pady=5)
    
    # æ¨¡å‹åˆ‡æ¢æŒ‰é’®ï¼ˆå›ºå®šå®½åº¦ï¼‰
    model_var = tk.StringVar(value="deepseek-chat")
    
    def toggle_model():
        current = model_var.get()
        new_model = "deepseek-reasoner" if current == "deepseek-chat" else "deepseek-chat"
        model_var.set(new_model)
        btn_text = "âœ… æ·±åº¦æ€è€ƒå·²å¼€å¯" if new_model == "deepseek-reasoner" else "âŒ æ·±åº¦æ€è€ƒå·²å…³é—­"
        model_btn.config(text=btn_text)  # ä¿æŒæŒ‰é’®æ–‡æœ¬é•¿åº¦ä¸€è‡´

    model_btn = ttk.Button(
        control_frame,
        text="âŒ æ·±åº¦æ€è€ƒå·²å…³é—­",
        command=toggle_model,
        style="Model.TButton",
        width=18
    )
    model_btn.pack(side="left", padx=5)
    
    # è®¾ç½®æŒ‰é’®
    ttk.Button(
        control_frame,
        text="âš™ è®¾ç½®",
        command=lambda: open_ai_settings(ai_window),
        width=10
    ).pack(side="left", padx=5)

    ttk.Label(control_frame, 
             text="""ï¼ˆEnter å‘é€ï¼ŒCtrl/Shift+Enter æ¢è¡Œï¼‰
æœ¬æœåŠ¡ç”±Deepseekæä¾›æ”¯æŒ Â· ä¸æ”¯æŒè¿ç»­å¯¹è¯ Â· æœ¬åº”ç”¨ä¸å¯¹å›ç­”ç»“æœè´Ÿè´£
é»˜è®¤ä½¿ç”¨å…±äº«API Â· ç”±ä½œè€…è‡ªè´¹ Â· å¯åœ¨ã€è®¾ç½®ã€‘æ›´æ”¹
æœ‰å¤§é‡ä½¿ç”¨éœ€æ±‚çš„ç”¨æˆ·è¯·é…ç½®ç§æœ‰APIï¼Œè°¢è°¢ç†è§£ï¼""",
             font=("Microsoft YaHei", 9),
             foreground="#666666").pack(side="left", padx=5)
    
    # æ–°å¢é™„ä»¶ç›¸å…³ç»„ä»¶
    attachments = {}  # å­˜å‚¨é™„ä»¶ {æ–‡ä»¶å: å†…å®¹}
    
    def add_attachments():
        nonlocal attachments
        if len(attachments) >= 5:
            messagebox.showwarning("æç¤º", "æœ€å¤šæ·»åŠ 5ä¸ªé™„ä»¶", parent=ai_window)
            return
            
        files = filedialog.askopenfilenames(
            parent=ai_window,
            title="é€‰æ‹©é™„ä»¶",
            filetypes=[
                ("æ–‡æœ¬æ–‡ä»¶", "*.txt*;.docx;*.doc;*.md;*.py;*.js;*.html;*.css"),
            ]
        )
        
        for file in files:
            if len(attachments) >=5: break
            try:
                # å¤„ç†Wordæ–‡æ¡£
                # å¤„ç†Wordæ–‡æ¡£ï¼ˆåŒæ—¶æ”¯æŒ.docå’Œ.docxï¼‰
                if file.lower().endswith(('.doc', '.docx')):
                    try:
                        # æ–°ç‰ˆ.docxå¤„ç†
                        if file.lower().endswith('.docx'):
                            doc = Document(file)
                            content = '\n'.join([para.text for para in doc.paragraphs])
                        # æ—§ç‰ˆ.docå¤„ç†
                        else:
                            
                            word = Dispatch('Word.Application')
                            word.visible = False  # åå°è¿è¡Œ
                            doc = word.Documents.Open(file)
                            content = doc.Range().Text
                            doc.Close()
                            word.Quit()
                        
                        attachments[os.path.basename(file)] = content
                        
                    except Exception as e:
                        messagebox.showerror("æ–‡ä»¶è¯»å–é”™è¯¯", 
                            f"æ— æ³•è¯»å–Wordæ–‡æ¡£ï¼š{str(e)}\n"
                            "è¯·ç¡®è®¤ï¼š\n"
                            "1. æ–‡ä»¶æœªè¢«å…¶ä»–ç¨‹åºå ç”¨\n"
                            "2. å·²å®‰è£…Microsoft Word\n"
                            "3. æ–‡ä»¶å†…å®¹æœªè¢«åŠ å¯†", 
                            parent=ai_window)
                        continue
                    
                # å¤„ç†å…¶ä»–æ–‡æœ¬æ–‡ä»¶    
                else:
                    with open(file, 'r', encoding='utf-8', errors='ignore') as f:
                        attachments[os.path.basename(file)] = f.read()
                        
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"è¯»å–æ–‡ä»¶å¤±è´¥ï¼š{str(e)}", parent=ai_window)
        
        # æ›´æ–°é™„ä»¶æ˜¾ç¤ºï¼ˆä¼˜åŒ–é•¿æ–‡ä»¶åæ˜¾ç¤ºï¼‰
        file_names = []
        for name in attachments.keys():
            if len(name) > 100:
                shortened = f"{name[:10]}...{name[-7:]}"
                file_names.append(shortened)
            else:
                file_names.append(name)
        attachments_label.config(text=f"é™„ä»¶ï¼š{', '.join(file_names)}")

    def send_message():
        c.execute("SELECT provider, api_key FROM ai_settings")
        provider, api_key = c.fetchone()

        # æ–°å¢æ¬¡æ•°æ£€æŸ¥é€»è¾‘
        if not api_key:  # ä½¿ç”¨å…±äº«APIçš„æƒ…å†µ
            today = datetime.now().strftime("%Y-%m-%d")
            
            # æŸ¥è¯¢ä½¿ç”¨è®°å½•
            c.execute("SELECT date, count FROM api_usage LIMIT 1")
            record = c.fetchone()
            
            if record:
                record_date, remaining = record
                if record_date != today:  # è·¨å¤©é‡ç½®
                    c.execute("UPDATE api_usage SET date=?, count=4", (today,))
                else:
                    if remaining <= 0:
                        messagebox.showwarning("æ¬¡æ•°å·²ç”¨å°½", "ä»Šæ—¥å…è´¹æ¬¡æ•°å·²ç”¨å°½ï¼Œè¯·é…ç½®ç§æœ‰APIæˆ–æ˜æ—¥å†æ¥", parent=ai_window)
                        return
                    c.execute("UPDATE api_usage SET count=count-1")
                c.execute("SELECT date, count FROM api_usage LIMIT 1")
            else:  # é¦–æ¬¡ä½¿ç”¨
                c.execute("INSERT INTO api_usage VALUES (?, 4)", (today,))
            record = c.fetchone()
            sent_notice("æ‚¨æ­£åœ¨ä½¿ç”¨å…è´¹æ¬¡æ•°", f"ä»Šæ—¥å‰©ä½™æ¬¡æ•°ï¼š{record}æ¬¡\nï¼ˆå…±äº«APIæ¯æ—¥å…è´¹æ¬¡æ•°5æ¬¡ï¼Œä½ å¯å‰å¾€ã€è®¾ç½®ã€‘é…ç½®ç§æœ‰APIï¼‰")
            conn.commit()

        question = input_text.get("1.0", "end").strip()
        global users_question

        # æ‹¼æ¥é™„ä»¶å†…å®¹ï¼ˆä¼˜åŒ–æ ¼å¼ï¼‰
        attachments_content = ""
        if attachments:
            attachments_content = "\n\n*ï¼ˆæ³¨æ„ï¼ä»¥ä¸‹æ˜¯ç”¨æˆ·ä¸Šä¼ çš„é™„ä»¶ï¼Œä¸Šæ–‡æåˆ°çš„æ–‡ä»¶ä¹Ÿè®¸åœ¨è¿™é‡Œï¼Œè¯·ç»¼åˆæ‰€æœ‰å†…å®¹å›ç­”ï¼‰"
            for name, content in attachments.items():
                attachments_content += f"\n\nã€æ–‡ä»¶åï¼š{name}ã€‘\n{content}"
        users_question = question
        
        if not question and not attachments:
            messagebox.showwarning("æç¤º", "é—®é¢˜å’Œé™„ä»¶ä¸èƒ½åŒæ—¶ä¸ºç©º", parent=ai_window)
            return
            
        # æ˜¾ç¤ºæç¤º
        html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;"><p>æ€è€ƒä¸­ï¼Œè¯·ç¨åï¼ˆå› éœ€ç­‰å¾…AIå›ç­”ï¼Œæ‰€ä»¥ç¨‹åºæœªå“åº”å±æ­£å¸¸ç°è±¡ï¼‰</p></div>'
        html_label.set_html(html_text)
        ai_window.update()
        

        if provider == "Deepseek":
            try:
                client = OpenAI(
                    api_key=api_key if api_key else "sk-6fa677012558401e88b54cde791f9822",  # æ›¿æ¢ä¸ºé»˜è®¤API
                    base_url="https://api.deepseek.com"
                )
                
                response = client.chat.completions.create(
                    model=model_var.get(),
                    messages=[{"role": "user", "content": question + attachments_content}],
                    stream=False
                )
                
                c.execute("SELECT display_mode FROM ai_settings")
                display_mode = c.fetchone()[0] or "window"

                completion_tokens = response.usage.completion_tokens
                prompt_tokens = response.usage.prompt_tokens
                total_tokens = response.usage.total_tokens
                # ç”ŸæˆMarkdownå†…å®¹
                markdown = mistune.create_markdown(plugins=['strikethrough', 'footnotes', 'table', 'url', 'task_lists', 'def_list', 'abbr', 'math'])
                thinking_text = "<p>âŒæ·±åº¦æ€è€ƒæœªå¼€å¯ï¼Œä¸è¿›è¡Œæ·±åº¦æ€è€ƒ</p>\n"
                if model_var.get() == "deepseek-reasoner":
                    thinking_text = f"<p>âœ…æ·±åº¦æ€è€ƒå·²å®Œæˆ</p><blockquote>{markdown(response.choices[0].message.reasoning_content)}</blockquote>\n"
                html_content = markdown(f"{response.choices[0].message.content}\n***\nTokenç”¨é‡ç»Ÿè®¡ï¼šç”¨æˆ·æé—®ï¼š{prompt_tokens} Tokensï¼ŒAIå›ç­”ï¼š{completion_tokens} Tokensï¼Œå…±è®¡ï¼š{total_tokens} Tokens")
                print(thinking_text + html_content)

                # æ ¹æ®æ¨¡å¼å¤„ç†æ˜¾ç¤º
                if display_mode == "window":
                    # åŸæœ‰çª—å£æ˜¾ç¤ºé€»è¾‘
                    html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;">{thinking_text + "<p>ï¼ˆä»¥ä¸Šå†…å®¹ä¸ºAIæ€è€ƒè¿‡ç¨‹ï¼Œä¸‹æ–‡ä¸ºæ­£å¼å›ç­”ï¼‰</p>" + html_content + "\n\nï¼ˆAIå›ç­”ä¹±ç /æ ¼å¼ä¸æ­£ç¡®ï¼Ÿåœ¨AIæ™ºç­”ã€è®¾ç½®ã€‘ä¸­å°†ã€AIå›ç­”æ˜¾ç¤ºæ–¹å¼ã€‘æ”¹ä¸ºã€åœ¨æµè§ˆå™¨æ˜¾ç¤ºã€‘å³å¯ï¼ï¼‰"}</div>'
                    html_label.set_html(html_text)
                else:
                    global current_response_html
                    current_response_html = f"""
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
                        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
                        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
                        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/mhchem.min.js"></script>
                        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/copy-tex.min.js"></script>
                        <script>
                            document.addEventListener("DOMContentLoaded", function() {{
                                renderMathInElement(document.querySelector('.markdown-body'), {{
                                    delimiters: [
                                        {{left: '$$', right: '$$', display: true}},
                                        {{left: '$', right: '$', display: false}},
                                        {{left: '\\(', right: '\\)', display: false}},
                                        {{left: '\\[', right: '\\]', display: true}},
                                        {{left: '\\begin{{equation}}', right: '\\end{{equation}}', display: true}}, // æ–°å¢æ–¹ç¨‹ç¯å¢ƒ
                                        {{left: '\\begin{{align}}', right: '\\end{{align}}', display: true}} // æ–°å¢å¯¹é½ç¯å¢ƒ
                                    ],
                                    ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
                                    macros: {{
                                        "\\RR": "\\mathbb{{R}}",
                                        "\\abs": ["\\left|#1\\right|", 1]
                                    }},
                                    throwOnError: false,
                                    strict: 'ignore', // å¿½ç•¥æ— æ³•è§£æçš„å†…å®¹
                                    trust: true, // å¯ç”¨ä¿¡ä»»æ¨¡å¼
                                    fleqn: true // å·¦å¯¹é½å…¬å¼
                                }});
                            }});
                        </script>
                    </head>
                    <body>
                        <div class="markdown-body">
                        {thinking_text + html_content}
                        </div>
                    </body>
                    </html>
                    """

                    webbrowser.open("http://localhost:5000/ai-response")

                    # æ˜¾ç¤ºæç¤º
                    html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;"><p>å›å¤å·²åœ¨æµè§ˆå™¨æ˜¾ç¤º</p></div>'
                    html_label.set_html(html_text)
                    ai_window.update()
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"è¯·æ±‚å¤±è´¥ï¼š{str(e)}", parent=ai_window)
            finally:
                input_text.delete("1.0", "end")
                attachments.clear()
                attachments_label.config(text="")
                c.execute("UPDATE api_usage SET count=count+1")
                sent_notice("é‡åˆ°é”™è¯¯", "å·²è¿”è¿˜1æ¬¡å…è´¹æ¬¡æ•°")
                conn.commit()
        elif provider == "ç¡…åŸºæµåŠ¨":
            api_key=api_key if api_key else "sk-dgxkvpdrkaxvnzhflxeiagetenlhvxsydybqncqwqurejvvf"  # æ›¿æ¢ä¸ºé»˜è®¤API
            url = "https://api.siliconflow.cn/v1/chat/completions"
            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type":"application/json"
            }
            payload = {
                "model": "deepseek-ai/DeepSeek-V3" if model_var.get() == "deepseek-chat" 
                        else "deepseek-ai/DeepSeek-R1",
                "messages": [{"role": "user", "content": question + attachments_content}],
            }
            try:
                response = requests.post(url, headers=headers, json=payload)
                if response.status_code == 200:
                    c.execute("SELECT display_mode FROM ai_settings")

                    display_mode = c.fetchone()[0] or "window"

                    completion_tokens = response.json()['usage']['completion_tokens']
                    prompt_tokens = response.json()['usage']['prompt_tokens']
                    total_tokens = response.json()['usage']['total_tokens']
                    # ç”ŸæˆMarkdownå†…å®¹
                    markdown = mistune.create_markdown(plugins=['strikethrough', 'footnotes', 'table', 'url', 'task_lists', 'def_list', 'abbr', 'math'])
                    thinking_text = "<p>âŒæ·±åº¦æ€è€ƒæœªå¼€å¯ï¼Œä¸è¿›è¡Œæ·±åº¦æ€è€ƒ</p>\n"
                    if model_var.get() == "deepseek-reasoner":
                        thinking_text = f"<p>âœ…æ·±åº¦æ€è€ƒå·²å®Œæˆ</p><blockquote>{markdown(response.json()['choices'][0]['message']['reasoning_content'])}</blockquote>\n"
                    html_content = markdown(f"{response.json()['choices'][0]['message']['content']}\n***\nTokenç”¨é‡ç»Ÿè®¡ï¼šç”¨æˆ·æé—®ï¼š{prompt_tokens} Tokensï¼ŒAIå›ç­”ï¼š{completion_tokens} Tokensï¼Œå…±è®¡ï¼š{total_tokens} Tokens")
                    print(thinking_text + html_content)

                    # æ ¹æ®æ¨¡å¼å¤„ç†æ˜¾ç¤º
                    if display_mode == "window":
                        # åŸæœ‰çª—å£æ˜¾ç¤ºé€»è¾‘
                        html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;">{thinking_text + "<p>ï¼ˆä»¥ä¸Šå†…å®¹ä¸ºAIæ€è€ƒè¿‡ç¨‹ï¼Œä¸‹æ–‡ä¸ºæ­£å¼å›ç­”ï¼‰</p>" + html_content + "\n\nï¼ˆAIå›ç­”ä¹±ç /æ ¼å¼ä¸æ­£ç¡®ï¼Ÿåœ¨AIæ™ºç­”ã€è®¾ç½®ã€‘ä¸­å°†ã€AIå›ç­”æ˜¾ç¤ºæ–¹å¼ã€‘æ”¹ä¸ºã€åœ¨æµè§ˆå™¨æ˜¾ç¤ºã€‘å³å¯ï¼ï¼‰"}</div>'
                        html_label.set_html(html_text)
                    else:
                        current_response_html = f"""
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
                        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
                        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
                        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/mhchem.min.js"></script>
                        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/copy-tex.min.js"></script>
                        <script>
                            document.addEventListener("DOMContentLoaded", function() {{
                                renderMathInElement(document.querySelector('.markdown-body'), {{
                                    delimiters: [
                                        {{left: '$$', right: '$$', display: true}},
                                        {{left: '$', right: '$', display: false}},
                                        {{left: '\\(', right: '\\)', display: false}},
                                        {{left: '\\[', right: '\\]', display: true}},
                                        {{left: '\\begin{{equation}}', right: '\\end{{equation}}', display: true}}, // æ–°å¢æ–¹ç¨‹ç¯å¢ƒ
                                        {{left: '\\begin{{align}}', right: '\\end{{align}}', display: true}} // æ–°å¢å¯¹é½ç¯å¢ƒ
                                    ],
                                    ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
                                    macros: {{
                                        "\\RR": "\\mathbb{{R}}",
                                        "\\abs": ["\\left|#1\\right|", 1]
                                    }},
                                    throwOnError: false,
                                    strict: 'ignore', // å¿½ç•¥æ— æ³•è§£æçš„å†…å®¹
                                    trust: true, // å¯ç”¨ä¿¡ä»»æ¨¡å¼
                                    fleqn: true // å·¦å¯¹é½å…¬å¼
                                }});
                            }});
                        </script>
                    </head>
                    <body>
                        <div class="markdown-body">
                        {thinking_text + html_content}
                        </div>
                    </body>
                    </html>
                    """

                        webbrowser.open("http://localhost:5000/ai-response")

                        # æ˜¾ç¤ºæç¤º
                        html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;"><p>å›å¤å·²åœ¨æµè§ˆå™¨æ˜¾ç¤º</p></div>'
                        html_label.set_html(html_text)
                        ai_window.update()
                else:
                    messagebox.showerror("é”™è¯¯", f"è¯·æ±‚å¤±è´¥ï¼š{response.text}", parent=ai_window)
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"è¯·æ±‚å¼‚å¸¸ï¼š{str(e)}", parent=ai_window)
            finally:
                input_text.delete("1.0", "end")
                attachments.clear()
                attachments_label.config(text="")
                c.execute("UPDATE api_usage SET count=count+1")
                sent_notice("é‡åˆ°é”™è¯¯", "å·²è¿”è¿˜1æ¬¡å…è´¹æ¬¡æ•°")
                conn.commit()

    ttk.Button(
        control_frame,
        text="â¬†ï¸ å‘é€",
        command=send_message,
        style="Accent.TButton"
    ).pack(side="right", padx=5)

    # æ–°å¢æ¸…ç©ºé™„ä»¶æŒ‰é’®
    ttk.Button(
        control_frame,
        text="æ¸…ç©ºé™„ä»¶",
        command=lambda: [attachments.clear(), attachments_label.config(text="")],
        style="Model.TButton",
        width=8
    ).pack(side="right", padx=2)
    Tooltip(control_frame.winfo_children()[4], "æ¸…é™¤å·²æ·»åŠ çš„æ‰€æœ‰é™„ä»¶")

    # é™„ä»¶æ ‡ç­¾å’ŒæŒ‰é’®ï¼ˆæ–°å¢ï¼‰
    attachments_label = ttk.Label(main_frame, text="", foreground="#666")
    attachments_label.pack(side="right", padx=2)
    ttk.Button(
        control_frame,
        text="ğŸ“ æ·»åŠ é™„ä»¶",
        command=add_attachments,
        style="Model.TButton",
        width=10
    ).pack(side="right", padx=5)
    Tooltip(control_frame.winfo_children()[5], "æ”¯æŒæ–‡ä»¶æ ¼å¼ï¼š.docxã€.docã€.txtã€.mdã€.pyã€.jsã€.htmlã€.css")

    
    ai_window.transient(parent)
    ai_window.grab_set()

# ============== AIè®¾ç½®çª—å£ ==============
def open_ai_settings(parent):
    settings_window = tk.Toplevel(parent)
    settings_window.title("AIæ™ºç­”è®¾ç½®")
    settings_window.geometry("900x550")
    
    # ä¸»å®¹å™¨ä½¿ç”¨packå¸ƒå±€
    main_frame = ttk.Frame(settings_window, padding=20)
    main_frame.pack(fill="both", expand=True)
    
    # APIè®¾ç½®æ¡†æ¶
    api_frame = ttk.LabelFrame(main_frame, text="APIè®¾ç½®", padding=15, style="Large.TLabelframe")
    api_frame.pack(fill="x", pady=10)

    # æœåŠ¡å•†é€‰æ‹©æ¡†æ¶
    provider_frame = ttk.LabelFrame(api_frame, text="æœåŠ¡æä¾›å•†", padding=10, style="Large.TLabelframe")
    provider_frame.pack(fill="x", pady=5)
    
    # è·å–å½“å‰è®¾ç½®
    c.execute("SELECT api_key, provider FROM ai_settings")
    api_key, current_provider = c.fetchone()
    
    # æœåŠ¡å•†é€‰æ‹©æ§ä»¶
    provider_var = tk.StringVar(value=current_provider)
    ttk.Label(provider_frame, text="é€‰æ‹©æœåŠ¡å•†:").pack(side="left", padx=5)
    provider_combobox = ttk.Combobox(
        provider_frame,
        textvariable=provider_var,
        values=["Deepseek", "ç¡…åŸºæµåŠ¨"],
        state="readonly",
        width=15
    )
    provider_combobox.pack(side="left", padx=5)
    
    # API Keyè¾“å…¥
    ttk.Label(api_frame, text="API Key:").pack(anchor="w")
    api_entry = ttk.Entry(api_frame)
    api_entry.insert(0, api_key)
    api_entry.pack(fill="x", pady=5, padx=0)
    
    ttk.Label(api_frame, 
             text="ç•™ç©ºå°†ä½¿ç”¨ä½œè€…è‡ªè´¹çš„å…±äº«API\næ¨èé…ç½®ç§æœ‰APIï¼Œè°¢è°¢ç†è§£ï¼",# å› è¿‘æœŸDeepseekå®˜æ–¹APIå…³é—­å……å€¼å…¥å£ï¼Œã€AIæ™ºç­”ã€‘æš‚åœæä¾›Deepseekæ¸ é“çš„å…±äº«APIï¼Œå•ç‹¬é…ç½®è¯¥æ¸ é“ç§æœ‰APIæˆ–ä½¿ç”¨ç¡…åŸºæµåŠ¨å…±äº«APIä¸å—å½±å“\n
             font=("Microsoft YaHei", 9),
             foreground="#666666").pack(anchor="w")
    
    # ========== æ–°å¢é…ç½®æ•™ç¨‹æŒ‰é’®å’Œå†…å®¹ ==========
    def show_api_tutorial():
        webbrowser.open("http://localhost:5000/tutorial")
    
    ttk.Button(
        api_frame,
        text="ğŸ“˜ ç§æœ‰APIé…ç½®æ•™ç¨‹",
        command=show_api_tutorial,
        width=20
    ).pack(pady=10)

    # ========== æ–°å¢å›ç­”è®¾ç½®éƒ¨åˆ† ==========
    display_frame = ttk.LabelFrame(main_frame, text="å›ç­”è®¾ç½®", padding=15, style="Large.TLabelframe")
    display_frame.pack(fill="x", pady=10)

    # è·å–å½“å‰æ˜¾ç¤ºæ¨¡å¼
    c.execute("SELECT display_mode FROM ai_settings")
    current_mode = c.fetchone()[0] or "window"

    # æ˜¾ç¤ºæ–¹å¼ä¸‹æ‹‰æ¡†
    ttk.Label(display_frame, text="AIå›ç­”æ˜¾ç¤ºæ–¹å¼:").pack(side="left", padx=5)
    mode_var = tk.StringVar(value=current_mode)
    mode_combobox = ttk.Combobox(
        display_frame,
        textvariable=mode_var,
        values=["window", "browser"],
        state="readonly",
        width=20
    )
    mode_combobox.pack(side="left", padx=5)
    
    # è®¾ç½®ä¸‹æ‹‰æ¡†æ˜¾ç¤ºæ–‡æœ¬
    mode_combobox.set("åœ¨åŸçª—å£æ˜¾ç¤º" if current_mode == "window" else "åœ¨æµè§ˆå™¨æ˜¾ç¤º")
    mode_combobox.configure(
        values=["åœ¨åŸçª—å£æ˜¾ç¤º", "åœ¨æµè§ˆå™¨æ˜¾ç¤º"],
        validate="key",
        validatecommand=lambda: False
    )

    ttk.Label(display_frame, 
             text="åœ¨åŸçª—å£æ˜¾ç¤ºï¼šæ–¹ä¾¿å¿«æ·ã€‚ä½†ä»…æ”¯æŒIE4å†…æ ¸ï¼Œå› æ­¤æ— æ³•æ¸²æŸ“éƒ¨åˆ†Markdownè¯­æ³•ï¼ˆè¡¨æ ¼ã€ä»£ç å—ç­‰ï¼‰\nåœ¨æµè§ˆå™¨æ˜¾ç¤ºï¼šå°†è°ƒç”¨ç³»ç»Ÿæµè§ˆå™¨ã€‚ä½†å¯æ¸²æŸ“æ‰€æœ‰Markdownè¯­æ³•ï¼Œæ›´åŠ ç°ä»£åŒ–ï¼Œå¯ä¸€é”®å¤åˆ¶ï¼ˆæ¨èï¼‰",
             font=("Microsoft YaHei", 9),
             foreground="#666666").pack(anchor="w")
    
    save_btn = ttk.Button(
        main_frame,
        text="ğŸ’¾ ä¿å­˜è®¾ç½®",
        command=lambda: save_settings(api_entry.get(), provider_var.get()),
        style="Accent.TButton"
    )
    save_btn.pack(pady=15)
    
    def save_settings(key, provider):
        display_mode = "window" if mode_var.get() == "åœ¨åŸçª—å£æ˜¾ç¤º" else "browser"
        c.execute("UPDATE ai_settings SET api_key=?, provider=?, display_mode=?", 
                (key, provider, display_mode))
        conn.commit()
        settings_window.destroy()
    
    settings_window.transient(parent)
    settings_window.grab_set()

# ============== ä¸»çª—å£å¸ƒå±€ ==============
root.grid_rowconfigure(1, weight=1)
root.grid_columnconfigure(0, weight=1)

# é¡¶éƒ¨åŠŸèƒ½åŒº
top_frame = ttk.Frame(root)
top_frame.grid_rowconfigure(0, weight=1)
top_frame.grid_columnconfigure(0, weight=1)
top_frame.grid(row=0, column=0, sticky="nsew")

# ntVarå¯¹è±¡ï¼Œç”¨äºè¿½è¸ªCheckbuttonçš„çŠ¶æ€
topmost_var = tk.IntVar(value=0)
# Checkbuttonæ§ä»¶ï¼Œç”¨äºåˆ‡æ¢çª—å£ç½®é¡¶çŠ¶æ€
toggle_button = ttk.Checkbutton(top_frame, text="çª—å£ç½®é¡¶", variable=topmost_var, onvalue=1, offvalue=0, command=toggle_topmost)
toggle_button.grid(row=0, column=1, sticky="ne")

# ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ
task_frame = ttk.Frame(root)
task_frame.grid_rowconfigure(0, weight=1)
task_frame.grid_columnconfigure(0, weight=1)
task_frame.grid(row=1, column=0, sticky="nsew", padx=20)

style = ttk.Style(task_frame)
style.configure("Treeview.Heading", font=('Microsoft YaHei', 14))
style.configure("Treeview", font=('Microsoft YaHei', 12))
task_list = ttk.Treeview(task_frame, columns=("ID", "ä»»åŠ¡åç§°", "æˆªæ­¢æ—¥æœŸ", "å‰©ä½™å¤©æ•°", "çŠ¶æ€"), show="headings")
task_list.grid_rowconfigure(0, weight=1)
task_list.grid_columnconfigure(0, weight=1)
task_list.grid(row=0, column=0, sticky="nsew")
task_list.column("ID", width=30, anchor='center')
task_list.heading("ID", text="ID")
task_list.column("ä»»åŠ¡åç§°", width=600, anchor='w')
task_list.heading("ä»»åŠ¡åç§°", text="ä»»åŠ¡åç§°")
task_list.column("æˆªæ­¢æ—¥æœŸ", width=100, anchor='center')
task_list.heading("æˆªæ­¢æ—¥æœŸ", text="æˆªæ­¢æ—¥æœŸ")
task_list.column("å‰©ä½™å¤©æ•°", width=80, anchor='center')
task_list.heading("å‰©ä½™å¤©æ•°", text="å‰©ä½™å¤©æ•°")
task_list.column("çŠ¶æ€", width=50, anchor='center')
task_list.heading("çŠ¶æ€", text="çŠ¶æ€")

# ç»‘å®šåŒå‡»äº‹ä»¶
def on_double_click(event):
    if task_list.selection():
        edit_task()
task_list.bind("<Double-1>", on_double_click)

# åˆ›å»ºå³é”®èœå•
context_menu = tk.Menu(root, tearoff=0)
context_menu.add_command(label="ä¿®æ”¹", command=edit_task)
context_menu.add_command(label="åˆ é™¤", command=delete_task)
context_menu.add_command(label="å¤åˆ¶å¹¶ç²˜è´´", command=copy_and_paste_task)
context_menu.add_command(label="ç•ªèŒ„é’Ÿ", command=pomodoro_set_tasks)

def on_right_click(event):
    item = task_list.identify_row(event.y)
    if item:
        task_list.selection_set(item)
        context_menu.post(event.x_root, event.y_root)
        
task_list.bind("<Button-3>", on_right_click)

# æ“ä½œæŒ‰é’®ç»„
edit_button = ttk.Frame(task_frame)
edit_button.grid(row=1, column=0, pady=10, sticky="nsew")

ttk.Button(edit_button, text="ğŸ“ ä¿®æ”¹", command=edit_task, width=10).grid(row=0, column=0, padx=3)
Tooltip(edit_button.winfo_children()[0], "ä¿®æ”¹é€‰å®šä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯")
ttk.Button(edit_button, text="ğŸ—‘ï¸ åˆ é™¤", command=delete_task, width=10).grid(row=0, column=1, padx=3)
Tooltip(edit_button.winfo_children()[1], "æ°¸ä¹…ç§»é™¤é€‰å®šçš„ä»»åŠ¡")
ttk.Button(edit_button, text="ğŸ§¹ æ¸…ç©º", command=confirm_clear_tasks, width=10).grid(row=0, column=2, padx=3)
Tooltip(edit_button.winfo_children()[2], "æ¸…ç©ºå½“å‰ä»»åŠ¡åˆ—è¡¨")
ttk.Button(edit_button, text="ğŸ… ç•ªèŒ„é’Ÿ", command=pomodoro_set_tasks, width=10).grid(row=0, column=3, padx=3)
Tooltip(edit_button.winfo_children()[3], "å¯åŠ¨ç•ªèŒ„é’Ÿä¸“æ³¨è®¡æ—¶å™¨")

# åº•éƒ¨åŠŸèƒ½åŒº
bottom_frame = ttk.Frame(root, padding=10)
bottom_frame.grid(row=2, column=0, sticky="nsew")

# æ·»åŠ ä»»åŠ¡æ¨¡å—
add_task_frame = ttk.LabelFrame(bottom_frame, text="æ–°å»ºä»»åŠ¡", style="Large.TLabelframe", padding=10)
add_task_frame.pack(side="left", padx=10, fill="x", expand=True)

name_frame = ttk.Frame(add_task_frame)
name_frame.grid(row=0, column=0, sticky="w", pady=10)
ttk.Label(name_frame, text="ä»»åŠ¡åç§°:").grid(row=0, column=0, sticky="w")
name_entry = ttk.Entry(name_frame, width=40)
name_entry.grid(row=0, column=1, padx=5)
name_entry.bind("<Return>", lambda e: add_task())

# åˆ›å»ºä¸€ä¸ªæ–°çš„ Frame æ¥æ”¾ç½®æ—¥æœŸé€‰æ‹©çš„ Combobox
date_frame = ttk.Frame(add_task_frame)
date_frame.grid(row=1, column=0, sticky="w", pady=10)

ttk.Label(date_frame, text="æˆªæ­¢æ—¥æœŸ:").grid(row=0, column=0, sticky="w")
date_entry = ttk.Entry(date_frame, width=12, font=('Microsoft YaHei', 9))
date_entry.insert(0, datetime.now().strftime("%Y/%m/%d"))  # é»˜è®¤å½“å‰æ—¥æœŸ
date_entry.grid(row=0, column=1, padx=5)
date_entry.bind("<Return>", lambda e: add_task())

def set_add_date():
    def on_date_select():
        date_entry.delete(0, tk.END)
        date_entry.insert(0, cal.get_date())
        top.grab_release()
        top.destroy()
    
    top = tk.Toplevel(root)
    top.title("é€‰æ‹©æ—¥æœŸ")
    top.resizable(False, False)
    top.transient(root)
    top.grab_set()
    cal = Calendar(top, 
                 selectmode='day',
                 year=datetime.now().year,
                 month=datetime.now().month,
                 day=datetime.now().day,
                 date_pattern='y/mm/dd')
    cal.pack(padx=10, pady=10)
    ttk.Button(top, text="ç¡®å®š", command=on_date_select).pack(pady=5)

ttk.Button(date_frame, text="ğŸ“… é€‰æ‹©", command=set_add_date).grid(row=0, column=2, padx=5)
Tooltip(date_frame.winfo_children()[2], "åœ¨æ—¥å†ä¸­é€‰æ‹©æ—¥æœŸ")
ttk.Button(date_frame, text="â• ç¡®è®¤æ·»åŠ ", command=add_task, width=12).grid(row=0, column=3, padx=5)

# å³ä¾§åŠŸèƒ½æŒ‰é’®
func_btn_frame = ttk.Frame(bottom_frame)
func_btn_frame.pack(side="right", padx=10)

ttk.Button(func_btn_frame, text="ğŸ¤– AIæ™ºç­”", command=lambda:open_ai_assistant(root), width=12).grid(row=0, column=0, pady=2)
Tooltip(func_btn_frame.winfo_children()[0], "ä½¿ç”¨AIè§£ç­”ç–‘æƒ‘")
ttk.Button(func_btn_frame, text="ğŸ“ˆ ç»Ÿè®¡æŠ¥å‘Š", command=show_progress_report, width=12).grid(row=1, column=0, pady=2)
Tooltip(func_btn_frame.winfo_children()[1], "æŸ¥çœ‹å­¦ä¹ æ•°æ®å¯è§†åŒ–æŠ¥å‘Š")
ttk.Button(func_btn_frame, text="âš™ï¸ è®¾ç½®", command=open_settings, width=12).grid(row=2, column=0, pady=2)
Tooltip(func_btn_frame.winfo_children()[2], "ä¿®æ”¹åº”ç”¨è®¾ç½®")
ttk.Button(func_btn_frame, text="â„¹ï¸ å…³äºåº”ç”¨", command=open_about, width=12).grid(row=3, column=0, pady=2)
Tooltip(func_btn_frame.winfo_children()[3], "æŸ¥çœ‹åº”ç”¨ä¿¡æ¯å’Œæ£€æŸ¥æ›´æ–°")

# åˆ›å»ºæ‰˜ç›˜
def on_closing(icon, item):
    icon.stop()
    if (get_num(1) == 0):
        sent_notice("å­¦ç¿¼å·²é€€å‡º", f"ä½ æ²¡æœ‰ä»»ä½•ä»»åŠ¡å“¦")
    else:
        if (get_num(3) > 0):
            sent_notice("å­¦ç¿¼å·²é€€å‡º", f"è®°å¾—å®Œæˆå‰©ä¸‹çš„{get_num(3)}ä¸ªä»»åŠ¡")
        elif (get_num(3) == 0):
            sent_notice("å­¦ç¿¼å·²é€€å‡º", f"å‰å®³ï¼ä½ å®Œæˆäº†æ‰€æœ‰å…±è®¡{get_num(1)}ä¸ªä»»åŠ¡ï¼")
    root.destroy()
    return 0

def on_show():
    root.withdraw()
    icon = create_tray_icon()
    sent_notice("å·²æœ€å°åŒ–åˆ°ä»»åŠ¡æ æ‰˜ç›˜", "å³é”®æ‰˜ç›˜å›¾æ ‡å¹¶é€‰æ‹©ã€æ˜¾ç¤ºã€‘å¯æ¢å¤")
    icon.run()
    return 0

root.protocol("WM_DELETE_WINDOW", on_show)
def on_showing(icon, item):
    icon.stop()
    root.deiconify()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

def open_ai_assistant_window(icon, item):
    icon.stop()
    root.deiconify()
    open_ai_assistant(root)
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

def open_settings_window(icon, item):
    icon.stop()
    root.deiconify()
    open_settings()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

def open_about_window(icon, item):
    icon.stop()
    root.deiconify()
    open_about()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

def open_progress_window(icon, item):
    icon.stop()
    root.deiconify()
    show_progress_report()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

# æ›´æ–°ä»»åŠ¡åˆ—è¡¨
update_task_list()

# æ›´æ–°æ—¶é—´
update_time()

# æ›´æ–°å‰©ä½™å¤©æ•°
update_rest_days()

version_judge(root)

# è¿è¡Œä¸»å¾ªç¯
root.mainloop()

# å…³é—­æ•°æ®åº“è¿æ¥
conn.close()