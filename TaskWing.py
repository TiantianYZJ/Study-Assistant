# å­¦ç¿¼ - æ™ºèƒ½åŒ–å­¦ä¹ ä»»åŠ¡ç®¡ç†å·¥å…·
# Copyright (C) 2025  TiantianYZJ
# 
# å£°æ˜ï¼š
# æœ¬ç¨‹åºéµå¾ªGPLv3åè®®ï¼šæ‚¨å¯ä»¥åœ¨éµå®ˆè®¸å¯è¯æ¡æ¬¾çš„å‰æä¸‹è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘ã€‚
# å®Œæ•´æˆæƒæ¡æ¬¾è¯·å‚è§é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„LICENSEæ–‡ä»¶ã€‚

# æ›´æ–°æ—¥å¿—
Version = "V1.0.7"
CHANGELOG = [
    "V0.0.1-2024.01.19 1ã€â€œå­¦ç¿¼â€æ­£å¼è¯ç”Ÿï¼Œå…·å¤‡ä»£åŠç®¡ç†åŠŸèƒ½",
    "V0.0.2-2024.01.19 1ã€æ·»åŠ ã€ä»»åŠ¡è¿›åº¦æŠ¥å‘Šã€‘ï¼Œç”Ÿæˆé¥¼å›¾æ˜¾ç¤ºä»»åŠ¡å®Œæˆæƒ…å†µ",
    "V0.0.3-2024.01.19 1ã€ç”¨æˆ·ç¾¤ä½“ç»†åˆ†ï¼ŒåŒ…è£…ä¸ºä»»åŠ¡ç®¡ç†è½¯ä»¶ï¼›2ã€å»ºç«‹æ•°æ®åº“ï¼Œå®ç°é‡è¿›æ•°æ®ä¸å—å½±å“ï¼›3ã€å®Œæˆæƒ…å†µä½¿ç”¨æ–‡å­—ï¼ˆå·²å®Œæˆã€æœªå®Œæˆï¼‰",
    "V0.1.0-2024.01.19 1ã€UIç•Œé¢ç„•æ–°ï¼Œæ›´åŠ ç°ä»£åŒ–ï¼›2ã€ä¸»çª—å£é¡¶éƒ¨å¢åŠ æ—¶é—´æ˜¾ç¤ºï¼›3ã€æ·»åŠ æ·±è‰²æ¨¡å¼ï¼Œè‡ªåŠ¨æ ¹æ®æ—¶é—´åˆ‡æ¢",
    "V0.1.1-2024.01.19 1ã€æ¥å…¥WindowsMessage APIï¼Œå®ç°æ¶ˆæ¯ç³»ç»Ÿå±‚çº§æ¨é€",
    "V0.1.2-2024.01.20 1ã€å¢åŠ ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡ï¼Œå®ç°åå°é©»ç•™ï¼›2ã€å®Œæˆæƒ…å†µæ”¹ç”¨å›¾æ ‡",
    "V0.1.4-2024.01.20 1ã€å¢åŠ çª—å£ç½®é¡¶é€‰é¡¹ï¼›2ã€æ–°å¢ã€è®¾ç½®ã€‘ï¼Œå¯æ‰‹åŠ¨é€‰æ‹©ä¸»é¢˜ã€é…ç½®å¼€æœºè‡ªå¯åŠ¨",
    "V0.2.0-2024.01.21 1ã€é¡µé¢å¸ƒå±€é‡æ–°æ’ç‰ˆï¼Œå„åŠŸèƒ½åŒºå—ç•Œçº¿æ›´æ˜æ˜¾ï¼›2ã€ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ å›¾æ ‡ï¼›3ã€ä¸°å¯Œç³»ç»Ÿæ‰˜ç›˜å³é”®èœå•",
    "V0.2.1-2024.01.21 1ã€é€‚é…å¼€å‘ç¯å¢ƒä¸å°è£…ç¯å¢ƒï¼Œè§£å†³æ‰“åŒ….exeåæ— æ³•è°ƒç”¨å¤–éƒ¨èµ„æºçš„é—®é¢˜",
    "V0.2.2-2024.01.22 1ã€ä¼˜åŒ–ã€ç»Ÿè®¡æŠ¥å‘Šã€‘ï¼Œæ•°æ®æ›´ä¸°å¯Œã€æ›´ç›´è§‚ï¼›2ã€æ·»åŠ ã€å…³äºç¨‹åºã€‘é¡µé¢ï¼›3ã€å¼€æœºè‡ªå¯åŠ¨æ”¯æŒä¸€é”®é…ç½®",
    "V0.2.3-2024.01.23 1ã€æ›´æ¢WindowsMessage APIåº“ï¼Œè§£å†³å…¼å®¹æ€§é—®é¢˜",
    "V0.2.4-2024.02.11 1ã€å¢åŠ ã€AIæ™ºç­”ã€‘åŠŸèƒ½ï¼Œæ¥å…¥DeepseekAPIï¼Œæ”¯æŒå•æ¬¡è¯¢é—®ã€è‡ªå®šä¹‰API Keyç­‰åŠŸèƒ½",
    "V0.2.5-2024.02.12 1ã€å®ç°å¯¹AImarkdownæ ¼å¼å›ç­”çš„æ¸²æŸ“",
    "V0.2.6-2024.02.14 1ã€æ–°å¢ã€æ›´æ–°æ—¥å¿—ã€‘ï¼›2ã€ä¼˜åŒ–APIè®¾ç½®ç•Œé¢å¸ƒå±€",
    "V0.2.7-2024.02.14 1ã€å¢åŠ å¯åŠ¨æ¬¢è¿æç¤ºï¼ŒåŒæ—¶æé†’å¾…å®Œæˆä»»åŠ¡é¡¹",
    "V0.2.8-2024.02.15 1ã€ã€AIè®¾ç½®ã€‘æ·»åŠ ã€ç§æœ‰APIé…ç½®æ•™ç¨‹ã€‘ï¼›2ã€ã€AIæ™ºç­”ã€‘æ”¯æŒé€‰æ‹©æœåŠ¡æä¾›å•†",
    "V0.2.9-2024.02.15 1ã€ã€å­¦ä¹ æ•°æ®ç»Ÿè®¡ã€‘ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒæƒ…å†µç»†åˆ†ï¼Œæ›´åŠ ä¸°å¯Œç›´è§‚ï¼›2ã€å¯åŠ¨æ¬¢è¿æç¤ºå¢åŠ å³å°†æˆªæ­¢ã€å·²æˆªæ­¢ä»»åŠ¡æé†’",
    "V0.3.0-2024.02.15 1ã€HTMLæ¸²æŸ“é¡µé¢å…¨é¢é€‚é…æ·±è‰²æ¨¡å¼",
    "V0.3.1-2024.02.15 1ã€ã€AIæ™ºç­”ã€‘æ”¯æŒè®¾ç½®å›ç­”æ˜¾ç¤ºæ–¹å¼ï¼›2ã€ã€APIé…ç½®æ•™ç¨‹ã€‘æ”¹ä¸ºç”¨æµè§ˆå™¨æ‰“å¼€ï¼Œæ›´ç¾è§‚",
    "V0.3.2-2024.02.15 1ã€ã€APIé…ç½®æ•™ç¨‹ã€‘æ›´æ¢æ¸²æŸ“é£æ ¼ï¼Œå“åº”å¼å¸ƒå±€",
    "V0.3.3-2024.02.16 1ã€æ‰˜ç›˜å³é”®èœå•ä¼˜åŒ–ï¼Œæ–°å¢ã€ç»Ÿè®¡æŠ¥å‘Šã€‘é€‰é¡¹",
    "V1.0.0-2024.02.16 1ã€â€œå­¦ç¿¼â€1.0.0æ­£å¼ç‰ˆå‘å¸ƒï¼æ¬¢è¿ä½“éªŒäº¤æµ",
    "V1.0.1-2024.02.16 1ã€ä¼˜åŒ–éƒ¨åˆ†çª—å£å°ºå¯¸ï¼›2ã€ä¼˜åŒ–é€šçŸ¥æç¤ºï¼›3ã€ä¿®å¤äº†ä¸€äº›å·²çŸ¥BUG",
    "V1.0.2-2024.02.16 1ã€ä¿®å¤äº†ä¸€äº›å·²çŸ¥BUG",
    "V1.0.3-2024.02.16 1ã€æ›´æ¢é«˜æ¸…å›¾æ ‡",
    "V1.0.4-2024.02.20 1ã€ä¼˜åŒ–ã€æ¸…ç©ºã€‘ä»£ç é€»è¾‘ï¼›2ã€æ­£å¼ç¡®å®šåº”ç”¨åï¼šä¸­æ–‡â€œå­¦ç¿¼â€ï¼Œè‹±æ–‡â€œTaskWingâ€",
    "V1.0.5-2024.02.22 1ã€æ–°å¢ã€ä¸“æ³¨ã€‘ï¼Œè®¡å…¥ç»Ÿè®¡æŠ¥å‘Šï¼ŒåŠ©åŠ›é«˜æ•ˆå­¦ä¹ ï¼›2ã€é‡è¦æŒ‰é’®å¢åŠ æ‚¬åœæç¤ºï¼›3ã€ã€è®¾ç½®ã€‘æ–°å¢ã€åˆ é™¤æ‰€æœ‰æ•°æ®ã€‘ï¼Œå¹¶ä¼˜åŒ–æ“ä½œé€»è¾‘",
    "V1.0.6-2024.02.22 1ã€å› Deepseekå…³é—­å……å€¼å…¥å£ï¼Œã€AIæ™ºç­”ã€‘æš‚åœæä¾›è¯¥æ¸ é“å…±äº«APIï¼Œè¯¥æ¸ é“ç§æœ‰APIä¸å—å½±å“ï¼›2ã€ä¼˜åŒ–ã€ä¸“æ³¨ã€‘ï¼›3ã€ä¼˜åŒ–ã€è®¾ç½®ã€‘",
    "V1.0.7-2024.02.23 1ã€ä¼˜åŒ–æŒ‰é’®åç§°ï¼›2ã€ä¸»é¡µé¢å­—ä½“è°ƒæ•´ï¼Œæ›´æ˜¾çœ¼ï¼›3ã€ã€ç»Ÿè®¡æŠ¥å‘Šã€‘ä¼˜åŒ–æ•°æ®ç»Ÿè®¡é€»è¾‘ï¼›4ã€æ¥å…¥æ—¥æœŸé€‰æ‹©å™¨æ§ä»¶ï¼Œé€‰æ‹©æ—¥æœŸæ›´ç›´è§‚",
]

import random
import threading
import tkinter as tk
from tkinter import simpledialog
import tkinter.font as tkFont
from tkinter import ttk, messagebox
import sqlite3
import webbrowser
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
from datetime import datetime
from time import *
import locale
import sys
import importlib
import os
import pystray
from PIL import Image, ImageTk
from pathlib import Path
import winshell
from win10toast import ToastNotifier
from openai import OpenAI
from tkhtmlview import HTMLLabel
import mistune
import requests
from flask import Flask, render_template
import pygame  
from datetime import timedelta
from tkcalendar import Calendar

# Flaské…ç½®
flask_app = Flask(__name__, template_folder='templates', static_folder='static')
flask_app.config['TEMPLATES_AUTO_RELOAD'] = True
current_response_html = ""
users_question = ""

# æ·»åŠ Flaskè·¯ç”±
@flask_app.route('/ai-response')
def show_ai_response():
    return render_template('ai_response.html',
                         user_question=users_question,
                         ai_response=current_response_html,
                         bg_color=judge_theme(1),
                         text_color=judge_theme(2))

@flask_app.route('/tutorial')
def show_tutorial():
    return render_template(
        'tutorial.html',
        bg_color=judge_theme(1),
        text_color=judge_theme(2)
    )

def run_flask_server():
    flask_app.run(port=5000, use_reloader=False)

# åˆ¤æ–­æ—¶é—´æ®µ
clock = int(strftime("%H"))
def judge_time():
    if (clock >= 0 and clock <= 4):
        timenow = "æ™šä¸Š"
    elif (clock >= 5 and clock <= 9):
        timenow = "æ—©ä¸Š"
    elif (clock >= 10 and clock <= 11):
        timenow = "ä¸Šåˆ"
    elif (clock >= 12 and clock <= 14):
        timenow = "ä¸­åˆ"
    elif (clock >= 15 and clock <= 17):
        timenow = "ä¸‹åˆ"
    elif (clock >= 18 and clock <= 24):
        timenow = "æ™šä¸Š"
    
    return timenow

# å®šä¹‰èµ„æºè·¯å¾„å‡½æ•°
def resource_path(relative_path):
    try:
        # PyInstalleræ‰“åŒ…åçš„ä¸´æ—¶ç›®å½•
        base_path = sys._MEIPASS
    except AttributeError:
        # å¼€å‘ç¯å¢ƒä¸‹çš„å½“å‰ç›®å½•
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)

# WindowsMessage API
icon_path = os.path.abspath(resource_path("LOGO.ico"))
def sent_notice(t,m):
    toaster = ToastNotifier()
    toaster.show_toast(
        title=t,
        msg=m,
        duration=3,
        icon_path=icon_path,
        threaded=True
    )

    return 0

# åˆ‡æ¢çª—å£ç½®é¡¶çŠ¶æ€
def toggle_topmost():
    is_topmost = topmost_var.get()
    root.attributes('-topmost', is_topmost)

# è®¾ç½®é»˜è®¤ç¼–ç ä¸º utf-8
locale.setlocale(locale.LC_CTYPE, 'zh_CN.UTF-8')
importlib.reload(sys)

# è·å–ç”¨æˆ·æ•°æ®ç›®å½•
user_data_dir = Path(os.getenv('APPDATA')) / "TaskWing"
user_data_dir.mkdir(exist_ok=True)

# ä¿®æ”¹æ•°æ®åº“è¿æ¥è·¯å¾„
db_path = user_data_dir / "TaskWing_data.db"
conn = sqlite3.connect(str(db_path))
c = conn.cursor()

# åˆ›å»ºä»»åŠ¡è¡¨
c.execute('''CREATE TABLE IF NOT EXISTS tasks (
             id INTEGER PRIMARY KEY AUTOINCREMENT,
             name TEXT NOT NULL,
             due_date TEXT,
             rest_days INTEGER,
             completed TEXT NOT NULL DEFAULT ' ')''')
conn.commit()
c.execute("SELECT * FROM tasks")
tasks = c.fetchall()

# åˆ›å»ºä»»åŠ¡è®¡æ•°å™¨è¡¨
c.execute('''CREATE TABLE IF NOT EXISTS task_counter (
             total_tasks INTEGER DEFAULT 0)''')
conn.commit()
# åˆå§‹åŒ–è®¡æ•°å™¨
c.execute("SELECT COUNT(*) FROM task_counter")
if c.fetchone()[0] == 0:
    c.execute("INSERT INTO task_counter (total_tasks) VALUES (0)")
    conn.commit()
c.execute("SELECT * FROM task_counter")
task_counter = c.fetchall()

# ä¸»é¢˜è®¾ç½®
c.execute('''CREATE TABLE IF NOT EXISTS theme_settings (
             id INTEGER PRIMARY KEY AUTOINCREMENT,
             theme_choice TEXT NOT NULL)''')
conn.commit()
c.execute("SELECT * FROM theme_settings")
theme_settings = c.fetchall()

# AIé…ç½®
c.execute('''CREATE TABLE IF NOT EXISTS ai_settings (
             api_key TEXT,
             default_model TEXT,
             provider TEXT,
             display_mode TEXT)''')
conn.commit()
# æ›´æ–°åˆå§‹åŒ–æ•°æ®
c.execute("SELECT COUNT(*) FROM ai_settings")
if c.fetchone()[0] == 0:
    c.execute("INSERT INTO ai_settings (api_key, default_model, provider, display_mode) VALUES ('', 'deepseek-chat', 'ç¡…åŸºæµåŠ¨', 'window')")
    conn.commit()
ai_settings = c.fetchall()

# åœ¨æ•°æ®åº“åˆ›å»ºéƒ¨åˆ†æ–°å¢ç•ªèŒ„é’Ÿè®°å½•è¡¨
c.execute('''CREATE TABLE IF NOT EXISTS pomodoro_records (
             total_sessions INTEGER DEFAULT 0,
             total_minutes INTEGER DEFAULT 0)''')
conn.commit()
c.execute("SELECT COUNT(*) FROM pomodoro_records")
if c.fetchone()[0] == 0:
    c.execute("INSERT INTO pomodoro_records (total_sessions, total_minutes) VALUES (0, 0)")
conn.commit()
pomodoro_records = c.fetchall() or (0, 0)

# æ£€æŸ¥è¯»å–çš„æ•°æ®
print(tasks, task_counter, theme_settings, ai_settings, pomodoro_records)

# è·å–ä»»åŠ¡æ€»é‡ã€å·²å®Œæˆæ•°é‡å’Œå¾…å®Œæˆæ•°é‡
def get_num(mode):
    conn.commit()
    c.execute("SELECT COUNT(*) FROM tasks")
    total_tasks = c.fetchone()[0]
    c.execute("SELECT COUNT(*) FROM tasks WHERE completed='âœ…'")
    completed_tasks = c.fetchone()[0]
    if(mode == 1):
        return total_tasks
    elif(mode == 2):
        return completed_tasks
    elif(mode == 3):
        return total_tasks - completed_tasks

c.execute("SELECT rest_days, completed FROM tasks")
all_tasks = c.fetchall()

completed = 0
pending = 0
upcoming = 0
expired = 0

for task in all_tasks:
    rest_days, completed_status = task[0], task[1]
    if completed_status == 'âœ…':
        pass
    else:
        if rest_days > 1:
            pass
        elif rest_days >= 0:
            upcoming += 1
        else:
            expired += 1
if (get_num(1) == 0):
    sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æ²¡æœ‰ä»»åŠ¡å“¦ï¼Œå¿«å»æ·»åŠ å§ï¼")
else:
    if (get_num(3) > 0):
        if (upcoming > 0 and expired > 0):
            sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æœ‰{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆï¼Œå…¶ä¸­{expired}ä¸ªå·²æˆªæ­¢ï¼Œ{upcoming}ä¸ªå³å°†åˆ°æœŸï¼")
        elif (expired > 0):
            sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æœ‰{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆï¼Œå…¶ä¸­{expired}ä¸ªå·²æˆªæ­¢!")
        elif (upcoming > 0):
            sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æœ‰{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆï¼Œå…¶ä¸­{upcoming}ä¸ªå³å°†åˆ°æœŸï¼")
        else:
            sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æœ‰{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆ")
    elif (get_num(3) == 0):
        sent_notice(f"{judge_time()}å¥½ï¼", f"ä½ æ²¡æœ‰å¾…å®Œæˆçš„ä»»åŠ¡")

# ä¸»çª—å£
root = tk.Tk()
root.title("å­¦ç¿¼ - æ‚¨çš„ä¸€ç«™å¼æ™ºèƒ½åŒ–å­¦ä¹ å¹³å°")
width = 1000
height = 600
root.geometry(f"{width}x{height}")

# åˆ›å»ºä¸€ä¸ªFrameä½œä¸ºå®¹å™¨
frame = tk.Frame(root)
frame.grid(row=0, column=1, sticky="nsew")

# è®¾ç½®ç½‘æ ¼çš„è¡Œå’Œåˆ—æƒé‡
root.grid_rowconfigure(0, weight=1)
root.grid_columnconfigure(0, weight=1)

# åˆ›å»ºå¹¶å¯åŠ¨Flaskçº¿ç¨‹
flask_thread = threading.Thread(target=run_flask_server, daemon=True)
flask_thread.start()

# è®¾ç½®çª—å£å›¾æ ‡
def set_icon():
    icon_image = Image.open(resource_path('LOGO.png'))
    icon_photo = ImageTk.PhotoImage(icon_image)
    root.iconphoto(True, icon_photo)
set_icon()

default_font = tkFont.nametofont("TkDefaultFont")

# åŠ è½½ä¸»é¢˜æ–‡ä»¶
azure_tcl_path = resource_path("azure.tcl")
root.tk.call("source", azure_tcl_path)

# æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ä¸»é¢˜è®¾ç½®
c.execute("SELECT * FROM theme_settings")
theme_settings = c.fetchone()

# å¦‚æœæ²¡æœ‰ä¸»é¢˜è®¾ç½®ï¼Œæ’å…¥é»˜è®¤å€¼
if not theme_settings:
    c.execute("INSERT INTO theme_settings (theme_choice) VALUES ('è‡ªåŠ¨åˆ‡æ¢')")
    conn.commit()

# è·å–å½“å‰ä¸»é¢˜è®¾ç½®
c.execute("SELECT theme_choice FROM theme_settings")
current_theme = c.fetchone()[0]

# è®¾ç½®ä¸»é¢˜
def set_theme(theme_choice):
    global theme
    if theme_choice == "æµ…è‰²æ¨¡å¼":
        root.tk.call("set_theme", "light")
        theme = "light"
    elif theme_choice == "æ·±è‰²æ¨¡å¼":
        root.tk.call("set_theme", "dark")
        theme = "dark"
    elif theme_choice == "è‡ªåŠ¨åˆ‡æ¢":
        clock = int(strftime("%H"))
        if ((clock >= 0 and clock <= 4) or (clock >= 21 and clock <= 24)):
            root.tk.call("set_theme", "dark")
            theme = "dark"
        else:
            root.tk.call("set_theme", "light")
            theme = "light"
        

    # é‡æ–°åº”ç”¨è¡¨æ ¼æ ·å¼
    style = ttk.Style()
    style.configure("Treeview.Heading", font=('Microsoft YaHei', 14))
    style.configure("Treeview",font=('Microsoft YaHei', 12))

    # æ›´æ–°æ•°æ®åº“ä¸­çš„ä¸»é¢˜è®¾ç½®
    c.execute("UPDATE theme_settings SET theme_choice=? WHERE id=1", (theme_choice,))
    conn.commit()

# åº”ç”¨é»˜è®¤ä¸»é¢˜è®¾ç½®
set_theme(current_theme)
print(theme)

# ä¸»é¢˜é€‚é…åˆ¤æ–­
def judge_theme(mode):
    global theme
    if theme == "light":
        if mode == 1:
            return "#ffffff"
        elif mode == 2:
            return "black"
    elif theme == "dark":
        if mode == 1:
            return "#333333"
        elif mode == 2:
            return "white"

# Tooltipç±»
class Tooltip:
    def __init__(self, widget, text):
        self.widget = widget
        self.text = text
        self.tipwindow = None
        self.alpha = 0.0  # é€æ˜åº¦æ§åˆ¶
        self.after_id = None  # å»¶è¿Ÿæ˜¾ç¤ºå®šæ—¶å™¨
        self.fade_in_id = None  # æ¸æ˜¾åŠ¨ç”»ID
        self.widget.bind("<Enter>", self.schedule_show)
        self.widget.bind("<Leave>", self.schedule_hide)

    def schedule_show(self, event=None):
        """å®‰æ’å»¶è¿Ÿæ˜¾ç¤º"""
        self.cancel_pending()
        self.after_id = self.widget.after(500, self.showtip)  # 0.5ç§’åæ˜¾ç¤º

    def schedule_hide(self, event=None):
        """å®‰æ’æ¸éšæ•ˆæœ"""
        self.cancel_pending()
        if self.tipwindow:
            self.fade_out()

    def cancel_pending(self):
        """å–æ¶ˆæ‰€æœ‰å¾…æ‰§è¡Œæ“ä½œ"""
        if self.after_id:
            self.widget.after_cancel(self.after_id)
            self.after_id = None

    def showtip(self):
        """åˆ›å»ºæç¤ºçª—å£å¹¶å¯åŠ¨æ¸æ˜¾åŠ¨ç”»"""
        if self.tipwindow or not self.text:
            return
        
        # å®šä½è®¡ç®—
        x = self.widget.winfo_rootx() + 25
        y = self.widget.winfo_rooty() + 25
        
        # åˆ›å»ºåŠé€æ˜çª—å£
        self.tipwindow = tw = tk.Toplevel(self.widget)
        tw.wm_overrideredirect(True)
        tw.wm_geometry(f"+{x}+{y}")
        tw.attributes("-alpha", 0.0)  # åˆå§‹å®Œå…¨é€æ˜
        
        # æ ·å¼é…ç½®
        bg_color = judge_theme(1)
        text_color = judge_theme(2)
        label = tk.Label(tw, text=self.text, justify='left',
                        background=bg_color, foreground=text_color,
                        relief='solid', borderwidth=1,
                        font=("Microsoft YaHei", 10))
        label.pack()
        
        # å¯åŠ¨æ¸æ˜¾åŠ¨ç”»
        self.fade_in()

    def fade_in(self):
        """æ¸æ˜¾æ•ˆæœ(0.0 -> 1.0)"""
        self.alpha = min(self.alpha + 0.25, 1.0)
        self.tipwindow.attributes("-alpha", self.alpha)
        if self.alpha < 1.0:
            self.fade_in_id = self.tipwindow.after(20, self.fade_in)

    def fade_out(self):
        """æ¸éšæ•ˆæœ(1.0 -> 0.0)"""
        self.alpha = max(self.alpha - 0.25, 0.0)
        self.tipwindow.attributes("-alpha", self.alpha)
        if self.alpha > 0.0:
            self.tipwindow.after(20, self.fade_out)
        else:
            self.tipwindow.destroy()
            self.tipwindow = None
            self.alpha = 0.0

    def __del__(self):
        """å¯¹è±¡é”€æ¯æ—¶æ¸…ç†èµ„æº"""
        if self.tipwindow:
            self.tipwindow.destroy()


# æ›´æ–°å‰©ä½™å¤©æ•°
def update_rest_days():
    current_date = datetime.now().strftime("%Y/%m/%d")
    c.execute("SELECT id, due_date FROM tasks")
    tasks = c.fetchall()
    
    for task in tasks:
        task_id, due_date_str = task
        
        due_date = datetime.strptime(due_date_str, "%Y/%m/%d")
        current_date_obj = datetime.strptime(current_date, "%Y/%m/%d")
        rest_days = (due_date - current_date_obj).days
        c.execute("UPDATE tasks SET rest_days=? WHERE id=?", (rest_days, task_id))
    
    conn.commit()
    root.after(1000, update_rest_days)  # æ¯ç§’æ›´æ–°

# æ›´æ–°æ—¶é—´
def update_time():
    timenow = judge_time()
    stime = strftime("%Y/%m/%d %H:%M:%S")
    def adjust_font_size(event):
        width = event.width
        height = event.height
        if height / 2 > 55:
            height = 55 * 2
        elif height / 2 < 15:
            height = 15 * 2
        font_size = int(height / 2.5)
        time_label.config(font=("Microsoft YaHei", font_size))

    if not hasattr(root, 'time_label'):
        time_label = ttk.Label(top_frame, text=f"{timenow}å¥½ï¼Œç°åœ¨æ˜¯{stime}", font=("Microsoft YaHei", 21))
        time_label.place(relx=0.5, rely=0.5, anchor="center")
        root.time_label = time_label
        top_frame.bind("<Configure>", adjust_font_size)
    else:
        root.time_label.config(text=f"{timenow}å¥½ï¼Œç°åœ¨æ˜¯{stime}")
    root.after(1000, update_time)

# æ˜¾ç¤ºæ‰˜ç›˜å›¾æ ‡
def create_tray_icon():
    image = Image.open(resource_path('LOGO.ico'))

    menu = (
        pystray.MenuItem('ä¸»é¡µ', on_showing),
        pystray.MenuItem('AIæ™ºç­”', open_ai_assistant_window),
        pystray.MenuItem('ç»Ÿè®¡æŠ¥å‘Š', open_progress_window),
        pystray.MenuItem('è®¾ç½®', open_settings_window),
        pystray.MenuItem('å…³äºåº”ç”¨', open_about_window),
        pystray.MenuItem('é€€å‡º', on_closing)
    )

    if (get_num(1) == 0):
        icon = pystray.Icon("LOGO", image, f"å­¦ç¿¼ï¼ˆæ²¡æœ‰æ·»åŠ ä»»åŠ¡ï¼‰", menu)
    else:
        if (get_num(3) > 0):
            icon = pystray.Icon("LOGO", image, f"å­¦ç¿¼ï¼ˆ{get_num(3)}ä¸ªä»»åŠ¡å¾…å®Œæˆï¼‰", menu)
        elif (get_num(3)  == 0):
            icon = pystray.Icon("LOGO", image, f"å­¦ç¿¼ï¼ˆæ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼‰", menu)
        
    return icon

# æ›´æ–°ä»»åŠ¡åˆ—è¡¨
def update_task_list():
    task_list.delete(*task_list.get_children())
    c.execute("SELECT * FROM tasks")
    tasks = c.fetchall()
    for task in tasks:
        task_list.insert("", "end", values=task)
    
# æ·»åŠ ä»»åŠ¡
def add_task():
    current_date = datetime.now().strftime("%Y/%m/%d")
    name = name_entry.get().strip()
    due_date = date_entry.get().strip()
    
    if not name:
        messagebox.showerror("é”™è¯¯", "ä»»åŠ¡åç§°ä¸èƒ½ä¸ºç©º")
        return
    
    try:
        # å…ˆè½¬æ¢ä¸ºdatetimeå¯¹è±¡å†è¿›è¡Œè®¡ç®—
        due_date_obj = datetime.strptime(due_date, "%Y/%m/%d")
        current_date_obj = datetime.strptime(current_date, "%Y/%m/%d")
    except ValueError:
        messagebox.showerror("é”™è¯¯", "æ—¥æœŸæ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨YYYY/MM/DDæ ¼å¼")
        return

    # è®¡ç®—å‰©ä½™å¤©æ•°ï¼ˆä½¿ç”¨datetimeå¯¹è±¡ï¼‰
    rest_days = (due_date_obj - current_date_obj).days

    # æ’å…¥ä»»åŠ¡å¹¶æ›´æ–°è®¡æ•°å™¨
    c.execute(
    "INSERT INTO tasks (name, due_date, rest_days, completed) VALUES (?, ?, ?, ' ')",
    (name, due_date, rest_days)
    )
    c.execute("UPDATE task_counter SET total_tasks = total_tasks + 1")
    conn.commit()
    
    # é‡æ–°ç¼–å·ä»»åŠ¡ID
    c.execute("SELECT id FROM tasks ORDER BY id")
    ids = [row[0] for row in c.fetchall()]
    for i, task_id in enumerate(ids):
        c.execute("UPDATE tasks SET id=? WHERE id=?", (i + 1, task_id))
    conn.commit()

    update_task_list()
    name_entry.delete(0, tk.END)
    sent_notice("æ‚¨æ·»åŠ äº†ä¸€ä¸ªä»»åŠ¡", name)

# ç¼–è¾‘ä»»åŠ¡
def edit_task():
    selected = task_list.selection()
    if not selected:
        messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¿®æ”¹ã€‚")
        return
    item = task_list.item(selected)
    task_id, name, due_date, rest_days, completed, *extra_values = item['values']
    
    edit_window = tk.Toplevel(root)
    edit_window.title("ä¿®æ”¹ä»»åŠ¡")
    edit_window.geometry("500x300")
    edit_window.resizable(False, False)
    
    # ä¸»å®¹å™¨æ¡†æ¶
    main_frame = ttk.Frame(edit_window)
    main_frame.pack(fill="both", expand=True, padx=10, pady=10)
    
    # ========== ä»»åŠ¡ä¿¡æ¯éƒ¨åˆ† ==========
    info_frame = ttk.LabelFrame(main_frame, text="ä»»åŠ¡è¯¦æƒ…", padding=10)
    info_frame.pack(fill="x", pady=5)
    
    # ä»»åŠ¡åç§°
    ttk.Label(info_frame, text="ä»»åŠ¡åç§°:").grid(row=0, column=0, sticky="w", padx=5)
    name_entry = ttk.Entry(info_frame, width=40)
    name_entry.bind("<Return>", lambda e: save_changes())
    name_entry.insert(0, name)
    name_entry.grid(row=0, column=1, columnspan=3, sticky="w", padx=5)

    # ========== æˆªæ­¢æ—¥æœŸéƒ¨åˆ† ==========
    ttk.Label(info_frame, text="æˆªæ­¢æ—¥æœŸ:").grid(row=1, column=0, sticky="w", padx=5, pady=5)
    
    # åˆ›å»ºæ—¥æœŸè¾“å…¥æ¡†
    date_entry = ttk.Entry(info_frame, width=12, font=('Microsoft YaHei', 9))
    date_entry.insert(0, due_date)  # ä½¿ç”¨åŸæ—¥æœŸåˆå§‹åŒ–
    date_entry.grid(row=1, column=1, sticky="w", padx=5, pady=10)
    
    def set_edit_date():
        def on_date_select():
            date_entry.delete(0, tk.END)
            date_entry.insert(0, cal.get_date())
            top.grab_release()
            top.destroy()
        
        # è§£æåŸå§‹æ—¥æœŸ
        init_year, init_month, init_day = map(int, due_date.split('/'))
        
        top = tk.Toplevel(edit_window)
        top.title("é€‰æ‹©æ—¥æœŸ")
        cal = Calendar(top, 
                      selectmode='day',
                      year=init_year,
                      month=init_month,
                      day=init_day,
                      date_pattern='y/mm/dd')
        cal.pack(padx=10, pady=10)
        ttk.Button(top, text="ç¡®å®š", command=on_date_select).pack(pady=10)
    
    # æ·»åŠ æ—¥æœŸé€‰æ‹©æŒ‰é’®
    ttk.Button(info_frame, text="ğŸ“… é€‰æ‹©", command=set_edit_date).grid(row=1, column=1, padx=120, pady=10)

    # ========== ä»»åŠ¡çŠ¶æ€éƒ¨åˆ† ==========
    status_frame = ttk.LabelFrame(main_frame, text="ä»»åŠ¡çŠ¶æ€", padding=10)
    status_frame.pack(fill="x", pady=5)
    
    completed_var = tk.BooleanVar(value=(completed == "âœ…"))
    ttk.Checkbutton(
        status_frame,
        text="å·²å®Œæˆ",
        variable=completed_var,
        onvalue=True,
        offvalue=False
    ).pack(side="left", padx=5)

    # ========== æŒ‰é’®éƒ¨åˆ† ==========
    btn_frame = ttk.Frame(main_frame)
    btn_frame.pack(pady=10)

    def save_changes():
        current_date = datetime.now().strftime("%Y/%m/%d")
        new_name = name_entry.get()
        new_status = "âœ…" if completed_var.get() else " "
        
        new_name = name_entry.get().strip()
        new_date = date_entry.get().strip()
        
        # éªŒè¯æ—¥æœŸæ ¼å¼
        try:
            datetime.strptime(new_date, "%Y/%m/%d")
        except ValueError:
            messagebox.showerror("é”™è¯¯", "æ—¥æœŸæ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨YYYY/MM/DDæ ¼å¼")
            return
        
        # è®¡ç®—æ–°å‰©ä½™å¤©æ•°
        current_date = datetime.now().date()
        due_date_obj = datetime.strptime(new_date, "%Y/%m/%d").date()
        new_rest_days = (due_date_obj - current_date).days

        # è·å–åŸå§‹çŠ¶æ€
        c.execute("SELECT completed FROM tasks WHERE id=?", (task_id,))
        current_status = c.fetchone()[0].strip()
        
        if current_status.strip() == '' and new_status == "âœ…":
            conn.commit()  
            
            total = get_num(1)
            actual_completed = get_num(2)+1
            remaining = get_num(3)-1
            progress = actual_completed / total * 100
            print(total, actual_completed, remaining)

            if remaining == 0:
                sent_notice("å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡ï¼ŒçœŸå‰å®³ï¼", f"å·²å®Œæˆ{progress}%ï¼Œå…±è®¡{total}ä¸ªä»»åŠ¡")
            else:
                sent_notice("æå®šä¸€ä¸ªä»»åŠ¡ï¼Œå¤ªæ£’äº†ï¼", f"å·²å®Œæˆ{progress}%ï¼Œè¿˜æœ‰{remaining}ä¸ªä»»åŠ¡å¾…å®Œæˆ")

        # æ›´æ–°æ•°æ®åº“
        try:
            c.execute(
            "UPDATE tasks SET name=?, due_date=?, rest_days=?, completed=? WHERE id=?",
            (new_name, new_date, new_rest_days, new_status, task_id)
            )
            
            conn.commit()
            update_task_list()
            edit_window.destroy()
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ä¿å­˜å¤±è´¥ï¼š{str(e)}")
            conn.rollback()

    ttk.Button(
        btn_frame,
        text="ğŸ’¾ ä¿å­˜",
        command=save_changes,
        width=15
    ).pack(side="left", padx=10)
    
    ttk.Button(
        btn_frame,
        text="â†©ï¸ å–æ¶ˆ",
        command=edit_window.destroy,
        width=10
    ).pack(side="right", padx=10)

    edit_window.transient(root)
    edit_window.grab_set()

# åˆ é™¤ä»»åŠ¡
def delete_task():
    selected = task_list.selection()
    if not selected:
        messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡è¿›è¡Œåˆ é™¤ã€‚")
        return
    item = task_list.item(selected)
    task_id = item['values'][0]
    
    # åˆ é™¤å…³è”ç»Ÿè®¡è®°å½•
    c.execute("DELETE FROM tasks WHERE id=?", (task_id,))
    conn.commit()

    # é‡æ–°ç¼–å·
    c.execute("SELECT id FROM tasks ORDER BY id")
    ids = [row[0] for row in c.fetchall()]
    for i, task_id in enumerate(ids):
        c.execute("UPDATE tasks SET id=? WHERE id=?", (i + 1, task_id))
    conn.commit()

    update_task_list()
    sent_notice("æ‚¨åˆ é™¤äº†ä¸€ä¸ªä»»åŠ¡",f"ç›®å‰è¿˜æœ‰{get_num(1)}ä¸ªä»»åŠ¡ï¼Œ{get_num(3)}ä¸ªå¾…å®Œæˆ")

# ç¡®è®¤æ¸…ç©ºä»»åŠ¡åˆ—è¡¨çš„å‡½æ•°
def confirm_clear_tasks():
    if messagebox.askokcancel("ç¡®è®¤", "ç¡®å®šè¦æ¸…ç©ºä»»åŠ¡åˆ—è¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤"):
        c.execute("DELETE FROM tasks")
        conn.commit()
        update_task_list()
        sent_notice("æ‚¨æ¸…ç©ºäº†ä»»åŠ¡åˆ—è¡¨","ä»»åŠ¡åˆ—è¡¨æ¸…ç©ºæˆåŠŸ")

def pomodoro_set_tasks():
    # è·å–é€‰ä¸­çš„ä»»åŠ¡
    selected = task_list.selection()
    if not selected:
        messagebox.showwarning("æç¤º", "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡", parent=root)
        return
    
    # è·å–å®é™…ä»»åŠ¡ID
    item = task_list.item(selected)
    task_id = item['values'][0]

    # åˆ›å»ºè®¾ç½®çª—å£
    setup_win = tk.Toplevel(root)
    setup_win.title("ç•ªèŒ„é’Ÿè®¾ç½®")
    setup_win.geometry("800x250")
    
    ttk.Label(setup_win, text="è¯·é€‰æ‹©ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰:", font=('Microsoft Yahei', 12)).pack(pady=10)
    
    time_var = tk.StringVar(value="25")
    duration_combo = ttk.Combobox(
        setup_win,
        textvariable=time_var,
        values=["1", "5", "10", "15", "20", "25", "30", "45", "60", "90", "120", "150", "180", "210", "240", "270", "300", "330", "360", "390", "420", "450", "480", "510", "540", "570", "600"],
        state="readonly"
    )
    duration_combo.pack(pady=5)
    
    def start_pomodoro():
        setup_win.destroy()
        show_pomodoro_interface(int(time_var.get()), task_id)
    
    ttk.Button(setup_win, text="å¼€å§‹ä¸“æ³¨", command=start_pomodoro).pack(pady=10)

    ttk.Label(setup_win,
             text="""ç•ªèŒ„é’Ÿï¼ˆPomodoro Techniqueï¼‰æ˜¯ä¸€ç§ç»å…¸çš„æ—¶é—´ç®¡ç†æ–¹æ³•ï¼Œç”±æ„å¤§åˆ©å­¦è€…å¼—æœ—è¥¿æ–¯ç§‘Â·è¥¿é‡Œæ´›ï¼ˆFrancesco Cirilloï¼‰äº20ä¸–çºª80å¹´ä»£æå‡ºã€‚
å…¶æ ¸å¿ƒç†å¿µæ˜¯é€šè¿‡æ‹†åˆ†æ—¶é—´å•å…ƒå’Œå¼ºåˆ¶ä¼‘æ¯ï¼Œå¸®åŠ©äººä»¬æå‡ä¸“æ³¨åŠ›ã€å‡å°‘æ‹–å»¶ï¼Œå¹¶é«˜æ•ˆå®Œæˆä»»åŠ¡ã€‚
ç•ªèŒ„é’Ÿå°†å·¥ä½œæ—¶é—´åˆ’åˆ†ä¸ºå¤šä¸ª25åˆ†é’Ÿçš„ä¸“æ³¨å•å…ƒï¼ˆç§°ä¸ºä¸€ä¸ªâ€œç•ªèŒ„é’Ÿâ€ï¼‰ï¼Œæ¯ä¸ªå•å…ƒç»“æŸåçŸ­æš‚ä¼‘æ¯5åˆ†é’Ÿã€‚
æ¯å®Œæˆ4ä¸ªç•ªèŒ„é’Ÿåï¼Œè¿›è¡Œä¸€æ¬¡æ›´é•¿çš„ä¼‘æ¯ï¼ˆé€šå¸¸15-30åˆ†é’Ÿï¼‰ã€‚""",
             font=("Microsoft YaHei", 9),
             foreground="#95a5a6",
             justify="left").pack(pady=10)

def show_pomodoro_interface(duration, task_id):
    # è·å–ä»»åŠ¡è¯¦æƒ…
    c.execute("SELECT name, due_date, rest_days FROM tasks WHERE id=?", (task_id,))
    task = c.fetchone()
    
    # åˆ›å»ºä¸»çª—å£
    pomo_win = tk.Toplevel(root)
    pomo_win.title(f"ç•ªèŒ„é’Ÿ - {task[0]}")
    pomo_win.geometry("800x600")
    
    main_frame = ttk.Frame(pomo_win)
    main_frame.pack(fill='both', expand=True)

    # ä¸€è¨€æ˜¾ç¤ºåŒºåŸŸ
    try:
        yiyan = requests.get("https://v1.hitokoto.cn/?c=k").json()
        yiyan_text = f"ã€{yiyan['hitokoto']}ã€ â€”â€” {yiyan['from']}"
    except:
        yiyan_text = "ã€å­¦å¦‚é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€ã€ â€”â€” ã€Šå¢å¹¿è´¤æ–‡ã€‹"
    
    yiyan_label = ttk.Label(
        main_frame,
        text=yiyan_text,
        font=('åæ–‡é­ä½“', 14, 'italic'),
        wraplength=1000,
        justify='left'
    )
    yiyan_label.pack(pady=20)

    # åˆ†éš”çº¿
    ttk.Separator(main_frame).pack(fill='x', pady=10, padx=30)
    
    # ä»»åŠ¡ä¿¡æ¯æ˜¾ç¤º
    task_frame = ttk.Frame(main_frame)
    task_frame.pack(pady=10)
    
    task_label1 = ttk.Label(task_frame, text=f"æ‚¨å½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡æ˜¯ã€{task[0]}ã€‘", font=('å¾®è½¯é›…é»‘', 12), justify='center')
    task_label1.grid(row=0, column=0)
    task_label2 = ttk.Label(task_frame, text=f"ä»»åŠ¡å°†äº {task[1]} æˆªæ­¢ï¼Œå‰©ä½™{task[2]}å¤©", font=('å¾®è½¯é›…é»‘', 8), justify='center')
    task_label2.grid(row=1, column=0)
    
    # è®¡æ—¶å™¨æ˜¾ç¤º
    time_label = ttk.Label(
        main_frame,
        text="00:00:00",
        font=('Consolas', 40),
    )
    time_label.pack(pady=20)
    
    # æ—¶é—´è¿›åº¦æ˜¾ç¤º
    start_time = datetime.now()
    end_time = start_time + timedelta(minutes=duration)
    time_info = ttk.Label(
        main_frame,
        text=f"{start_time.strftime('%H:%M:%S')} - {end_time.strftime('%H:%M:%S')}",
        font=('å¾®è½¯é›…é»‘', 8)
    )
    time_info.pack()
    
    # è®¡ç®—å­—ä½“å¢é‡
    add_size = 0
    def update_font_size(event=None):
        nonlocal add_size
        pomo_win.update_idletasks()
        win_height = pomo_win.winfo_height()
        
        add_size = int(win_height / 100 )
        # æ›´æ–°æ‰€æœ‰å­—ä½“è®¾ç½®
        yiyan_label.config(font=('åæ–‡é­ä½“', 13+add_size, 'italic'))
        task_label1.config(font=('å¾®è½¯é›…é»‘', 10+add_size))
        task_label2.config(font=('å¾®è½¯é›…é»‘', 8+add_size))
        time_label.config(font=('Consolas', 40+add_size))
        time_info.config(font=('å¾®è½¯é›…é»‘', 8+add_size))

    # åˆå§‹åŒ–è®¾ç½®
    pomo_win.bind("<Configure>", update_font_size)
    update_font_size()

    # åˆ†éš”çº¿
    ttk.Separator(main_frame).pack(fill='x', pady=10, padx=30)

    # éŸ³é¢‘æ§åˆ¶éƒ¨åˆ†
    audio_frame = ttk.LabelFrame(main_frame, text="ç™½å™ªéŸ³è®¾ç½®")
    audio_frame.pack(pady=15, padx=20, anchor='center', ipadx=5, ipady=5)
    
    # ç™½å™ªéŸ³é€‰æ‹©
    pygame.mixer.init()
    sounds = {
        "æ•£æ­¥æ—¶åˆ»": "sound/relaxing_walk.mp3",
        "æºªè¾¹è›™é¸£": "sound/frogs.mp3",
        "æ˜Ÿè¾°éœ²è¥": "sound/camping.mp3",
        "è¥ç«æŸ´å£°": "sound/campfire.mp3",
        "é›¨åå¤©æ™´": "sound/after_rain.mp3",
        "å¤§é›¨æ»‚æ²±": "sound/heavy_rain.mp3",
        "è‡ªç„¶æ°´æµ": "sound/stream.mp3",
        "è¿·é›¾æ£®æ—": "sound/foggy_forest.mp3"
    }
    
    sound_var = tk.StringVar()
    ttk.Label(audio_frame, text="é€‰æ‹©ç¯å¢ƒéŸ³æ•ˆï¼š").grid(row=0, column=0, padx=5, pady=5)
    sound_combo = ttk.Combobox(
        audio_frame,
        textvariable=sound_var,
        values=list(sounds.keys()),
        state="readonly",
        width=18
    )
    sound_combo.grid(row=0, column=1, padx=5, pady=5)
    
    # æ§åˆ¶æŒ‰é’®
    def play_sound():
        if sound_var.get():
            pygame.mixer.music.load(resource_path(sounds[sound_var.get()]))
            pygame.mixer.music.play(-1)
    
    
    paused = [False]
    
    play_btn = ttk.Button(audio_frame, text="â–¶ï¸ æ’­æ”¾", width=10)
    play_btn.grid(row=0, column=2, padx=5)
    
    # ä¿®æ”¹åçš„æ’­æ”¾æ§åˆ¶é€»è¾‘
    def toggle_play():
        if not pygame.mixer.music.get_busy() or paused[0]:
            play_sound()
            play_btn.config(text="â¸ æš‚åœ")
            paused[0] = False
        else:
            pygame.mixer.music.pause()
            play_btn.config(text="â–¶ï¸ ç»§ç»­")
            paused[0] = True
    
    play_btn.config(command=toggle_play)
    
    ai_frame = ttk.LabelFrame(main_frame, text="å­¦ä¹ è¾…åŠ©")
    ai_frame.pack(pady=15, padx=20, anchor='center', ipadx=10, ipady=5)
    ttk.Button(
        ai_frame,
        text="ğŸ¤– AIæ™ºç­”",
        command=open_ai_assistant
    ).pack()
    Tooltip(ai_frame.winfo_children()[0], "ä¸“æ³¨æœŸé—´çš„ç§äººåŠ©æ‰‹")
    
    # æ§åˆ¶é¢æ¿
    ctrl_frame = ttk.Frame(main_frame)
    ctrl_frame.pack(side='bottom', fill='x', pady=10)
    
    def toggle_pause():
        running[0] = not running[0]
        if running[0]:
            pause_button.config(text="â¸ æš‚åœ")
            update_timer()  # æ¢å¤æ—¶é‡æ–°å¯åŠ¨è®¡æ—¶
        else:
            pause_button.config(text="â–¶ï¸ ç»§ç»­")

    # çª—å£ç½®é¡¶é€‰é¡¹
    topmost_var = tk.IntVar(value=0)
    def toggle_topmost():
        pomo_win.attributes('-topmost', topmost_var.get())
    topmost_check = ttk.Checkbutton(
        ctrl_frame,
        text="çª—å£ç½®é¡¶",
        variable=topmost_var,
        command=toggle_topmost
    )
    topmost_check.pack(side='left', padx=20)
    
    # åˆå§‹åŒ–çª—å£ç½®é¡¶çŠ¶æ€
    topmost_var.set(False)
    toggle_topmost()

    # è®¡æ—¶é€»è¾‘
    elapsed = [0]  # ä½¿ç”¨åˆ—è¡¨å®ç°é—­åŒ…æ•ˆæœ
    running = [True]
    
    def update_timer():
        # å…ˆæ£€æŸ¥æ—¶é—´æ¡ä»¶ï¼Œå†æ£€æŸ¥è¿è¡ŒçŠ¶æ€
        if elapsed[0] < duration * 60:
            if running[0]:  # åªæœ‰è¿è¡ŒçŠ¶æ€ä¸ºTrueæ—¶æ‰æ›´æ–°
                elapsed[0] += 1
                m, s = divmod(elapsed[0], 60)
                h, m = divmod(m, 60)
                time_label.config(text=f"{h:02d}:{m:02d}:{s:02d}")
                pomo_win.after(1000, update_timer)
            else:  # è¿è¡ŒçŠ¶æ€è¢«è®¾ä¸ºFalseæ—¶ç›´æ¥è¿”å›
                return
        else:
            finish_pomodoro(True)  # ä»…å½“è‡ªç„¶ç»“æŸæ—¶è§¦å‘
    
    def finish_pomodoro(natural_end):
        running[0] = False  # ç«‹å³åœæ­¢è®¡æ—¶å™¨
        pygame.mixer.music.stop()

        should_proceed = True
        # ä»…å½“éè‡ªç„¶ç»“æŸéœ€è¦ç¡®è®¤
        if not natural_end:
            should_proceed = messagebox.askyesno(
                "é€€å‡ºæç¤º",
                "è®¡æ—¶å°šæœªå®Œæˆï¼Œç¡®å®šè¦æå‰ç»“æŸå—ï¼Ÿ\nï¼ˆå»ºè®®åšæŒå®Œæˆå½“å‰ç•ªèŒ„é’Ÿï¼‰",
                icon='warning',
                parent=pomo_win
            )

        if should_proceed:
            if messagebox.askyesno(
                "è®¡æ—¶ç»“æŸ", 
                f"æ˜¯å¦å·²ç»å®Œæˆä»»åŠ¡ã€{task[0]}ã€‘ï¼Ÿ",
                parent=pomo_win
            ):
                # è·å–åŸå§‹çŠ¶æ€
                c.execute("SELECT completed FROM tasks WHERE id=?", (task_id,))
                current_status = c.fetchone()[0].strip()
                
                if current_status.strip() == '':
                    conn.commit()  
                    
                    total = get_num(1)
                    actual_completed = get_num(2)+1
                    remaining = get_num(3)-1
                    progress = actual_completed / total * 100
                    print(total, actual_completed, remaining)

                    if remaining == 0:
                        sent_notice("å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡ï¼ŒçœŸå‰å®³ï¼", f"å·²å®Œæˆ{progress}%ï¼Œå…±è®¡{total}ä¸ªä»»åŠ¡")
                    else:
                        sent_notice("æå®šä¸€ä¸ªä»»åŠ¡ï¼Œå¤ªæ£’äº†ï¼", f"å·²å®Œæˆ{progress}%ï¼Œè¿˜æœ‰{remaining}ä¸ªä»»åŠ¡å¾…å®Œæˆ")

                # æ›´æ–°ä»»åŠ¡çŠ¶æ€
                c.execute("UPDATE tasks SET completed='âœ…' WHERE id=?", (task_id,))
                conn.commit()
                update_task_list()

            # æ›´æ–°ç•ªèŒ„é’Ÿè®°å½•
            minutes = round(elapsed[0] / 60, 2)
            c.execute("UPDATE pomodoro_records SET total_sessions = total_sessions + ?, total_minutes = total_minutes + ?", 
                    (1, minutes,))
            conn.commit()
            
            pomo_win.destroy()
        else:
            running[0] = True
            update_timer()
    
    ttk.Button(
        ctrl_frame,
        text="é€€å‡ºä¸“æ³¨",
        command=lambda: finish_pomodoro(False)
    ).pack(side='right', padx=20)

    pause_button = ttk.Button(
        ctrl_frame,
        text="â¸ æš‚åœ",
        command=lambda: toggle_pause()
    )
    pause_button.pack(side='right', padx=5)

    pomo_win.protocol("WM_DELETE_WINDOW", lambda: finish_pomodoro(False))
    
    update_timer()

button_frame = ttk.Frame(root)
button_frame.grid(row=4, column=0, pady=10)

# æ˜¾ç¤ºè¿›åº¦æŠ¥å‘Š
def show_progress_report():
    progress_window = tk.Toplevel(root)
    progress_window.title("ç»Ÿè®¡æŠ¥å‘Š")
    progress_window.geometry("1200x700")
    
    # è®¾ç½®å…¨å±€å­—ä½“
    style = ttk.Style()
    style.configure("Report.TLabelframe", font=("Microsoft YaHei", 12, "bold"))
    style.configure("Report.TLabel", font=("Microsoft YaHei", 11))
    
    # ä¸»å®¹å™¨ï¼ˆå·¦å³åˆ†æ ï¼‰
    main_frame = ttk.Frame(progress_window)
    main_frame.pack(fill="both", expand=True, padx=20, pady=20)

    # ========== å·¦ä¾§åŒºåŸŸ ==========
    left_frame = ttk.Frame(main_frame)
    left_frame.grid(row=0, column=0, sticky="nsew", padx=10)

    # æ ¸å¿ƒæŒ‡æ ‡åŒº
    metrics_frame = ttk.LabelFrame(left_frame, text="æ ¸å¿ƒæŒ‡æ ‡", style="Report.TLabelframe")
    metrics_frame.pack(fill="x", pady=10)

    # è·å–ç»Ÿè®¡æ•°æ®
    c.execute("SELECT total_tasks FROM task_counter")
    result = c.fetchone()
    total_added = result[0] if result else 0
    c.execute("SELECT COUNT(*) FROM tasks WHERE rest_days=0")
    tomorrow_tasks = c.fetchone()[0]

    # æŒ‡æ ‡å¡ç‰‡å¸ƒå±€
    metrics_grid = ttk.Frame(metrics_frame)
    metrics_grid.pack(padx=10, pady=10)

    metrics_data = [
        ("ğŸ“‹ æ€»ä»»åŠ¡æ•°", get_num(1), "#4e73df"),
        ("âœ… å·²å®Œæˆ", get_num(2), "#1cc88a"),
        ("â³ å¾…å®Œæˆ", get_num(3), "#f6c23e"),
        ("â° æ˜æ—¥è¿‡æœŸ", tomorrow_tasks, "#e74a3b"),
        ("ğŸ“ˆ ç´¯è®¡æ·»åŠ ", total_added, "#36b9cc")
    ]

    for i, (title, value, color) in enumerate(metrics_data):
        card = ttk.Frame(metrics_grid, relief="groove", borderwidth=1)
        card.grid(row=i//3, column=i%3, padx=8, pady=8, sticky="nsew")
        
        ttk.Label(card, text=title, style="Report.TLabel").pack(pady=5)
        ttk.Label(card, text=str(value), 
                 font=("Microsoft YaHei", 20, "bold"), 
                 foreground=color).pack(pady=5)

        # å›¾è¡¨åŒº
    chart_frame = ttk.LabelFrame(left_frame, text="ä»»åŠ¡åˆ†å¸ƒ", style="Report.TLabelframe")
    chart_frame.pack(fill="both", expand=True, pady=10)

    # é…ç½®ä¸­æ–‡å­—ä½“ï¼ˆè§£å†³æ–¹æ ¼å­é—®é¢˜ï¼‰
    plt.rcParams['font.family'] = 'Microsoft YaHei'
    plt.rcParams['axes.unicode_minus'] = False

    fig = plt.Figure(figsize=(10, 8))
    ax1 = fig.add_subplot(211)
    ax2 = fig.add_subplot(212)

    back_color = judge_theme(1)
    front_color = judge_theme(2)

    # è®¾ç½®å›¾è¡¨èƒŒæ™¯è‰²
    fig.patch.set_facecolor(back_color)  # å›¾è¡¨æ•´ä½“èƒŒæ™¯è‰²
    ax1.set_facecolor(back_color)  # ç¬¬ä¸€ä¸ªå­å›¾èƒŒæ™¯è‰²
    ax2.set_facecolor(back_color)  # ç¬¬äºŒä¸ªå­å›¾èƒŒæ™¯è‰²

    # é¥¼å›¾æ•°æ®
    pie_labels = ['å·²å®Œæˆ', 'å¾…å®Œæˆ']
    pie_sizes = [get_num(2), get_num(3)]
    pie_colors = ['#1cc88a', '#f6c23e']
    
    # æŸ±çŠ¶å›¾æ•°æ®
    c.execute("SELECT rest_days, completed FROM tasks")
    all_tasks = c.fetchall()
    
    completed = 0
    pending = 0
    upcoming = 0
    expired = 0
    
    for task in all_tasks:
        rest_days, completed_status = task[0], task[1]
        if completed_status == 'âœ…':
            completed += 1
        else:
            if rest_days >= 1:
                pending += 1
            elif rest_days == 0:
                upcoming += 1
            else:
                expired += 1

    status_labels = ['å·²å®Œæˆ', 'è¿›è¡Œä¸­', 'ä»Šæ—¥æˆªæ­¢', 'å·²è¿‡æœŸ']
    status_values = [completed, pending, upcoming, expired]
    colors = ['#1cc88a', '#4e73df', '#f6c23e', '#e74a3b']  # ç»¿ã€è“ã€é»„ã€çº¢

    # ç»˜åˆ¶å›¾è¡¨
    ax1.pie(pie_sizes, labels=pie_labels, colors=pie_colors,
           autopct='%1.1f%%', startangle=140, textprops={'fontsize':10, 'color': front_color})  # è®¾ç½®å­—ä½“è‰²
    ax1.set_title('ä»»åŠ¡å®Œæˆæ¯”ä¾‹', fontsize=12, color=front_color)  # è®¾ç½®æ ‡é¢˜å­—ä½“è‰²

    bars = ax2.bar(status_labels, status_values, color=colors)
    ax2.set_title('ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒ', fontsize=12, color=front_color)  # è®¾ç½®æ ‡é¢˜å­—ä½“è‰²
    ax2.set_ylabel('ä»»åŠ¡æ•°é‡', fontsize=10, color=front_color)  # è®¾ç½®åæ ‡è½´æ ‡ç­¾å­—ä½“è‰²
    
    # æ·»åŠ æ•°å€¼æ ‡ç­¾
    for bar in bars:
        height = bar.get_height()
        ax2.text(bar.get_x() + bar.get_width()/2., height,
                '%d' % int(height),
                ha='center', va='bottom', fontsize=9, color=front_color)  # è®¾ç½®æ•°å€¼æ ‡ç­¾å­—ä½“è‰²

    # åµŒå…¥å›¾è¡¨
    canvas = FigureCanvasTkAgg(fig, master=chart_frame)
    canvas.draw()
    canvas.get_tk_widget().pack(fill="both", expand=True)

    # ========== å³ä¾§åŒºåŸŸ ==========
    right_frame = ttk.Frame(main_frame)
    right_frame.grid(row=0, column=1, sticky="nsew", padx=10)

    # è¯¦ç»†æ•°æ®åŒº
    detail_frame = ttk.LabelFrame(right_frame, text="ä»»åŠ¡è¯¦æƒ…", style="Report.TLabelframe")
    detail_frame.pack(fill="both", expand=True)

    # å³å°†æˆªæ­¢ä»»åŠ¡åˆ—è¡¨
    c.execute("SELECT name, due_date, rest_days FROM tasks WHERE completed != 'âœ…' ORDER BY rest_days")
    urgent_tasks = c.fetchall()

    text_area = tk.Text(detail_frame, wrap=tk.WORD, font=("Microsoft YaHei", 10))
    text_area.pack(fill="both", expand=True, padx=10, pady=10)
    
    # æ·»åŠ å¸¦æ ¼å¼çš„å†…å®¹
    text_area.tag_configure("header", font=("Microsoft YaHei", 11, "bold"))
    text_area.tag_configure("deadline_today", foreground="#f6c23e")
    text_area.tag_configure("deadline_overdue", foreground="#f8312f")
    text_area.insert(tk.END, "ğŸ“Œ å¾…å®Œæˆä»»åŠ¡\n", "header")
    
    for task in urgent_tasks:
        if (task[2] > 0):
            text_area.insert(tk.END, 
                        f"  â€¢ {task[0]}\n"
                        f"     æˆªæ­¢æ—¥æœŸï¼š{task[1]} ï¼ˆå‰©ä½™{task[2]}å¤©ï¼‰\n\n")
        elif (task[2] == 0):
            text_area.insert(tk.END,
                        f"  â€¢ {task[0]}\n"
                        f"     æˆªæ­¢æ—¥æœŸï¼š{task[1]} ï¼ˆä»Šæ—¥æˆªæ­¢ï¼‰\n\n",
                        "deadline_today")
        else:
            text_area.insert(tk.END, 
                        f" â€¢ {task[0]}\n"
                        f"     æˆªæ­¢æ—¥æœŸï¼š{task[1]} ï¼ˆè¿‡æœŸ{task[2]*-1}å¤©ï¼‰\n\n",
                        "deadline_overdue")
    
    text_area.configure(state="disabled")

    # åœ¨å³ä¾§åŒºåŸŸæ·»åŠ ç•ªèŒ„é’Ÿç»Ÿè®¡
    pomodoro_frame = ttk.LabelFrame(right_frame, text="ä¸“æ³¨æ•°æ®", style="Report.TLabelframe")
    pomodoro_frame.pack(fill="both", expand=True, pady=10)
    
    c.execute("SELECT * FROM pomodoro_records")
    pomo_data = c.fetchone()
    conn.commit()

    # å¡ç‰‡å¼å¸ƒå±€
    pomo_grid = ttk.Frame(pomodoro_frame)
    pomo_grid.pack(padx=10, pady=10, fill='both', expand=True)
    
    metrics = [
        ("ğŸ… ä¸“æ³¨æ¬¡æ•°", pomo_data[0] or 0, "#1cc88a"),
        ("â³ æ€»æ—¶é•¿", f"{round(pomo_data[1], 2) or 0} åˆ†é’Ÿ", "#4e73df"),
        ("â±ï¸ å¹³å‡æ—¶é•¿", 
         f"{round(pomo_data[1]/pomo_data[0], 2)} åˆ†é’Ÿ" if pomo_data[1] > 0 else "0 åˆ†é’Ÿ", 
         "#f6c23e")
    ]
    
    for i, (title, value, color) in enumerate(metrics):
        card = ttk.Frame(pomo_grid, relief="groove", borderwidth=1)
        card.grid(row=0, column=i, padx=5, pady=5, sticky="nsew")
        
        ttk.Label(card, text=title, style="Report.TLabel").pack(pady=5)
        ttk.Label(card, text=str(value), 
                 font=("Microsoft YaHei", 14, "bold"), 
                 foreground=color).pack(pady=5)
    
    # å¸ƒå±€è°ƒæ•´
    for i in range(3):
        pomo_grid.columnconfigure(i, weight=1)

    # å¸ƒå±€æƒé‡é…ç½®
    main_frame.columnconfigure(0, weight=2)
    main_frame.columnconfigure(1, weight=2)
    main_frame.rowconfigure(0, weight=1)

    # çª—å£å…³é—­å¤„ç†
    def close_window():
        plt.close('all')
        progress_window.destroy()
    
    progress_window.protocol("WM_DELETE_WINDOW", close_window)

def open_about():
    about_window = tk.Toplevel(root)
    about_window.title("å…³äº")
    about_window.geometry("1000x860")
    about_window.resizable(False, False)
    
    # ä½¿ç”¨Frameå®¹å™¨
    content_frame = ttk.Frame(about_window)
    content_frame.pack(pady=20, padx=30, fill='both', expand=True)

    # æ ‡é¢˜éƒ¨åˆ†
    ttk.Label(content_frame, 
             text="å­¦ç¿¼ - TaskWing", 
             font=("Microsoft YaHei", 18, "bold"),
             foreground="#2c3e50",
             justify="center").pack(pady=10)

    # ç‰ˆæœ¬ä¿¡æ¯
    ttk.Label(content_frame,
             text=Version, 
             font=("Microsoft YaHei", 10),
             foreground="#7f8c8d").pack(pady=5)

    # åˆ†éš”çº¿
    ttk.Separator(content_frame).pack(fill='x', pady=10)

    # åŠŸèƒ½åˆ—è¡¨
    features = """
äº®ç‚¹åŠŸèƒ½ï¼š
âœ“ ä»»åŠ¡ç®¡ç†ä¸æé†’
âœ“ æ™ºèƒ½å­¦ä¹ è¿›åº¦è·Ÿè¸ª
âœ“ ç•ªèŒ„é’Ÿä¸“æ³¨è®¡æ—¶
âœ“ æ•°æ®å¯è§†åŒ–ç»Ÿè®¡
âœ“ æ¥å…¥Deepseek-V3&R1æ¨¡å‹ï¼ŒAIåœ¨çº¿ä¸“ä¸šè§£ç­”
âœ“ å¤šä¸»é¢˜ç•Œé¢é€‚é…
âœ“ å“åº”å¼çª—å£å¸ƒå±€
âœ“ ç³»ç»Ÿæ‰˜ç›˜å¸¸é©»è¿è¡Œ
âœ“ å¯è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
"""
    ttk.Label(content_frame, 
             text=features,
             font=("Microsoft YaHei", 11),
             justify="left").pack(pady=5, anchor='w')

    # å¼€å‘ä¿¡æ¯
    ttk.Label(content_frame,
             text="å¼€å‘è€…ï¼šTiantianYZJ\n"
                  "Emailï¼šyzjtiantian@126.com\n",
             font=("Microsoft YaHei", 10),
             justify="left",
             foreground="#34495e").pack(pady=10, anchor='w')

    # ç‰ˆæƒä¿¡æ¯
    ttk.Label(content_frame,
             text="éƒ¨åˆ†å›¾æ ‡æ¥æºäºé˜¿é‡Œå·´å·´çŸ¢é‡å›¾æ ‡åº“ Â· å¦‚æœ‰ä¾µæƒè¯·è”ç³»åˆ é™¤",
             font=("Microsoft YaHei", 9),
             foreground="#95a5a6",
             justify="center").pack(pady=10)
    
    # è®¸å¯è¯ä¿¡æ¯
    ttk.Label(content_frame,
             text="æœ¬åº”ç”¨éµå¾ª GNU General Public License v3.0 å¼€æºåè®®",
             font=("Microsoft YaHei", 9),
             foreground="#95a5a6",
             justify="center").pack(pady=0)
    
    # æ·»åŠ è¶…é“¾æ¥æç¤º
    link_label = ttk.Label(content_frame,
                           text="æŸ¥çœ‹GitHubé¡¹ç›®é¡µ",
                           font=("Microsoft YaHei", 9, "underline"),
                           foreground="#3498db",
                           cursor="hand2")
    link_label.pack(pady=3)
    link_label.bind("<Button-1>", lambda e: webbrowser.open_new("https://github.com/TiantianYZJ/TaskWing"))
    
    # ========== æ–°å¢æ›´æ–°æ—¥å¿—éƒ¨åˆ† ==========
    changelog_frame = ttk.LabelFrame(content_frame, text="æ›´æ–°æ—¥å¿—", padding=10)
    changelog_frame.pack(fill="both", expand=True, pady=10)
    
    # æ»šåŠ¨æ¡å®¹å™¨
    scroll_container = ttk.Frame(changelog_frame)
    scroll_container.pack(fill="both", expand=True)
    
    # æ»šåŠ¨æ¡
    scrollbar = ttk.Scrollbar(scroll_container)
    scrollbar.pack(side="right", fill="y")
    
    # æ–‡æœ¬æ¡†æ˜¾ç¤ºæ—¥å¿—
    changelog_text = tk.Text(
        scroll_container,
        wrap="word",
        yscrollcommand=scrollbar.set,
        font=("Microsoft YaHei", 10),
        height=8
    )
    changelog_text.pack(side="left", fill="both", expand=True)
    scrollbar.config(command=changelog_text.yview)
    
    # æ’å…¥æ—¥å¿—å†…å®¹
    for entry in reversed(CHANGELOG):
        changelog_text.insert("end", f"â€¢ {entry}\n")
    changelog_text.configure(state="disabled")

    # å…³é—­æŒ‰é’®
    ttk.Button(content_frame, 
              text="ç¡®å®š", 
              command=about_window.destroy,
              style='Accent.TButton').pack(pady=15)

# ============== è®¾ç½®ç•Œé¢ ==============
def open_settings():
    setting_window = tk.Toplevel(root)
    setting_window.title("è®¾ç½®")
    setting_window.geometry("500x400")
    setting_window.resizable(False, False)
    
    # ========== ä¸»é¢˜è®¾ç½® ==========
    theme_frame = ttk.LabelFrame(setting_window, text="ç•Œé¢è®¾ç½®", padding=10)
    theme_frame.pack(fill="x", padx=10, pady=5)
    
    c.execute("SELECT theme_choice FROM theme_settings")
    current_theme = c.fetchone()[0]
    
    theme_var = tk.StringVar(value=current_theme)
    ttk.Label(theme_frame, text="ä¸»é¢˜æ¨¡å¼:").grid(row=0, column=0, sticky="w")
    theme_combobox = ttk.Combobox(
        theme_frame,
        textvariable=theme_var,
        values=["æµ…è‰²æ¨¡å¼", "æ·±è‰²æ¨¡å¼", "è‡ªåŠ¨åˆ‡æ¢"],
        state="readonly",
        width=15
    )
    theme_combobox.grid(row=0, column=1, padx=5)

    # ========== è‡ªå¯åŠ¨è®¾ç½® ==========
    autostart_frame = ttk.LabelFrame(setting_window, text="å¼€æœºè‡ªå¯åŠ¨", padding=10)
    autostart_frame.pack(fill="x", padx=10, pady=10)

    def get_startup_folder():
        """è·å–ç³»ç»Ÿè‡ªå¯åŠ¨æ–‡ä»¶å¤¹è·¯å¾„"""
        startup_path = os.path.join(
            os.path.expanduser('~'),
            'AppData',
            'Roaming',
            'Microsoft',
            'Windows',
            'Start Menu',
            'Programs',
            'Startup'
        )
        return startup_path if os.path.exists(startup_path) else None

    def open_startup_folder():
        """æ‰“å¼€è‡ªå¯åŠ¨ç›®å½•"""
        startup_path = get_startup_folder()
        if startup_path:
            os.startfile(startup_path)
        else:
            messagebox.showerror("é”™è¯¯", "æ‰¾ä¸åˆ°è‡ªå¯åŠ¨ç›®å½•", parent=setting_window)
    
    def create_autostart_shortcut():
        if getattr(sys, 'frozen', False):
            target_path = sys.executable
        else:
            target_path = os.path.abspath(sys.argv[0])
        
        startup_folder = winshell.startup()
        shortcut_path = os.path.join(startup_folder, "å­¦ç¿¼.lnk")
        
        try:
            if os.path.exists(shortcut_path):
                if not messagebox.askyesno("ç¡®è®¤", "å·²å­˜åœ¨æ—§ç‰ˆæœ¬æˆ–å·²æ·»åŠ è¿‡çš„å¿«æ·æ–¹å¼ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ", parent=setting_window):
                    return
                
            winshell.CreateShortcut(
                Path=shortcut_path,
                Target=target_path,
                Icon=(target_path, 0),
                Description="å­¦ç¿¼"
            )
            messagebox.showinfo("æˆåŠŸ", "å¼€æœºè‡ªå¯åŠ¨é…ç½®æˆåŠŸï¼", parent=setting_window)
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"é…ç½®å¤±è´¥ï¼š{str(e)}", parent=setting_window)

    # åˆ é™¤
    def delete_autostart_shortcut():
        shortcut_path = os.path.join(winshell.startup(), "å­¦ç¿¼.lnk")
        
        try:
            if os.path.exists(shortcut_path):
                os.remove(shortcut_path)
                messagebox.showinfo("æˆåŠŸ", "å·²å–æ¶ˆå¼€æœºè‡ªå¯åŠ¨", parent=setting_window)
            else:
                messagebox.showinfo("æç¤º", "æ‚¨æ²¡æœ‰é…ç½®è¿‡å¼€æœºè‡ªå¯åŠ¨", parent=setting_window)
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å–æ¶ˆå¤±è´¥ï¼š{str(e)}", parent=setting_window)

    # æ“ä½œæŒ‰é’®
    ttk.Button(
        autostart_frame,
        text="âš¡ è‡ªåŠ¨é…ç½®",
        command=create_autostart_shortcut,
        width=13
    ).grid(row=0, column=1, padx=5, pady=5)
    Tooltip(autostart_frame.winfo_children()[0], "è®¾ç½®å¼€æœºè‡ªå¯åŠ¨")

    ttk.Button(
        autostart_frame,
        text="âŒ å–æ¶ˆé…ç½®",
        command=delete_autostart_shortcut,
        width=13
    ).grid(row=0, column=2, padx=5, pady=5)
    Tooltip(autostart_frame.winfo_children()[1], "å–æ¶ˆå¼€æœºè‡ªå¯åŠ¨")
    
    danger_frame = ttk.LabelFrame(setting_window, text="é«˜çº§æ“ä½œ", padding=10)
    danger_frame.pack(pady=10, fill='x', padx=10)
    
    def delete_all_data():
        # äºŒçº§ç¡®è®¤
        if not messagebox.askokcancel(
            "è­¦å‘Š", 
            "æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ä»¥ä¸‹æ‰€æœ‰æ•°æ®ï¼š\n"
            "â€¢ æ‰€æœ‰ä»»åŠ¡æ•°æ®\nâ€¢ ç´¯è®¡ä»»åŠ¡æ•°\nâ€¢ ä¿å­˜çš„ä¸»é¢˜è®¾ç½®\nâ€¢ ä¿å­˜çš„AIæ™ºç­”è®¾ç½®\nâ€¢ ç•ªèŒ„é’Ÿç»Ÿè®¡è®°å½•\n"
            "è¯·æ³¨æ„ï¼Œè¯¥æ“ä½œä¸å¯æ’¤é”€ï¼"
        ):
            return
            
        # ä¸‰çº§éªŒè¯
        verification_code = ''.join(random.choices('ABCDEFGHJKMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz123456789', k=6))
        user_input = simpledialog.askstring(
            "æœ€åç¡®è®¤", 
            f"è¯·è¾“å…¥ä¸‹æ–¹éªŒè¯ç ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ä»¥ç¡®è®¤åˆ é™¤\néªŒè¯ç ï¼š{verification_code}\n"
            "è¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®ä¸”æ— æ³•æ¢å¤ï¼Œè¯·ä¸‰æ€ï¼\n",
            parent=setting_window
        )
        
        if user_input == verification_code:
            # æ‰§è¡Œåˆ é™¤æ“ä½œ
            tables = ['tasks', 'task_counter', 'theme_settings', 'ai_settings', 'pomodoro_records']
            for table in tables:
                c.execute(f"DELETE FROM {table}")
            
            # é‡ç½®é»˜è®¤è®¾ç½®
            c.execute("INSERT INTO theme_settings VALUES (1, 'è‡ªåŠ¨åˆ‡æ¢')")
            c.execute("INSERT INTO task_counter (total_tasks) VALUES (0)")
            c.execute("INSERT INTO ai_settings (api_key, default_model, provider, display_mode) VALUES ('', 'deepseek-chat', 'ç¡…åŸºæµåŠ¨', 'window')")
            conn.commit()
            
            # æ›´æ–°ç•Œé¢
            update_task_list()
            theme_var.set('è‡ªåŠ¨åˆ‡æ¢')
            set_theme('è‡ªåŠ¨åˆ‡æ¢')
            messagebox.showinfo("å®Œæˆ", "æ‰€æœ‰æ•°æ®å·²æˆåŠŸåˆ é™¤", parent=setting_window)
        else:
            messagebox.showwarning("å–æ¶ˆ", "éªŒè¯ç ä¸åŒ¹é…ï¼Œåˆ é™¤æ“ä½œå·²å–æ¶ˆ", parent=setting_window)

    # æ‰“å¼€æ•°æ®åº“ç›®å½•æŒ‰é’®
    ttk.Button(
        danger_frame,
        text="ğŸ“‚ æŸ¥çœ‹æ•°æ®åº“ç›®å½•",
        command=lambda: os.startfile(user_data_dir)
    ).pack(side='left', pady=5, padx=5)
    Tooltip(danger_frame.winfo_children()[0], "æ‰“å¼€æ•°æ®åº“æ‰€åœ¨ç›®å½•ï¼ˆæ‰‹åŠ¨åˆ é™¤éœ€ç«‹å³é‡å¯ç¨‹åºï¼‰")

    
    ttk.Button(
        danger_frame,
        text="ğŸ“‚ æŸ¥çœ‹è‡ªå¯åŠ¨ç›®å½•",
        command=open_startup_folder,
    ).pack(side='left', pady=5, padx=5)
    Tooltip(danger_frame.winfo_children()[1], "æ‰“å¼€è‡ªå¯åŠ¨æ‰€åœ¨ç›®å½•")

    ttk.Button(
        danger_frame,
        text="âš ï¸ åˆ é™¤æ‰€æœ‰æ•°æ®",
        command=delete_all_data,
        style="Danger.TButton"
    ).pack(side='left', pady=5, padx=5)
    Tooltip(danger_frame.winfo_children()[2], "åˆ é™¤æ‚¨ä¿å­˜çš„æ‰€æœ‰æ•°æ®")

    # å®šä¹‰å±é™©æŒ‰é’®æ ·å¼
    style.configure("Danger.TButton", foreground="orange", background="#dc3545", font=("Microsoft YaHei", 10, "bold"))

    # ========== ä¿å­˜æŒ‰é’® ==========
    btn_frame = ttk.Frame(setting_window)
    btn_frame.pack(pady=10)

    def save_settings():
        set_theme(theme_var.get())
        setting_window.destroy()

    ttk.Button(btn_frame, text="ğŸ’¾ ä¿å­˜", command=save_settings, width=12).grid(row=0, column=0, padx=5)
    ttk.Button(btn_frame, text="â†©ï¸ å…³é—­", command=setting_window.destroy, width=12).grid(row=0, column=1, padx=5)

    setting_window.transient(root)
    setting_window.grab_set()
    
# ============== AIæ™ºç­”ç•Œé¢ ==============
def open_ai_assistant():
    ai_window = tk.Toplevel(root)
    ai_window.title("AIæ™ºç­”")
    ai_window.geometry("1000x700")
    
    # è·å–å½“å‰ä¸»é¢˜é¢œè‰²
    text_bg = judge_theme(1)
    text_fg = judge_theme(2)

    # é…ç½®æ ·å¼
    style = ttk.Style()
    style.configure("AIT.TFrame", background=text_bg)
    style.configure("Model.TButton", font=("Microsoft YaHei", 10), padding=5, width=18)
    
    main_frame = ttk.Frame(ai_window, padding=10)
    main_frame.pack(fill="both", expand=True)
    
    # å“åº”æ˜¾ç¤ºåŒºåŸŸ
    response_frame = ttk.Frame(main_frame)
    response_frame.pack(fill="both", expand=True, pady=5)
    
    response_scroll = tk.Scrollbar(response_frame)
    response_scroll.pack(side="right", fill="y")
    
    # ä½¿ç”¨ HTMLLabel æ›¿ä»£åŸæœ‰çš„ Text ç»„ä»¶
    html_label = HTMLLabel(response_frame, background=text_bg)
    html_label.pack(fill="both", expand=True)
    response_scroll.config(command=html_label.yview)

    # è¾“å…¥åŒºåŸŸ
    input_frame = ttk.Frame(main_frame)
    input_frame.pack(fill="x", pady=10)
    
    input_scroll = tk.Scrollbar(input_frame)
    input_scroll.pack(side="right", fill="y")
    
    input_text = tk.Text(
        input_frame, 
        height=6,
        wrap="word",
        font=("Microsoft YaHei", 12),
        yscrollcommand=input_scroll.set,
        bg=text_bg,
        fg=text_fg,
        insertbackground=text_fg
    )
    input_text.pack(fill="x", expand=True)
    input_scroll.config(command=input_text.yview)
    
    # åº•éƒ¨æ§åˆ¶æ 
    control_frame = ttk.Frame(main_frame)
    control_frame.pack(fill="x", pady=5)
    
    # æ¨¡å‹åˆ‡æ¢æŒ‰é’®ï¼ˆå›ºå®šå®½åº¦ï¼‰
    model_var = tk.StringVar(value="deepseek-chat")
    
    def toggle_model():
        current = model_var.get()
        new_model = "deepseek-r1" if current == "deepseek-chat" else "deepseek-chat"
        model_var.set(new_model)
        btn_text = "âœ… æ·±åº¦æ€è€ƒå·²å¼€å¯" if new_model == "deepseek-r1" else "âŒ æ·±åº¦æ€è€ƒå·²å…³é—­"
        model_btn.config(text=btn_text)  # ä¿æŒæŒ‰é’®æ–‡æœ¬é•¿åº¦ä¸€è‡´

    model_btn = ttk.Button(
        control_frame,
        text="âŒ æ·±åº¦æ€è€ƒå·²å…³é—­",
        command=toggle_model,
        style="Model.TButton",
        width=18
    )
    model_btn.pack(side="left", padx=5)
    
    # è®¾ç½®æŒ‰é’®
    ttk.Button(
        control_frame,
        text="âš™ è®¾ç½®",
        command=lambda: open_ai_settings(ai_window),
        width=10
    ).pack(side="left", padx=5)

    ttk.Label(control_frame, 
             text="""æœ¬æœåŠ¡ç”±Deepseekæä¾›æ”¯æŒ Â· ä¸æ”¯æŒè¿ç»­å¯¹è¯ Â· æœ¬åº”ç”¨ä¸å¯¹å›ç­”ç»“æœè´Ÿè´£
é»˜è®¤ä½¿ç”¨å…±äº«API Â· ç”±ä½œè€…è‡ªè´¹ Â· å¯åœ¨ã€è®¾ç½®ã€‘æ›´æ”¹
æœ‰å¤§é‡ä½¿ç”¨éœ€æ±‚çš„ç”¨æˆ·è¯·é…ç½®ç§æœ‰APIï¼Œè°¢è°¢ç†è§£ï¼""",
             font=("Microsoft YaHei", 9),
             foreground="#666666").pack(side="left", padx=5)
    
    def send_message():
        question = input_text.get("1.0", "end").strip()
        global users_question
        users_question = question
        c.execute("SELECT provider, api_key FROM ai_settings")
        provider, api_key = c.fetchone()
        
        if not question:
            messagebox.showwarning("æç¤º", "è¯·è¾“å…¥é—®é¢˜å†…å®¹", parent=ai_window)
            return
            
        # æ˜¾ç¤ºæç¤º
        html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;"><p>æ€è€ƒä¸­ï¼Œè¯·ç¨åï¼ˆæœªå“åº”å±æ­£å¸¸ç°è±¡ï¼‰</p></div>'
        html_label.set_html(html_text)
        ai_window.update()
        

        if provider == "Deepseek":
            try:
                client = OpenAI(
                    api_key=api_key, #  if api_key else "sk-6fa677012558401e88b54cde791f9822",  # æ›¿æ¢ä¸ºé»˜è®¤API
                    base_url="https://api.deepseek.com"
                )
                
                response = client.chat.completions.create(
                    model=model_var.get(),
                    messages=[{"role": "user", "content": question}],
                    stream=False
                )
                
                c.execute("SELECT display_mode FROM ai_settings")
                display_mode = c.fetchone()[0] or "window"

                # ç”ŸæˆMarkdownå†…å®¹
                markdown = mistune.create_markdown(plugins=['strikethrough', 'footnotes', 'table', 'url', 'task_lists', 'def_list', 'abbr', 'math'])
                html_content = markdown(response.choices[0].message.content)
                
                # æ ¹æ®æ¨¡å¼å¤„ç†æ˜¾ç¤º
                if display_mode == "window":
                    # åŸæœ‰çª—å£æ˜¾ç¤ºé€»è¾‘
                    html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;">{html_content}</div>'
                    html_label.set_html(html_text)
                else:
                    global current_response_html
                    current_response_html = f"""
                    <div class="markdown-body">
                    {html_content}
                    </div>
                    """

                    webbrowser.open("http://localhost:5000/ai-response")

                    # æ˜¾ç¤ºæç¤º
                    html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;"><p>å›å¤å·²åœ¨æµè§ˆå™¨æ˜¾ç¤º</p></div>'
                    html_label.set_html(html_text)
                    ai_window.update()
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"è¯·æ±‚å¤±è´¥ï¼š{str(e)}", parent=ai_window)
            finally:
                input_text.delete("1.0", "end")
        elif provider == "ç¡…åŸºæµåŠ¨":
            api_key=api_key if api_key else "sk-dgxkvpdrkaxvnzhflxeiagetenlhvxsydybqncqwqurejvvf"  # æ›¿æ¢ä¸ºé»˜è®¤API
            url = "https://api.siliconflow.cn/v1/chat/completions"
            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type":"application/json"
            }
            payload = {
                "model": "deepseek-ai/DeepSeek-V3" if model_var.get() == "deepseek-chat" 
                        else "deepseek-ai/DeepSeek-R1",
                "messages": [{"role": "user", "content": question}],
            }
            try:
                response = requests.post(url, headers=headers, json=payload)
                if response.status_code == 200:
                    c.execute("SELECT display_mode FROM ai_settings")
                    display_mode = c.fetchone()[0] or "window"

                    # ç”ŸæˆMarkdownå†…å®¹
                    markdown = mistune.create_markdown(plugins=['strikethrough', 'footnotes', 'table', 'url', 'task_lists', 'def_list', 'abbr', 'math'])
                    html_content = markdown(response.json()['choices'][0]['message']['content'])
                    
                    # æ ¹æ®æ¨¡å¼å¤„ç†æ˜¾ç¤º
                    if display_mode == "window":
                        # åŸæœ‰çª—å£æ˜¾ç¤ºé€»è¾‘
                        html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;">{html_content}</div>'
                        html_label.set_html(html_text)
                    else:
                        current_response_html = f"""
                        <div class="markdown-body">
                        {html_content}
                        </div>
                        """

                        webbrowser.open("http://localhost:5000/ai-response")

                        # æ˜¾ç¤ºæç¤º
                        html_text = f'<div style="background-color: {judge_theme(1)}; color: {judge_theme(2)}; font-family: Microsoft YaHei;"><p>å›å¤å·²åœ¨æµè§ˆå™¨æ˜¾ç¤º</p></div>'
                        html_label.set_html(html_text)
                        ai_window.update()
                else:
                    messagebox.showerror("é”™è¯¯", f"è¯·æ±‚å¤±è´¥ï¼š{response.text}", parent=ai_window)
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"è¯·æ±‚å¼‚å¸¸ï¼š{str(e)}", parent=ai_window)

    ttk.Button(
        control_frame,
        text="â¬†ï¸ å‘é€",
        command=send_message,
        style="Accent.TButton"
    ).pack(side="right", padx=5)
    
    ai_window.transient(root)
    ai_window.grab_set()

# ============== AIè®¾ç½®çª—å£ ==============
def open_ai_settings(parent):
    settings_window = tk.Toplevel(parent)
    settings_window.title("AIæ™ºç­”è®¾ç½®")
    settings_window.geometry("900x550")
    
    # ä¸»å®¹å™¨ä½¿ç”¨packå¸ƒå±€
    main_frame = ttk.Frame(settings_window, padding=20)
    main_frame.pack(fill="both", expand=True)
    
    # APIè®¾ç½®æ¡†æ¶
    api_frame = ttk.LabelFrame(main_frame, text="APIè®¾ç½®", padding=15)
    api_frame.pack(fill="x", pady=10)

    # æœåŠ¡å•†é€‰æ‹©æ¡†æ¶
    provider_frame = ttk.LabelFrame(api_frame, text="æœåŠ¡æä¾›å•†", padding=10)
    provider_frame.pack(fill="x", pady=5)
    
    # è·å–å½“å‰è®¾ç½®
    c.execute("SELECT api_key, provider FROM ai_settings")
    api_key, current_provider = c.fetchone()
    
    # æœåŠ¡å•†é€‰æ‹©æ§ä»¶
    provider_var = tk.StringVar(value=current_provider)
    ttk.Label(provider_frame, text="é€‰æ‹©æœåŠ¡å•†:").pack(side="left", padx=5)
    provider_combobox = ttk.Combobox(
        provider_frame,
        textvariable=provider_var,
        values=["Deepseek", "ç¡…åŸºæµåŠ¨"],
        state="readonly",
        width=15
    )
    provider_combobox.pack(side="left", padx=5)
    
    # API Keyè¾“å…¥
    ttk.Label(api_frame, text="API Key:").pack(anchor="w")
    api_entry = ttk.Entry(api_frame)
    api_entry.insert(0, api_key)
    api_entry.pack(fill="x", pady=5, padx=5)
    
    ttk.Label(api_frame, 
             text="å› è¿‘æœŸDeepseekå®˜æ–¹APIå…³é—­å……å€¼å…¥å£ï¼Œã€AIæ™ºç­”ã€‘æš‚åœæä¾›Deepseekæ¸ é“çš„å…±äº«APIï¼Œå•ç‹¬é…ç½®è¯¥æ¸ é“ç§æœ‰APIæˆ–ä½¿ç”¨ç¡…åŸºæµåŠ¨å…±äº«APIä¸å—å½±å“\nç•™ç©ºå°†ä½¿ç”¨ä½œè€…è‡ªè´¹çš„å…±äº«API\næ¨èé…ç½®ç§æœ‰APIï¼Œè°¢è°¢ç†è§£ï¼",
             font=("Microsoft YaHei", 9),
             foreground="#666666").pack(anchor="w")
    
    # ========== æ–°å¢é…ç½®æ•™ç¨‹æŒ‰é’®å’Œå†…å®¹ ==========
    def show_api_tutorial():
        webbrowser.open("http://localhost:5000/tutorial")
    
    ttk.Button(
        api_frame,
        text="ğŸ“˜ ç§æœ‰APIé…ç½®æ•™ç¨‹",
        command=show_api_tutorial,
        width=20
    ).pack(pady=10)

    # ========== æ–°å¢å›ç­”è®¾ç½®éƒ¨åˆ† ==========
    display_frame = ttk.LabelFrame(main_frame, text="å›ç­”è®¾ç½®", padding=15)
    display_frame.pack(fill="x", pady=10)

    # è·å–å½“å‰æ˜¾ç¤ºæ¨¡å¼
    c.execute("SELECT display_mode FROM ai_settings")
    current_mode = c.fetchone()[0] or "window"

    # æ˜¾ç¤ºæ–¹å¼ä¸‹æ‹‰æ¡†
    ttk.Label(display_frame, text="AIå›ç­”æ˜¾ç¤ºæ–¹å¼:").pack(side="left", padx=5)
    mode_var = tk.StringVar(value=current_mode)
    mode_combobox = ttk.Combobox(
        display_frame,
        textvariable=mode_var,
        values=["window", "browser"],
        state="readonly",
        width=20
    )
    mode_combobox.pack(side="left", padx=5)
    
    # è®¾ç½®ä¸‹æ‹‰æ¡†æ˜¾ç¤ºæ–‡æœ¬
    mode_combobox.set("åœ¨åŸçª—å£æ˜¾ç¤º" if current_mode == "window" else "åœ¨æµè§ˆå™¨æ˜¾ç¤º")
    mode_combobox.configure(
        values=["åœ¨åŸçª—å£æ˜¾ç¤º", "åœ¨æµè§ˆå™¨æ˜¾ç¤º"],
        validate="key",
        validatecommand=lambda: False
    )

    ttk.Label(display_frame, 
             text="åœ¨åŸçª—å£æ˜¾ç¤ºï¼šæ–¹ä¾¿å¿«æ·ã€‚ä½†ä»…æ”¯æŒIE4å†…æ ¸ï¼Œå› æ­¤æ— æ³•æ¸²æŸ“éƒ¨åˆ†Markdownè¯­æ³•ï¼ˆè¡¨æ ¼ã€ä»£ç å—ç­‰ï¼‰\nåœ¨æµè§ˆå™¨æ˜¾ç¤ºï¼šå°†è°ƒç”¨ç³»ç»Ÿæµè§ˆå™¨ã€‚ä½†å¯æ¸²æŸ“æ‰€æœ‰Markdownè¯­æ³•ï¼Œæ›´åŠ ç°ä»£åŒ–ï¼Œå¯ä¸€é”®å¤åˆ¶ï¼ˆæ¨èï¼‰",
             font=("Microsoft YaHei", 9),
             foreground="#666666").pack(anchor="w")
    
    save_btn = ttk.Button(
        main_frame,
        text="ğŸ’¾ ä¿å­˜è®¾ç½®",
        command=lambda: save_settings(api_entry.get(), provider_var.get()),
        style="Accent.TButton"
    )
    save_btn.pack(pady=15)
    
    def save_settings(key, provider):
        display_mode = "window" if mode_var.get() == "åœ¨åŸçª—å£æ˜¾ç¤º" else "browser"
        c.execute("UPDATE ai_settings SET api_key=?, provider=?, display_mode=?", 
                (key, provider, display_mode))
        conn.commit()
        settings_window.destroy()
    
    settings_window.transient(parent)
    settings_window.grab_set()

# ============== ä¸»çª—å£å¸ƒå±€ ==============
root.grid_rowconfigure(1, weight=1)
root.grid_columnconfigure(0, weight=1)

# é¡¶éƒ¨åŠŸèƒ½åŒº
top_frame = ttk.Frame(root)
top_frame.grid_rowconfigure(0, weight=1)
top_frame.grid_columnconfigure(0, weight=1)
top_frame.grid(row=0, column=0, sticky="nsew")

# ntVarå¯¹è±¡ï¼Œç”¨äºè¿½è¸ªCheckbuttonçš„çŠ¶æ€
topmost_var = tk.IntVar(value=0)
# Checkbuttonæ§ä»¶ï¼Œç”¨äºåˆ‡æ¢çª—å£ç½®é¡¶çŠ¶æ€
toggle_button = ttk.Checkbutton(top_frame, text="çª—å£ç½®é¡¶", variable=topmost_var, onvalue=1, offvalue=0, command=toggle_topmost)
toggle_button.grid(row=0, column=1, sticky="ne")

# ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ
task_frame = ttk.Frame(root)
task_frame.grid_rowconfigure(0, weight=1)
task_frame.grid_columnconfigure(0, weight=1)
task_frame.grid(row=1, column=0, sticky="nsew", padx=20)

style = ttk.Style(task_frame)
style.configure("Treeview.Heading", font=('Microsoft YaHei', 14))
style.configure("Treeview", font=('Microsoft YaHei', 12))
task_list = ttk.Treeview(task_frame, columns=("ID", "ä»»åŠ¡åç§°", "æˆªæ­¢æ—¥æœŸ", "å‰©ä½™å¤©æ•°", "çŠ¶æ€"), show="headings")
task_list.grid_rowconfigure(0, weight=1)
task_list.grid_columnconfigure(0, weight=1)
task_list.grid(row=0, column=0, sticky="nsew")
task_list.column("ID", width=30, anchor='center')
task_list.heading("ID", text="ID")
task_list.column("ä»»åŠ¡åç§°", width=600, anchor='w')
task_list.heading("ä»»åŠ¡åç§°", text="ä»»åŠ¡åç§°")
task_list.column("æˆªæ­¢æ—¥æœŸ", width=100, anchor='center')
task_list.heading("æˆªæ­¢æ—¥æœŸ", text="æˆªæ­¢æ—¥æœŸ")
task_list.column("å‰©ä½™å¤©æ•°", width=80, anchor='center')
task_list.heading("å‰©ä½™å¤©æ•°", text="å‰©ä½™å¤©æ•°")
task_list.column("çŠ¶æ€", width=50, anchor='center')
task_list.heading("çŠ¶æ€", text="çŠ¶æ€")

# æ“ä½œæŒ‰é’®ç»„
edit_button = ttk.Frame(task_frame)
edit_button.grid(row=1, column=0, pady=10, sticky="nsew")

ttk.Button(edit_button, text="ğŸ“ ä¿®æ”¹", command=edit_task, width=10).grid(row=0, column=0, padx=3)
Tooltip(edit_button.winfo_children()[0], "ä¿®æ”¹é€‰å®šä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯")
ttk.Button(edit_button, text="ğŸ—‘ï¸ åˆ é™¤", command=delete_task, width=10).grid(row=0, column=1, padx=3)
Tooltip(edit_button.winfo_children()[1], "æ°¸ä¹…ç§»é™¤é€‰å®šçš„ä»»åŠ¡")
ttk.Button(edit_button, text="ğŸ§¹ æ¸…ç©º", command=confirm_clear_tasks, width=10).grid(row=0, column=2, padx=3)
Tooltip(edit_button.winfo_children()[2], "æ¸…ç©ºå½“å‰ä»»åŠ¡åˆ—è¡¨")
ttk.Button(edit_button, text="ğŸ… ç•ªèŒ„é’Ÿ", command=pomodoro_set_tasks, width=10).grid(row=0, column=3, padx=3)
Tooltip(edit_button.winfo_children()[3], "å¯åŠ¨ç•ªèŒ„é’Ÿä¸“æ³¨è®¡æ—¶å™¨")

# åº•éƒ¨åŠŸèƒ½åŒº
bottom_frame = ttk.Frame(root, padding=10)
bottom_frame.grid(row=2, column=0, sticky="nsew")
style.configure("Large.TLabelframe.Label", font=('Microsoft YaHei', 12, 'bold'))

# æ·»åŠ ä»»åŠ¡æ¨¡å—
add_task_frame = ttk.LabelFrame(bottom_frame, text="æ–°å»ºä»»åŠ¡", style="Large.TLabelframe", padding=10)
add_task_frame.pack(side="left", padx=10, fill="x", expand=True)

name_frame = ttk.Frame(add_task_frame)
name_frame.grid(row=0, column=0, sticky="w", pady=10)
ttk.Label(name_frame, text="ä»»åŠ¡åç§°:").grid(row=0, column=0, sticky="w")
name_entry = ttk.Entry(name_frame, width=40)
name_entry.grid(row=0, column=1, padx=5)
name_entry.bind("<Return>", lambda e: add_task())

# åˆ›å»ºä¸€ä¸ªæ–°çš„ Frame æ¥æ”¾ç½®æ—¥æœŸé€‰æ‹©çš„ Combobox
date_frame = ttk.Frame(add_task_frame)
date_frame.grid(row=1, column=0, sticky="w", pady=10)

ttk.Label(date_frame, text="æˆªæ­¢æ—¥æœŸ:").grid(row=0, column=0, sticky="w")
date_entry = ttk.Entry(date_frame, width=12, font=('Microsoft YaHei', 9))
date_entry.insert(0, datetime.now().strftime("%Y/%m/%d"))  # é»˜è®¤å½“å‰æ—¥æœŸ
date_entry.grid(row=0, column=1, padx=5)

def set_add_date():
    def on_date_select():
        date_entry.delete(0, tk.END)
        date_entry.insert(0, cal.get_date())
        top.grab_release()
        top.destroy()
    
    top = tk.Toplevel(root)
    top.title("é€‰æ‹©æ—¥æœŸ")
    cal = Calendar(top, 
                 selectmode='day',
                 year=datetime.now().year,
                 month=datetime.now().month,
                 day=datetime.now().day,
                 date_pattern='y/mm/dd')
    cal.pack(padx=10, pady=10)
    ttk.Button(top, text="ç¡®å®š", command=on_date_select).pack(pady=5)

ttk.Button(date_frame, text="ğŸ“… é€‰æ‹©", command=set_add_date).grid(row=0, column=2, padx=5)
ttk.Button(date_frame, text="â• ç¡®è®¤æ·»åŠ ", command=add_task, width=12).grid(row=0, column=3, padx=5)

# å³ä¾§åŠŸèƒ½æŒ‰é’®
func_btn_frame = ttk.Frame(bottom_frame)
func_btn_frame.pack(side="right", padx=10)

ttk.Button(func_btn_frame, text="ğŸ¤– AIæ™ºç­”", command=open_ai_assistant, width=12).grid(row=0, column=0, pady=2)
Tooltip(func_btn_frame.winfo_children()[0], "ä½¿ç”¨AIæ™ºèƒ½å›ç­”é—®é¢˜")
ttk.Button(func_btn_frame, text="ğŸ“ˆ ç»Ÿè®¡æŠ¥å‘Š", command=show_progress_report, width=12).grid(row=1, column=0, pady=2)
Tooltip(func_btn_frame.winfo_children()[1], "æŸ¥çœ‹å­¦ä¹ æ•°æ®å¯è§†åŒ–æŠ¥å‘Š")
ttk.Button(func_btn_frame, text="âš™ï¸ è®¾ç½®", command=open_settings, width=12).grid(row=2, column=0, pady=2)
Tooltip(func_btn_frame.winfo_children()[2], "ä¿®æ”¹åº”ç”¨è®¾ç½®")
ttk.Button(func_btn_frame, text="â„¹ï¸ å…³äºåº”ç”¨", command=open_about, width=12).grid(row=3, column=0, pady=2)
Tooltip(func_btn_frame.winfo_children()[3], "æŸ¥çœ‹åº”ç”¨ä¿¡æ¯")

# åˆ›å»ºæ‰˜ç›˜
def on_closing(icon, item):
    icon.stop()
    if (get_num(1) == 0):
        sent_notice("å­¦ç¿¼å·²é€€å‡º", f"ä½ æ²¡æœ‰ä»»ä½•ä»»åŠ¡å“¦")
    else:
        if (get_num(3) > 0):
            sent_notice("å­¦ç¿¼å·²é€€å‡º", f"è®°å¾—å®Œæˆå‰©ä¸‹çš„{get_num(3)}ä¸ªä»»åŠ¡")
        elif (get_num(3) == 0):
            sent_notice("å­¦ç¿¼å·²é€€å‡º", f"å‰å®³ï¼ä½ å®Œæˆäº†æ‰€æœ‰å…±è®¡{get_num(1)}ä¸ªä»»åŠ¡ï¼")
    root.destroy()
    return 0

def on_show():
    root.withdraw()
    icon = create_tray_icon()
    sent_notice("å·²æœ€å°åŒ–åˆ°ä»»åŠ¡æ æ‰˜ç›˜", "å³é”®æ‰˜ç›˜å›¾æ ‡å¹¶é€‰æ‹©ã€æ˜¾ç¤ºã€‘å¯æ¢å¤")
    icon.run()
    return 0

root.protocol("WM_DELETE_WINDOW", on_show)
def on_showing(icon, item):
    icon.stop()
    root.deiconify()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

def open_ai_assistant_window(icon, item):
    icon.stop()
    root.deiconify()
    open_ai_assistant()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

def open_settings_window(icon, item):
    icon.stop()
    root.deiconify()
    open_settings()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

def open_about_window(icon, item):
    icon.stop()
    root.deiconify()
    open_about()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

def open_progress_window(icon, item):
    icon.stop()
    root.deiconify()
    show_progress_report()
    sent_notice("ä»»åŠ¡æ æ‰˜ç›˜å·²éšè—", "å…³é—­æ‰€æœ‰çª—å£å°†å†æ¬¡å‡ºç°")
    return 0

# æ›´æ–°ä»»åŠ¡åˆ—è¡¨
update_task_list()

# æ›´æ–°æ—¶é—´
update_time()

# æ›´æ–°å‰©ä½™å¤©æ•°
update_rest_days()

# è¿è¡Œä¸»å¾ªç¯
root.mainloop()

# å…³é—­æ•°æ®åº“è¿æ¥
conn.close()